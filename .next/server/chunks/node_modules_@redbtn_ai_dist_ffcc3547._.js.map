{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///home/alpha/code/%40redbtn/webapp/node_modules/%40redbtn/ai/dist/lib/utils/tokenizer.js"],"sourcesContent":["\"use strict\";\n/**\n * @file src/lib/tokenizer.ts\n * @description Token counting with fallback for environments where tiktoken doesn't work\n */\nvar __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {\n    if (k2 === undefined) k2 = k;\n    var desc = Object.getOwnPropertyDescriptor(m, k);\n    if (!desc || (\"get\" in desc ? !m.__esModule : desc.writable || desc.configurable)) {\n      desc = { enumerable: true, get: function() { return m[k]; } };\n    }\n    Object.defineProperty(o, k2, desc);\n}) : (function(o, m, k, k2) {\n    if (k2 === undefined) k2 = k;\n    o[k2] = m[k];\n}));\nvar __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {\n    Object.defineProperty(o, \"default\", { enumerable: true, value: v });\n}) : function(o, v) {\n    o[\"default\"] = v;\n});\nvar __importStar = (this && this.__importStar) || (function () {\n    var ownKeys = function(o) {\n        ownKeys = Object.getOwnPropertyNames || function (o) {\n            var ar = [];\n            for (var k in o) if (Object.prototype.hasOwnProperty.call(o, k)) ar[ar.length] = k;\n            return ar;\n        };\n        return ownKeys(o);\n    };\n    return function (mod) {\n        if (mod && mod.__esModule) return mod;\n        var result = {};\n        if (mod != null) for (var k = ownKeys(mod), i = 0; i < k.length; i++) if (k[i] !== \"default\") __createBinding(result, mod, k[i]);\n        __setModuleDefault(result, mod);\n        return result;\n    };\n})();\nvar __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {\n    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }\n    return new (P || (P = Promise))(function (resolve, reject) {\n        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }\n        function rejected(value) { try { step(generator[\"throw\"](value)); } catch (e) { reject(e); } }\n        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }\n        step((generator = generator.apply(thisArg, _arguments || [])).next());\n    });\n};\nObject.defineProperty(exports, \"__esModule\", { value: true });\nexports.countTokens = countTokens;\nexports.freeTiktoken = freeTiktoken;\nexports.isTiktokenAvailable = isTiktokenAvailable;\nlet tiktokenEncoder = null;\nlet tiktokenAvailable = false;\nlet initAttempted = false;\n/**\n * Initialize tiktoken encoder lazily\n */\nfunction initTiktoken() {\n    return __awaiter(this, void 0, void 0, function* () {\n        if (tiktokenEncoder !== null) {\n            return tiktokenEncoder;\n        }\n        // Only attempt initialization once\n        if (initAttempted) {\n            return null;\n        }\n        initAttempted = true;\n        try {\n            // Try to load tiktoken\n            const { encoding_for_model } = yield Promise.resolve().then(() => __importStar(require('tiktoken')));\n            tiktokenEncoder = encoding_for_model('gpt-4');\n            tiktokenAvailable = true;\n            console.log('[Tokenizer] tiktoken loaded successfully');\n            return tiktokenEncoder;\n        }\n        catch (error) {\n            const errorMessage = error instanceof Error ? error.message : 'Unknown error';\n            console.warn('[Tokenizer] tiktoken not available, using fallback token estimation (1 token ≈ 4 chars)');\n            tiktokenAvailable = false;\n            return null;\n        }\n    });\n}\n/**\n * Count tokens using tiktoken or fallback estimation\n */\nfunction countTokens(text) {\n    return __awaiter(this, void 0, void 0, function* () {\n        try {\n            const encoder = yield initTiktoken();\n            if (encoder && tiktokenAvailable) {\n                return encoder.encode(text).length;\n            }\n        }\n        catch (error) {\n            console.warn('[Tokenizer] Error using tiktoken, falling back to estimation');\n        }\n        // Fallback: rough estimate (1 token ≈ 4 characters)\n        return Math.ceil(text.length / 4);\n    });\n}\n/**\n * Free tiktoken encoder resources\n */\nfunction freeTiktoken() {\n    if (tiktokenEncoder && tiktokenAvailable) {\n        try {\n            tiktokenEncoder.free();\n        }\n        catch (error) {\n            // Ignore errors during cleanup\n        }\n    }\n    tiktokenEncoder = null;\n    tiktokenAvailable = false;\n}\n/**\n * Check if tiktoken is available\n */\nfunction isTiktokenAvailable() {\n    return tiktokenAvailable;\n}\n"],"names":[],"mappings":"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","ignoreList":[0],"debugId":null}},
    {"offset": {"line": 151, "column": 0}, "map": {"version":3,"sources":["file:///home/alpha/code/%40redbtn/webapp/node_modules/%40redbtn/ai/dist/lib/memory/database.js"],"sourcesContent":["\"use strict\";\nvar __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {\n    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }\n    return new (P || (P = Promise))(function (resolve, reject) {\n        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }\n        function rejected(value) { try { step(generator[\"throw\"](value)); } catch (e) { reject(e); } }\n        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }\n        step((generator = generator.apply(thisArg, _arguments || [])).next());\n    });\n};\nObject.defineProperty(exports, \"__esModule\", { value: true });\nexports.DatabaseManager = void 0;\nexports.getDatabase = getDatabase;\nexports.resetDatabase = resetDatabase;\nconst mongodb_1 = require(\"mongodb\");\n// ============================================================================\n// DATABASE MANAGER CLASS\n// ============================================================================\n/**\n * Universal database manager for MongoDB operations\n * Supports messages, conversations, logs, generations, and generic collections\n */\nclass DatabaseManager {\n    constructor(mongoUrl = 'mongodb://localhost:27017', dbName = 'redbtn_ai') {\n        this.mongoUrl = mongoUrl;\n        this.dbName = dbName;\n        this.client = null;\n        this.db = null;\n        this.collections = new Map();\n        this.connectionPromise = null;\n        // Pre-defined collection names\n        this.COLLECTIONS = {\n            MESSAGES: 'messages',\n            CONVERSATIONS: 'conversations',\n            LOGS: 'logs',\n            GENERATIONS: 'generations',\n            THOUGHTS: 'thoughts',\n        };\n    }\n    // ==========================================================================\n    // CONNECTION MANAGEMENT\n    // ==========================================================================\n    // ==========================================================================\n    // CONNECTION MANAGEMENT\n    // ==========================================================================\n    /**\n     * Connect to MongoDB and initialize collections\n     */\n    connect() {\n        return __awaiter(this, void 0, void 0, function* () {\n            if (this.connectionPromise) {\n                return this.connectionPromise;\n            }\n            this.connectionPromise = (() => __awaiter(this, void 0, void 0, function* () {\n                try {\n                    console.log('[Database] Connecting to MongoDB...');\n                    // Connection options\n                    const options = {\n                        authMechanism: undefined,\n                        authSource: 'admin',\n                    };\n                    // If URL contains username/password, set auth source\n                    if (this.mongoUrl.includes('@')) {\n                        options.authSource = 'admin';\n                    }\n                    this.client = new mongodb_1.MongoClient(this.mongoUrl, {\n                        serverSelectionTimeoutMS: 5000,\n                        connectTimeoutMS: 10000,\n                    });\n                    yield this.client.connect();\n                    // Test the connection\n                    yield this.client.db('admin').admin().ping();\n                    this.db = this.client.db(this.dbName);\n                    // Initialize core collections\n                    yield this.initializeCollections();\n                    console.log('[Database] Connected to MongoDB successfully');\n                }\n                catch (error) {\n                    console.error('[Database] Failed to connect to MongoDB:', error);\n                    console.error('[Database] Make sure MongoDB is running and authentication is configured correctly');\n                    console.error('[Database] Current connection string:', this.mongoUrl.replace(/\\/\\/([^:]+):([^@]+)@/, '//$1:****@'));\n                    this.connectionPromise = null;\n                    throw error;\n                }\n            }))();\n            return this.connectionPromise;\n        });\n    }\n    /**\n     * Initialize collections with indexes\n     */\n    initializeCollections() {\n        return __awaiter(this, void 0, void 0, function* () {\n            if (!this.db)\n                throw new Error('Database not connected');\n            // Messages collection\n            const messages = this.db.collection(this.COLLECTIONS.MESSAGES);\n            yield messages.createIndex({ conversationId: 1, timestamp: 1 });\n            yield messages.createIndex({ timestamp: -1 });\n            this.collections.set(this.COLLECTIONS.MESSAGES, messages);\n            // Conversations collection\n            const conversations = this.db.collection(this.COLLECTIONS.CONVERSATIONS);\n            yield conversations.createIndex({ conversationId: 1 }, { unique: true });\n            yield conversations.createIndex({ updatedAt: -1 });\n            yield conversations.createIndex({ userId: 1 });\n            this.collections.set(this.COLLECTIONS.CONVERSATIONS, conversations);\n            // Logs collection with 6-month TTL\n            const logs = this.db.collection(this.COLLECTIONS.LOGS);\n            yield logs.createIndex({ timestamp: -1 });\n            yield logs.createIndex({ generationId: 1 });\n            yield logs.createIndex({ conversationId: 1 });\n            yield logs.createIndex({ level: 1 });\n            yield logs.createIndex({ category: 1 });\n            yield logs.createIndex({ logId: 1 }, { unique: true });\n            // TTL index: automatically delete logs after 6 months (15552000 seconds)\n            yield logs.createIndex({ timestamp: 1 }, { expireAfterSeconds: 15552000 });\n            this.collections.set(this.COLLECTIONS.LOGS, logs);\n            // Generations collection\n            const generations = this.db.collection(this.COLLECTIONS.GENERATIONS);\n            yield generations.createIndex({ generationId: 1 }, { unique: true });\n            yield generations.createIndex({ conversationId: 1 });\n            yield generations.createIndex({ status: 1 });\n            yield generations.createIndex({ startTime: -1 });\n            yield generations.createIndex({ nodeId: 1 });\n            this.collections.set(this.COLLECTIONS.GENERATIONS, generations);\n            // Thoughts collection (stores thinking/reasoning separately from messages)\n            const thoughts = this.db.collection(this.COLLECTIONS.THOUGHTS);\n            yield thoughts.createIndex({ thoughtId: 1 }, { unique: true });\n            yield thoughts.createIndex({ conversationId: 1 });\n            yield thoughts.createIndex({ messageId: 1 });\n            yield thoughts.createIndex({ generationId: 1 });\n            yield thoughts.createIndex({ timestamp: -1 });\n            yield thoughts.createIndex({ source: 1 });\n            this.collections.set(this.COLLECTIONS.THOUGHTS, thoughts);\n        });\n    }\n    /**\n     * Ensure connection is established\n     */\n    ensureConnected() {\n        return __awaiter(this, void 0, void 0, function* () {\n            if (!this.db || this.collections.size === 0) {\n                yield this.connect();\n            }\n        });\n    }\n    /**\n     * Get a collection by name (with type safety)\n     */\n    getCollection(name) {\n        const collection = this.collections.get(name);\n        if (!collection) {\n            throw new Error(`Collection ${name} not initialized`);\n        }\n        return collection;\n    }\n    /**\n     * Get or create a custom collection\n     */\n    collection(name) {\n        return __awaiter(this, void 0, void 0, function* () {\n            yield this.ensureConnected();\n            if (!this.collections.has(name)) {\n                const col = this.db.collection(name);\n                this.collections.set(name, col);\n            }\n            return this.getCollection(name);\n        });\n    }\n    // ==========================================================================\n    // GENERIC CRUD OPERATIONS\n    // ==========================================================================\n    /**\n     * Insert a single document into any collection\n     */\n    insertOne(collectionName, document) {\n        return __awaiter(this, void 0, void 0, function* () {\n            yield this.ensureConnected();\n            const col = yield this.collection(collectionName);\n            const doc = Object.assign(Object.assign({}, document), { createdAt: document.createdAt || new Date(), updatedAt: document.updatedAt || new Date() });\n            const result = yield col.insertOne(doc);\n            return result.insertedId;\n        });\n    }\n    /**\n     * Insert multiple documents into any collection\n     */\n    insertMany(collectionName, documents) {\n        return __awaiter(this, void 0, void 0, function* () {\n            if (documents.length === 0)\n                return [];\n            yield this.ensureConnected();\n            const col = yield this.collection(collectionName);\n            const docs = documents.map(doc => (Object.assign(Object.assign({}, doc), { createdAt: doc.createdAt || new Date(), updatedAt: doc.updatedAt || new Date() })));\n            const result = yield col.insertMany(docs);\n            return Object.values(result.insertedIds);\n        });\n    }\n    /**\n     * Find documents in any collection\n     */\n    find(collectionName_1) {\n        return __awaiter(this, arguments, void 0, function* (collectionName, filter = {}, options) {\n            yield this.ensureConnected();\n            const col = yield this.collection(collectionName);\n            return (yield col.find(filter, options).toArray());\n        });\n    }\n    /**\n     * Find a single document in any collection\n     */\n    findOne(collectionName, filter) {\n        return __awaiter(this, void 0, void 0, function* () {\n            yield this.ensureConnected();\n            const col = yield this.collection(collectionName);\n            return (yield col.findOne(filter));\n        });\n    }\n    /**\n     * Update documents in any collection\n     */\n    updateMany(collectionName, filter, update) {\n        return __awaiter(this, void 0, void 0, function* () {\n            yield this.ensureConnected();\n            const col = yield this.collection(collectionName);\n            // Add updatedAt timestamp\n            const updateWithTimestamp = Object.assign(Object.assign({}, update), { $set: Object.assign(Object.assign({}, (update.$set || {})), { updatedAt: new Date() }) });\n            const result = yield col.updateMany(filter, updateWithTimestamp);\n            return result.modifiedCount;\n        });\n    }\n    /**\n     * Update a single document in any collection\n     */\n    updateOne(collectionName_1, filter_1, update_1) {\n        return __awaiter(this, arguments, void 0, function* (collectionName, filter, update, upsert = false) {\n            yield this.ensureConnected();\n            const col = yield this.collection(collectionName);\n            // Add updatedAt timestamp\n            const updateWithTimestamp = Object.assign(Object.assign({}, update), { $set: Object.assign(Object.assign({}, (update.$set || {})), { updatedAt: new Date() }), $setOnInsert: Object.assign(Object.assign({}, (update.$setOnInsert || {})), { createdAt: new Date() }) });\n            const result = yield col.updateOne(filter, updateWithTimestamp, { upsert });\n            return result.modifiedCount > 0 || (upsert && result.upsertedCount > 0);\n        });\n    }\n    /**\n     * Delete documents from any collection\n     */\n    deleteMany(collectionName, filter) {\n        return __awaiter(this, void 0, void 0, function* () {\n            yield this.ensureConnected();\n            const col = yield this.collection(collectionName);\n            const result = yield col.deleteMany(filter);\n            return result.deletedCount;\n        });\n    }\n    /**\n     * Delete a single document from any collection\n     */\n    deleteOne(collectionName, filter) {\n        return __awaiter(this, void 0, void 0, function* () {\n            yield this.ensureConnected();\n            const col = yield this.collection(collectionName);\n            const result = yield col.deleteOne(filter);\n            return result.deletedCount > 0;\n        });\n    }\n    /**\n     * Count documents in any collection\n     */\n    count(collectionName_1) {\n        return __awaiter(this, arguments, void 0, function* (collectionName, filter = {}) {\n            yield this.ensureConnected();\n            const col = yield this.collection(collectionName);\n            return yield col.countDocuments(filter);\n        });\n    }\n    // ==========================================================================\n    // MESSAGE OPERATIONS (Backward Compatible)\n    // ==========================================================================\n    // ==========================================================================\n    // MESSAGE OPERATIONS (Backward Compatible)\n    // ==========================================================================\n    /**\n     * Store a message in the database\n     */\n    storeMessage(message) {\n        return __awaiter(this, void 0, void 0, function* () {\n            yield this.ensureConnected();\n            const messagesCol = this.getCollection(this.COLLECTIONS.MESSAGES);\n            const result = yield messagesCol.insertOne(Object.assign(Object.assign({}, message), { createdAt: new Date(), updatedAt: new Date() }));\n            // Update conversation's updatedAt timestamp\n            const conversationsCol = this.getCollection(this.COLLECTIONS.CONVERSATIONS);\n            yield conversationsCol.updateOne({ conversationId: message.conversationId }, {\n                $set: { updatedAt: new Date() },\n                $inc: { 'metadata.messageCount': 1 },\n            }, { upsert: true });\n            return result.insertedId;\n        });\n    }\n    /**\n     * Store multiple messages in bulk\n     */\n    storeMessages(messages) {\n        return __awaiter(this, void 0, void 0, function* () {\n            if (messages.length === 0)\n                return;\n            yield this.ensureConnected();\n            const messagesCol = this.getCollection(this.COLLECTIONS.MESSAGES);\n            yield messagesCol.insertMany(messages.map(msg => (Object.assign(Object.assign({}, msg), { createdAt: new Date(), updatedAt: new Date() }))));\n            // Update conversation timestamp\n            const conversationId = messages[0].conversationId;\n            const conversationsCol = this.getCollection(this.COLLECTIONS.CONVERSATIONS);\n            yield conversationsCol.updateOne({ conversationId }, {\n                $set: { updatedAt: new Date() },\n                $inc: { 'metadata.messageCount': messages.length },\n            }, { upsert: true });\n        });\n    }\n    /**\n     * Get messages for a conversation\n     * @param limit - Maximum number of messages to retrieve (0 = all)\n     * @param skip - Number of messages to skip (for pagination)\n     */\n    getMessages(conversationId_1) {\n        return __awaiter(this, arguments, void 0, function* (conversationId, limit = 0, skip = 0) {\n            yield this.ensureConnected();\n            const messagesCol = this.getCollection(this.COLLECTIONS.MESSAGES);\n            const query = messagesCol\n                .find({ conversationId })\n                .sort({ timestamp: 1 })\n                .skip(skip);\n            if (limit > 0) {\n                query.limit(limit);\n            }\n            return yield query.toArray();\n        });\n    }\n    /**\n     * Get the last N messages for a conversation\n     */\n    getLastMessages(conversationId, count) {\n        return __awaiter(this, void 0, void 0, function* () {\n            yield this.ensureConnected();\n            const messagesCol = this.getCollection(this.COLLECTIONS.MESSAGES);\n            const messages = yield messagesCol\n                .find({ conversationId })\n                .sort({ timestamp: -1 })\n                .limit(count)\n                .toArray();\n            // Reverse to get chronological order\n            return messages.reverse();\n        });\n    }\n    /**\n     * Get message count for a conversation\n     */\n    getMessageCount(conversationId) {\n        return __awaiter(this, void 0, void 0, function* () {\n            yield this.ensureConnected();\n            const messagesCol = this.getCollection(this.COLLECTIONS.MESSAGES);\n            return yield messagesCol.countDocuments({ conversationId });\n        });\n    }\n    // ==========================================================================\n    // CONVERSATION OPERATIONS (Backward Compatible)\n    // ==========================================================================\n    /**\n     * Create or update a conversation\n     */\n    upsertConversation(conversation) {\n        return __awaiter(this, void 0, void 0, function* () {\n            yield this.ensureConnected();\n            const conversationsCol = this.getCollection(this.COLLECTIONS.CONVERSATIONS);\n            yield conversationsCol.updateOne({ conversationId: conversation.conversationId }, {\n                $set: Object.assign(Object.assign({}, conversation), { updatedAt: new Date() }),\n                $setOnInsert: { createdAt: new Date() }\n            }, { upsert: true });\n        });\n    }\n    /**\n     * Update conversation title\n     */\n    updateConversationTitle(conversationId, title) {\n        return __awaiter(this, void 0, void 0, function* () {\n            yield this.ensureConnected();\n            const conversationsCol = this.getCollection(this.COLLECTIONS.CONVERSATIONS);\n            yield conversationsCol.updateOne({ conversationId }, {\n                $set: { title, updatedAt: new Date() }\n            });\n        });\n    }\n    /**\n     * Get a conversation by ID\n     */\n    getConversation(conversationId) {\n        return __awaiter(this, void 0, void 0, function* () {\n            yield this.ensureConnected();\n            const conversationsCol = this.getCollection(this.COLLECTIONS.CONVERSATIONS);\n            return yield conversationsCol.findOne({ conversationId });\n        });\n    }\n    /**\n     * Get all conversations (sorted by most recent)\n     */\n    getConversations() {\n        return __awaiter(this, arguments, void 0, function* (limit = 50, skip = 0) {\n            yield this.ensureConnected();\n            const conversationsCol = this.getCollection(this.COLLECTIONS.CONVERSATIONS);\n            return yield conversationsCol\n                .find({})\n                .sort({ updatedAt: -1 })\n                .skip(skip)\n                .limit(limit)\n                .toArray();\n        });\n    }\n    /**\n     * Delete a conversation and all its messages\n     */\n    deleteConversation(conversationId) {\n        return __awaiter(this, void 0, void 0, function* () {\n            yield this.ensureConnected();\n            const messagesCol = this.getCollection(this.COLLECTIONS.MESSAGES);\n            const conversationsCol = this.getCollection(this.COLLECTIONS.CONVERSATIONS);\n            yield messagesCol.deleteMany({ conversationId });\n            yield conversationsCol.deleteOne({ conversationId });\n        });\n    }\n    // ==========================================================================\n    // LOG OPERATIONS (New)\n    // ==========================================================================\n    /**\n     * Store a log entry\n     */\n    storeLog(log) {\n        return __awaiter(this, void 0, void 0, function* () {\n            return yield this.insertOne(this.COLLECTIONS.LOGS, log);\n        });\n    }\n    /**\n     * Store multiple log entries\n     */\n    storeLogs(logs) {\n        return __awaiter(this, void 0, void 0, function* () {\n            return yield this.insertMany(this.COLLECTIONS.LOGS, logs);\n        });\n    }\n    /**\n     * Get logs by generation ID\n     */\n    getLogsByGeneration(generationId, limit) {\n        return __awaiter(this, void 0, void 0, function* () {\n            yield this.ensureConnected();\n            const logsCol = this.getCollection(this.COLLECTIONS.LOGS);\n            const query = logsCol.find({ generationId }).sort({ timestamp: 1 });\n            if (limit)\n                query.limit(limit);\n            return yield query.toArray();\n        });\n    }\n    /**\n     * Get logs by conversation ID\n     */\n    getLogsByConversation(conversationId, limit) {\n        return __awaiter(this, void 0, void 0, function* () {\n            yield this.ensureConnected();\n            const logsCol = this.getCollection(this.COLLECTIONS.LOGS);\n            const query = logsCol.find({ conversationId }).sort({ timestamp: -1 });\n            if (limit)\n                query.limit(limit);\n            return yield query.toArray();\n        });\n    }\n    /**\n     * Get logs by level\n     */\n    getLogsByLevel(level, limit) {\n        return __awaiter(this, void 0, void 0, function* () {\n            yield this.ensureConnected();\n            const logsCol = this.getCollection(this.COLLECTIONS.LOGS);\n            const query = logsCol.find({ level }).sort({ timestamp: -1 });\n            if (limit)\n                query.limit(limit);\n            return yield query.toArray();\n        });\n    }\n    /**\n     * Get logs with filters\n     */\n    getLogs() {\n        return __awaiter(this, arguments, void 0, function* (filter = {}, limit = 100, skip = 0) {\n            return yield this.find(this.COLLECTIONS.LOGS, filter, {\n                sort: { timestamp: -1 },\n                limit,\n                skip,\n            });\n        });\n    }\n    /**\n     * Delete old logs (older than specified date)\n     */\n    deleteOldLogs(olderThan) {\n        return __awaiter(this, void 0, void 0, function* () {\n            return yield this.deleteMany(this.COLLECTIONS.LOGS, {\n                timestamp: { $lt: olderThan }\n            });\n        });\n    }\n    // ==========================================================================\n    // GENERATION OPERATIONS (New)\n    // ==========================================================================\n    /**\n     * Store a generation entry\n     */\n    storeGeneration(generation) {\n        return __awaiter(this, void 0, void 0, function* () {\n            return yield this.insertOne(this.COLLECTIONS.GENERATIONS, generation);\n        });\n    }\n    /**\n     * Update generation status\n     */\n    updateGenerationStatus(generationId, status, metadata) {\n        return __awaiter(this, void 0, void 0, function* () {\n            return yield this.updateOne(this.COLLECTIONS.GENERATIONS, { generationId }, {\n                $set: Object.assign(Object.assign({ status }, (status === 'completed' || status === 'failed' ? { endTime: new Date() } : {})), metadata),\n            });\n        });\n    }\n    /**\n     * Get a generation by ID\n     */\n    getGeneration(generationId) {\n        return __awaiter(this, void 0, void 0, function* () {\n            return yield this.findOne(this.COLLECTIONS.GENERATIONS, {\n                generationId\n            });\n        });\n    }\n    /**\n     * Get generations by conversation ID\n     */\n    getGenerationsByConversation(conversationId, limit) {\n        return __awaiter(this, void 0, void 0, function* () {\n            return yield this.find(this.COLLECTIONS.GENERATIONS, { conversationId }, {\n                sort: { startTime: -1 },\n                limit,\n            });\n        });\n    }\n    /**\n     * Get active generations (pending or streaming)\n     */\n    getActiveGenerations() {\n        return __awaiter(this, void 0, void 0, function* () {\n            return yield this.find(this.COLLECTIONS.GENERATIONS, { status: { $in: ['pending', 'streaming'] } }, { sort: { startTime: -1 } });\n        });\n    }\n    /**\n     * Delete old generations (older than specified date)\n     */\n    deleteOldGenerations(olderThan) {\n        return __awaiter(this, void 0, void 0, function* () {\n            return yield this.deleteMany(this.COLLECTIONS.GENERATIONS, {\n                startTime: { $lt: olderThan },\n                status: { $in: ['completed', 'failed'] }\n            });\n        });\n    }\n    // ==========================================================================\n    // THOUGHT OPERATIONS\n    // ==========================================================================\n    /**\n     * Store a thought/reasoning entry\n     */\n    storeThought(thought) {\n        return __awaiter(this, void 0, void 0, function* () {\n            return yield this.insertOne(this.COLLECTIONS.THOUGHTS, thought);\n        });\n    }\n    /**\n     * Store multiple thoughts in bulk\n     */\n    storeThoughts(thoughts) {\n        return __awaiter(this, void 0, void 0, function* () {\n            if (thoughts.length === 0)\n                return;\n            yield this.insertMany(this.COLLECTIONS.THOUGHTS, thoughts);\n        });\n    }\n    /**\n     * Get thought by ID\n     */\n    getThought(thoughtId) {\n        return __awaiter(this, void 0, void 0, function* () {\n            return yield this.findOne(this.COLLECTIONS.THOUGHTS, {\n                thoughtId\n            });\n        });\n    }\n    /**\n     * Get thoughts for a specific message\n     */\n    getThoughtsByMessage(messageId) {\n        return __awaiter(this, void 0, void 0, function* () {\n            return yield this.find(this.COLLECTIONS.THOUGHTS, { messageId }, { sort: { timestamp: 1 } });\n        });\n    }\n    /**\n     * Get thoughts for a conversation\n     */\n    getThoughtsByConversation(conversationId, limit) {\n        return __awaiter(this, void 0, void 0, function* () {\n            return yield this.find(this.COLLECTIONS.THOUGHTS, { conversationId }, {\n                sort: { timestamp: -1 },\n                limit,\n            });\n        });\n    }\n    /**\n     * Get thoughts for a generation\n     */\n    getThoughtsByGeneration(generationId) {\n        return __awaiter(this, void 0, void 0, function* () {\n            return yield this.find(this.COLLECTIONS.THOUGHTS, { generationId }, { sort: { timestamp: 1 } });\n        });\n    }\n    /**\n     * Get thoughts by source (chat, router, toolPicker)\n     */\n    getThoughtsBySource(source, conversationId, limit) {\n        return __awaiter(this, void 0, void 0, function* () {\n            const filter = { source };\n            if (conversationId) {\n                filter.conversationId = conversationId;\n            }\n            return yield this.find(this.COLLECTIONS.THOUGHTS, filter, {\n                sort: { timestamp: -1 },\n                limit,\n            });\n        });\n    }\n    /**\n     * Delete old thoughts (older than specified date)\n     */\n    deleteOldThoughts(olderThan) {\n        return __awaiter(this, void 0, void 0, function* () {\n            return yield this.deleteMany(this.COLLECTIONS.THOUGHTS, {\n                timestamp: { $lt: olderThan }\n            });\n        });\n    }\n    // ==========================================================================\n    // CONNECTION MANAGEMENT\n    // ==========================================================================\n    /**\n     * Close database connection\n     */\n    close() {\n        return __awaiter(this, void 0, void 0, function* () {\n            if (this.client) {\n                yield this.client.close();\n                this.client = null;\n                this.db = null;\n                this.collections.clear();\n                this.connectionPromise = null;\n                console.log('[Database] Closed MongoDB connection');\n            }\n        });\n    }\n}\nexports.DatabaseManager = DatabaseManager;\n// ============================================================================\n// SINGLETON & EXPORTS\n// ============================================================================\n// Singleton instance\nlet dbInstance = null;\n/**\n * Get the singleton database instance\n * @param mongoUrl - MongoDB connection URL (default: from env or localhost)\n * @param dbName - Database name (default: from env or 'redbtn_ai')\n */\nfunction getDatabase(mongoUrl, dbName) {\n    if (!dbInstance) {\n        // Support both MONGODB_URI and MONGODB_URL\n        const envUri = process.env.MONGODB_URI || process.env.MONGODB_URL || 'mongodb://localhost:27017';\n        const url = mongoUrl || envUri;\n        // Try to extract database name from URI if present\n        let name = dbName;\n        if (!name) {\n            // Parse database name from URI like mongodb://user:pass@host:port/dbname\n            const dbMatch = url.match(/\\/([^/?]+)(\\?|$)/);\n            if (dbMatch && dbMatch[1]) {\n                name = dbMatch[1];\n            }\n            else {\n                name = process.env.MONGODB_NAME || 'redbtn_ai';\n            }\n        }\n        dbInstance = new DatabaseManager(url, name);\n    }\n    return dbInstance;\n}\n/**\n * Reset the singleton instance (useful for testing)\n */\nfunction resetDatabase() {\n    dbInstance = null;\n}\n"],"names":[],"mappings":"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","ignoreList":[0],"debugId":null}},
    {"offset": {"line": 1008, "column": 0}, "map": {"version":3,"sources":["file:///home/alpha/code/%40redbtn/webapp/node_modules/%40redbtn/ai/dist/lib/memory/memory.js"],"sourcesContent":["\"use strict\";\n/**\n * @file src/lib/memory.ts\n * @description Conversation memory management with MongoDB persistence and Redis caching\n */\nvar __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {\n    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }\n    return new (P || (P = Promise))(function (resolve, reject) {\n        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }\n        function rejected(value) { try { step(generator[\"throw\"](value)); } catch (e) { reject(e); } }\n        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }\n        step((generator = generator.apply(thisArg, _arguments || [])).next());\n    });\n};\nvar __importDefault = (this && this.__importDefault) || function (mod) {\n    return (mod && mod.__esModule) ? mod : { \"default\": mod };\n};\nObject.defineProperty(exports, \"__esModule\", { value: true });\nexports.MemoryManager = void 0;\nconst ioredis_1 = __importDefault(require(\"ioredis\"));\nconst tokenizer_1 = require(\"../utils/tokenizer\");\nconst database_1 = require(\"./database\");\nclass MemoryManager {\n    constructor(redisUrl) {\n        this.MAX_CONTEXT_TOKENS = parseInt(process.env.MAX_CONTEXT_TOKENS || '30000');\n        this.SUMMARY_CUSHION_TOKENS = parseInt(process.env.SUMMARY_CUSHION_TOKENS || '2000');\n        this.REDIS_MESSAGE_LIMIT = 100; // Keep last 100 messages in Redis for hot context\n        this.redisUrl = redisUrl;\n        this.redis = new ioredis_1.default(redisUrl);\n    }\n    /**\n     * Generate a conversation ID based on initial message content (stable hashing)\n     * or create a random ID if no seed is provided\n     */\n    generateConversationId(seedMessage) {\n        if (seedMessage) {\n            // Create stable ID based on message content\n            const crypto = require('crypto');\n            const hash = crypto.createHash('sha256').update(seedMessage).digest('hex').substring(0, 16);\n            return `conv_${hash}`;\n        }\n        // Generate random ID for one-off conversations\n        const crypto = require('crypto');\n        return `conv_${crypto.randomBytes(8).toString('hex')}`;\n    }\n    /**\n     * Count tokens in a message\n     */\n    countMessageTokens(message) {\n        return __awaiter(this, void 0, void 0, function* () {\n            try {\n                // Format: role + content + overhead (4 tokens per message for formatting)\n                const roleTokens = yield (0, tokenizer_1.countTokens)(message.role);\n                const contentTokens = yield (0, tokenizer_1.countTokens)(message.content);\n                return roleTokens + contentTokens + 4;\n            }\n            catch (error) {\n                // Fallback: rough estimate (1 token ≈ 4 characters)\n                return Math.ceil((message.role.length + message.content.length) / 4);\n            }\n        });\n    }\n    /**\n     * Count tokens in multiple messages\n     */\n    countMessagesTokens(messages) {\n        return __awaiter(this, void 0, void 0, function* () {\n            let total = 0;\n            for (const msg of messages) {\n                total += yield this.countMessageTokens(msg);\n            }\n            return total;\n        });\n    }\n    /**\n     * Get conversation context: returns messages that fit within token limit.\n     * Use getContextSummary() separately to retrieve summary for merging with system prompts.\n     */\n    getContextForConversation(conversationId) {\n        return __awaiter(this, void 0, void 0, function* () {\n            const messages = yield this.getMessages(conversationId);\n            // Calculate tokens and return messages that fit within limit\n            let totalTokens = 0;\n            const recentMessages = [];\n            // Work backwards from most recent message\n            for (let i = messages.length - 1; i >= 0; i--) {\n                const msgTokens = yield this.countMessageTokens(messages[i]);\n                if (totalTokens + msgTokens <= this.MAX_CONTEXT_TOKENS) {\n                    recentMessages.unshift(messages[i]);\n                    totalTokens += msgTokens;\n                }\n                else {\n                    break;\n                }\n            }\n            return recentMessages;\n        });\n    }\n    /**\n     * Get conversation summary (if exists) for manual inclusion in system prompts.\n     * Returns null if no summary has been generated yet.\n     * This returns the TRAILING summary (old trimmed messages).\n     */\n    getContextSummary(conversationId) {\n        return __awaiter(this, void 0, void 0, function* () {\n            return yield this.getTrailingSummary(conversationId);\n        });\n    }\n    /**\n     * Add a new message to the conversation\n     * Stores in both MongoDB (persistence) and Redis (hot cache of last 100 messages)\n     */\n    addMessage(conversationId, message) {\n        return __awaiter(this, void 0, void 0, function* () {\n            const key = `conversations:${conversationId}:messages`;\n            // Store in MongoDB for persistence (non-blocking, ignore errors)\n            (0, database_1.getDatabase)().storeMessage({\n                conversationId,\n                role: message.role,\n                content: message.content,\n                timestamp: new Date(message.timestamp),\n                metadata: {}\n            }).catch(err => {\n                console.warn('[Memory] Failed to save message to MongoDB:', err.message);\n            });\n            // Add to Redis (hot cache)\n            yield this.redis.rpush(key, JSON.stringify(message));\n            // Trim Redis to keep only last 100 messages\n            const messageCount = yield this.redis.llen(key);\n            if (messageCount > this.REDIS_MESSAGE_LIMIT) {\n                const trimCount = messageCount - this.REDIS_MESSAGE_LIMIT;\n                yield this.redis.ltrim(key, trimCount, -1);\n                console.log(`[Memory] Trimmed ${trimCount} old messages from Redis cache for ${conversationId}`);\n            }\n            // Update metadata\n            yield this.updateMetadata(conversationId);\n        });\n    }\n    /**\n     * Get all messages for a conversation from MongoDB (full history)\n     * For recent hot context, messages are served from Redis cache\n     */\n    getMessages(conversationId) {\n        return __awaiter(this, void 0, void 0, function* () {\n            // Try Redis first (hot cache - last 100 messages)\n            const key = `conversations:${conversationId}:messages`;\n            const messagesJson = yield this.redis.lrange(key, 0, -1);\n            if (messagesJson.length > 0) {\n                return messagesJson.map((json) => JSON.parse(json));\n            }\n            // If not in Redis, try to fetch from MongoDB and populate Redis\n            try {\n                const db = (0, database_1.getDatabase)();\n                const dbMessages = yield db.getLastMessages(conversationId, this.REDIS_MESSAGE_LIMIT);\n                if (dbMessages.length > 0) {\n                    // Populate Redis cache\n                    const pipeline = this.redis.pipeline();\n                    for (const msg of dbMessages) {\n                        const convMsg = {\n                            role: msg.role,\n                            content: msg.content,\n                            timestamp: msg.timestamp.getTime()\n                        };\n                        pipeline.rpush(key, JSON.stringify(convMsg));\n                    }\n                    yield pipeline.exec();\n                    console.log(`[Memory] Populated Redis cache with ${dbMessages.length} messages from MongoDB for ${conversationId}`);\n                    return dbMessages.map(msg => ({\n                        role: msg.role,\n                        content: msg.content,\n                        timestamp: msg.timestamp.getTime()\n                    }));\n                }\n            }\n            catch (error) {\n                console.warn('[Memory] Failed to fetch from MongoDB:', error instanceof Error ? error.message : String(error));\n            }\n            return [];\n        });\n    }\n    /**\n     * Get all messages from MongoDB (for full conversation history)\n     */\n    getAllMessagesFromDB(conversationId) {\n        return __awaiter(this, void 0, void 0, function* () {\n            const db = (0, database_1.getDatabase)();\n            const dbMessages = yield db.getMessages(conversationId);\n            return dbMessages.map(msg => ({\n                role: msg.role,\n                content: msg.content,\n                timestamp: msg.timestamp.getTime()\n            }));\n        });\n    }\n    /**\n     * Get trailing summary (old trimmed messages)\n     */\n    getTrailingSummary(conversationId) {\n        return __awaiter(this, void 0, void 0, function* () {\n            const key = `conversations:${conversationId}:summary:trailing`;\n            return yield this.redis.get(key);\n        });\n    }\n    /**\n     * Store trailing summary (old trimmed messages)\n     */\n    setTrailingSummary(conversationId, summary) {\n        return __awaiter(this, void 0, void 0, function* () {\n            const summaryKey = `conversations:${conversationId}:summary:trailing`;\n            const metaKey = `conversations:${conversationId}:metadata`;\n            yield this.redis.set(summaryKey, summary);\n            yield this.redis.hset(metaKey, 'trailingSummaryGenerated', 'true');\n            yield this.redis.hdel(metaKey, 'needsTrailingSummaryGeneration');\n            yield this.redis.hdel(metaKey, 'contentToSummarize');\n        });\n    }\n    /**\n     * Get executive summary (full conversation overview)\n     */\n    getExecutiveSummary(conversationId) {\n        return __awaiter(this, void 0, void 0, function* () {\n            const key = `conversations:${conversationId}:summary:executive`;\n            return yield this.redis.get(key);\n        });\n    }\n    /**\n     * Store executive summary (full conversation overview)\n     */\n    setExecutiveSummary(conversationId, summary) {\n        return __awaiter(this, void 0, void 0, function* () {\n            const summaryKey = `conversations:${conversationId}:summary:executive`;\n            yield this.redis.set(summaryKey, summary);\n            console.log(`[Memory] Updated executive summary for ${conversationId}`);\n        });\n    }\n    /**\n     * Get conversation metadata\n     */\n    getMetadata(conversationId) {\n        return __awaiter(this, void 0, void 0, function* () {\n            const key = `conversations:${conversationId}:metadata`;\n            const data = yield this.redis.hgetall(key);\n            if (Object.keys(data).length === 0) {\n                return null;\n            }\n            return {\n                conversationId,\n                messageCount: parseInt(data.messageCount || '0'),\n                lastUpdated: parseInt(data.lastUpdated || '0'),\n                summaryGenerated: data.summaryGenerated === 'true',\n                totalTokens: data.totalTokens ? parseInt(data.totalTokens) : undefined,\n                title: data.title || undefined,\n                titleSetByUser: data.titleSetByUser === 'true' || undefined\n            };\n        });\n    }\n    /**\n     * Update conversation metadata\n     */\n    updateMetadata(conversationId) {\n        return __awaiter(this, void 0, void 0, function* () {\n            const key = `conversations:${conversationId}:metadata`;\n            const messageCount = yield this.redis.llen(`conversations:${conversationId}:messages`);\n            // Calculate total tokens\n            const messages = yield this.getMessages(conversationId);\n            const totalTokens = yield this.countMessagesTokens(messages);\n            yield this.redis.hset(key, {\n                messageCount: messageCount.toString(),\n                lastUpdated: Date.now().toString(),\n                totalTokens: totalTokens.toString()\n            });\n        });\n    }\n    /**\n     * Check if conversation needs summarization and trimming.\n     * Returns true when total tokens exceed MAX_CONTEXT_TOKENS + SUMMARY_CUSHION_TOKENS.\n     */\n    needsSummarization(conversationId) {\n        return __awaiter(this, void 0, void 0, function* () {\n            const messages = yield this.getMessages(conversationId);\n            const totalTokens = yield this.countMessagesTokens(messages);\n            // Trigger summarization when we exceed the context limit + cushion\n            return totalTokens > (this.MAX_CONTEXT_TOKENS + this.SUMMARY_CUSHION_TOKENS);\n        });\n    }\n    /**\n     * Trim messages and generate summary to bring conversation under token limit.\n     * This includes any existing summary in the summarization.\n     */\n    trimAndSummarize(conversationId) {\n        return __awaiter(this, void 0, void 0, function* () {\n            const messages = yield this.getMessages(conversationId);\n            const existingSummary = yield this.getTrailingSummary(conversationId);\n            // Calculate how many tokens we need to keep for recent context\n            let recentTokens = 0;\n            let keepFromIndex = messages.length;\n            // Work backwards to find where to cut\n            for (let i = messages.length - 1; i >= 0; i--) {\n                const msgTokens = yield this.countMessageTokens(messages[i]);\n                if (recentTokens + msgTokens <= this.MAX_CONTEXT_TOKENS) {\n                    recentTokens += msgTokens;\n                    keepFromIndex = i;\n                }\n                else {\n                    break;\n                }\n            }\n            // If all messages fit, no need to summarize\n            if (keepFromIndex === 0) {\n                return;\n            }\n            // Messages to summarize (everything before keepFromIndex)\n            const messagesToSummarize = messages.slice(0, keepFromIndex);\n            if (messagesToSummarize.length === 0) {\n                return;\n            }\n            // Keep only recent messages in Redis\n            const messagesToKeep = messages.slice(keepFromIndex);\n            // Clear old messages and store only recent ones\n            const messagesKey = `conversations:${conversationId}:messages`;\n            yield this.redis.del(messagesKey);\n            for (const msg of messagesToKeep) {\n                yield this.redis.rpush(messagesKey, JSON.stringify(msg));\n            }\n            // Build summary content (include existing summary if present)\n            let contentToSummarize = '';\n            if (existingSummary) {\n                contentToSummarize += `Previous summary: ${existingSummary}\\n\\n`;\n            }\n            contentToSummarize += messagesToSummarize\n                .map(m => `${m.role.toUpperCase()}: ${m.content}`)\n                .join('\\n');\n            // Return the content to summarize (caller will invoke LLM)\n            // Store a marker that we need to generate trailing summary\n            const metaKey = `conversations:${conversationId}:metadata`;\n            yield this.redis.hset(metaKey, 'needsTrailingSummaryGeneration', 'true');\n            yield this.redis.hset(metaKey, 'contentToSummarize', contentToSummarize);\n            // Update metadata\n            yield this.updateMetadata(conversationId);\n        });\n    }\n    /**\n     * Get content that needs to be summarized (after trimAndSummarize was called)\n     */\n    getContentToSummarize(conversationId) {\n        return __awaiter(this, void 0, void 0, function* () {\n            const metaKey = `conversations:${conversationId}:metadata`;\n            return yield this.redis.hget(metaKey, 'contentToSummarize');\n        });\n    }\n    /**\n     * Check if trailing summary generation is pending\n     */\n    needsSummaryGeneration(conversationId) {\n        return __awaiter(this, void 0, void 0, function* () {\n            const metaKey = `conversations:${conversationId}:metadata`;\n            const value = yield this.redis.hget(metaKey, 'needsTrailingSummaryGeneration');\n            return value === 'true';\n        });\n    }\n    /**\n     * Perform summarization if needed - complete workflow in one call.\n     * @param conversationId The conversation to check and summarize\n     * @param llmInvoker A function that takes a prompt and returns the LLM's response\n     * @returns true if summarization was performed, false if not needed\n     */\n    summarizeIfNeeded(conversationId, llmInvoker) {\n        return __awaiter(this, void 0, void 0, function* () {\n            try {\n                const needsSummary = yield this.needsSummarization(conversationId);\n                if (!needsSummary) {\n                    return false;\n                }\n                const tokenCount = yield this.getTokenCount(conversationId);\n                console.log(`[Memory] Token limit exceeded for ${conversationId}: ${tokenCount} tokens - trimming and summarizing...`);\n                // Trim messages to fit within token limit\n                yield this.trimAndSummarize(conversationId);\n                // Check if summary generation is needed\n                const needsGeneration = yield this.needsSummaryGeneration(conversationId);\n                if (!needsGeneration) {\n                    console.log(`[Memory] No summary generation needed for ${conversationId}`);\n                    return false;\n                }\n                // Get content to summarize (includes previous summary if exists)\n                const contentToSummarize = yield this.getContentToSummarize(conversationId);\n                if (!contentToSummarize) {\n                    return false;\n                }\n                // Create summary prompt\n                const summaryPrompt = this.buildSummaryPrompt(contentToSummarize);\n                // Generate summary using the provided LLM invoker\n                const summary = yield llmInvoker(summaryPrompt);\n                // Store the trailing summary\n                yield this.setTrailingSummary(conversationId, summary);\n                const newTokenCount = yield this.getTokenCount(conversationId);\n                console.log(`[Memory] Summarization complete for ${conversationId}: trimmed to ${newTokenCount} tokens`);\n                return true;\n            }\n            catch (error) {\n                console.error('[Memory] Summarization error:', error);\n                return false;\n            }\n        });\n    }\n    /**\n     * Generate executive summary (full conversation overview).\n     * Should be called after 3rd+ AI responses.\n     * @param llmInvoker A function that takes a prompt and returns the LLM's response\n     */\n    generateExecutiveSummary(conversationId, llmInvoker) {\n        return __awaiter(this, void 0, void 0, function* () {\n            try {\n                const messages = yield this.getMessages(conversationId);\n                if (messages.length === 0) {\n                    return;\n                }\n                // Build full conversation text\n                const conversationText = messages\n                    .map(m => `${m.role.toUpperCase()}: ${m.content}`)\n                    .join('\\n');\n                const prompt = `Provide a comprehensive executive summary of the following conversation. Focus on:\n- User's goals and preferences\n- Key topics discussed\n- Important decisions or conclusions\n- Context that would be useful for future interactions\n\nKeep it concise but informative (200-400 words). Only respond with the summary itself:\n\n${conversationText}`;\n                const summary = yield llmInvoker(prompt);\n                yield this.setExecutiveSummary(conversationId, summary);\n                console.log(`[Memory] Generated executive summary for ${conversationId}`);\n            }\n            catch (error) {\n                console.error('[Memory] Executive summary generation error:', error);\n            }\n        });\n    }\n    /**\n     * Build the prompt for summarization (can be overridden or customized)\n     */\n    buildSummaryPrompt(contentToSummarize) {\n        return `Summarize the following conversation history concisely. Focus on information about the user, key topics, decisions, and important context. Retain key information from previous summaries if they exist. Only respond with the summary itself. Keep it over 500 but under 1000 words:\n\n${contentToSummarize}`;\n    }\n    /**\n     * Get current token count for a conversation (useful for monitoring)\n     */\n    getTokenCount(conversationId) {\n        return __awaiter(this, void 0, void 0, function* () {\n            const messages = yield this.getMessages(conversationId);\n            return yield this.countMessagesTokens(messages);\n        });\n    }\n    /**\n     * Get token count for messages that would be returned by getContextForConversation\n     */\n    getContextTokenCount(conversationId) {\n        return __awaiter(this, void 0, void 0, function* () {\n            const contextMessages = yield this.getContextForConversation(conversationId);\n            return yield this.countMessagesTokens(contextMessages);\n        });\n    }\n    /**\n     * Delete a conversation (for cleanup/testing)\n     */\n    deleteConversation(conversationId) {\n        return __awaiter(this, void 0, void 0, function* () {\n            yield this.redis.del(`conversations:${conversationId}:messages`);\n            yield this.redis.del(`conversations:${conversationId}:summary:trailing`);\n            yield this.redis.del(`conversations:${conversationId}:summary:executive`);\n            yield this.redis.del(`conversations:${conversationId}:metadata`);\n        });\n    }\n    /**\n     * Close Redis connection and free tokenizer\n     */\n    close() {\n        return __awaiter(this, void 0, void 0, function* () {\n            (0, tokenizer_1.freeTiktoken)();\n            yield this.redis.quit();\n        });\n    }\n}\nexports.MemoryManager = MemoryManager;\n"],"names":[],"mappings":"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","ignoreList":[0],"debugId":null}},
    {"offset": {"line": 1483, "column": 0}, "map": {"version":3,"sources":["file:///home/alpha/code/%40redbtn/webapp/node_modules/%40redbtn/ai/dist/lib/memory/queue.js"],"sourcesContent":["\"use strict\";\nvar __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {\n    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }\n    return new (P || (P = Promise))(function (resolve, reject) {\n        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }\n        function rejected(value) { try { step(generator[\"throw\"](value)); } catch (e) { reject(e); } }\n        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }\n        step((generator = generator.apply(thisArg, _arguments || [])).next());\n    });\n};\nvar __await = (this && this.__await) || function (v) { return this instanceof __await ? (this.v = v, this) : new __await(v); }\nvar __asyncGenerator = (this && this.__asyncGenerator) || function (thisArg, _arguments, generator) {\n    if (!Symbol.asyncIterator) throw new TypeError(\"Symbol.asyncIterator is not defined.\");\n    var g = generator.apply(thisArg, _arguments || []), i, q = [];\n    return i = Object.create((typeof AsyncIterator === \"function\" ? AsyncIterator : Object).prototype), verb(\"next\"), verb(\"throw\"), verb(\"return\", awaitReturn), i[Symbol.asyncIterator] = function () { return this; }, i;\n    function awaitReturn(f) { return function (v) { return Promise.resolve(v).then(f, reject); }; }\n    function verb(n, f) { if (g[n]) { i[n] = function (v) { return new Promise(function (a, b) { q.push([n, v, a, b]) > 1 || resume(n, v); }); }; if (f) i[n] = f(i[n]); } }\n    function resume(n, v) { try { step(g[n](v)); } catch (e) { settle(q[0][3], e); } }\n    function step(r) { r.value instanceof __await ? Promise.resolve(r.value.v).then(fulfill, reject) : settle(q[0][2], r); }\n    function fulfill(value) { resume(\"next\", value); }\n    function reject(value) { resume(\"throw\", value); }\n    function settle(f, v) { if (f(v), q.shift(), q.length) resume(q[0][0], q[0][1]); }\n};\nvar __asyncValues = (this && this.__asyncValues) || function (o) {\n    if (!Symbol.asyncIterator) throw new TypeError(\"Symbol.asyncIterator is not defined.\");\n    var m = o[Symbol.asyncIterator], i;\n    return m ? m.call(o) : (o = typeof __values === \"function\" ? __values(o) : o[Symbol.iterator](), i = {}, verb(\"next\"), verb(\"throw\"), verb(\"return\"), i[Symbol.asyncIterator] = function () { return this; }, i);\n    function verb(n) { i[n] = o[n] && function (v) { return new Promise(function (resolve, reject) { v = o[n](v), settle(resolve, reject, v.done, v.value); }); }; }\n    function settle(resolve, reject, d, v) { Promise.resolve(v).then(function(v) { resolve({ value: v, done: d }); }, reject); }\n};\nObject.defineProperty(exports, \"__esModule\", { value: true });\nexports.MessageQueue = void 0;\nclass MessageQueue {\n    constructor(redis) {\n        this.STATE_TTL = 3600; // 1 hour TTL for message states\n        this.CONTENT_KEY_PREFIX = 'message:generating:';\n        this.INDEX_KEY_PREFIX = 'conversation:generating:';\n        this.PUBSUB_PREFIX = 'message:stream:';\n        this.redis = redis;\n    }\n    /**\n     * Start tracking a new message generation\n     */\n    startGeneration(conversationId, messageId) {\n        return __awaiter(this, void 0, void 0, function* () {\n            const state = {\n                conversationId,\n                messageId,\n                status: 'generating',\n                content: '',\n                startedAt: Date.now()\n            };\n            const key = `${this.CONTENT_KEY_PREFIX}${messageId}`;\n            yield this.redis.setex(key, this.STATE_TTL, JSON.stringify(state));\n            // Add to conversation's generating messages index\n            yield this.redis.sadd(`${this.INDEX_KEY_PREFIX}${conversationId}`, messageId);\n            yield this.redis.expire(`${this.INDEX_KEY_PREFIX}${conversationId}`, this.STATE_TTL);\n            console.log(`[MessageQueue] Started generation tracking: ${messageId}`);\n        });\n    }\n    /**\n     * Append content to a generating message (called as tokens stream in)\n     */\n    appendContent(messageId, chunk) {\n        return __awaiter(this, void 0, void 0, function* () {\n            const key = `${this.CONTENT_KEY_PREFIX}${messageId}`;\n            const stateJson = yield this.redis.get(key);\n            if (!stateJson) {\n                console.warn(`[MessageQueue] Cannot append to non-existent message: ${messageId}`);\n                return;\n            }\n            const state = JSON.parse(stateJson);\n            state.content += chunk;\n            yield this.redis.setex(key, this.STATE_TTL, JSON.stringify(state));\n            // Publish chunk to pub/sub channel for real-time streaming\n            yield this.redis.publish(`${this.PUBSUB_PREFIX}${messageId}`, JSON.stringify({ type: 'chunk', content: chunk }));\n        });\n    }\n    /**\n     * Mark message generation as completed\n     */\n    completeGeneration(messageId, metadata) {\n        return __awaiter(this, void 0, void 0, function* () {\n            const key = `${this.CONTENT_KEY_PREFIX}${messageId}`;\n            const stateJson = yield this.redis.get(key);\n            if (!stateJson) {\n                console.warn(`[MessageQueue] Cannot complete non-existent message: ${messageId}`);\n                return;\n            }\n            const state = JSON.parse(stateJson);\n            state.status = 'completed';\n            state.completedAt = Date.now();\n            if (metadata) {\n                state.metadata = metadata;\n            }\n            yield this.redis.setex(key, this.STATE_TTL, JSON.stringify(state));\n            // Remove from generating index\n            yield this.redis.srem(`${this.INDEX_KEY_PREFIX}${state.conversationId}`, messageId);\n            // Publish completion event\n            yield this.redis.publish(`${this.PUBSUB_PREFIX}${messageId}`, JSON.stringify({ type: 'complete', metadata }));\n            console.log(`[MessageQueue] Completed generation: ${messageId} (${state.content.length} chars)`);\n        });\n    }\n    /**\n     * Publish tool status indicator (searching, scraping, etc.)\n     */\n    publishToolStatus(messageId, toolInfo) {\n        return __awaiter(this, void 0, void 0, function* () {\n            // Publish tool status event without modifying state\n            yield this.redis.publish(`${this.PUBSUB_PREFIX}${messageId}`, JSON.stringify(Object.assign({ type: 'tool_status' }, toolInfo)));\n        });\n    }\n    /**\n     * Publish general status update (routing, thinking, processing, etc.)\n     */\n    publishStatus(messageId, status) {\n        return __awaiter(this, void 0, void 0, function* () {\n            console.log(`[MessageQueue] Publishing status for ${messageId}:`, status.action);\n            yield this.redis.publish(`${this.PUBSUB_PREFIX}${messageId}`, JSON.stringify(Object.assign({ type: 'status' }, status)));\n        });\n    }\n    /**\n     * Publish thinking/reasoning content chunk by chunk\n     */\n    publishThinkingChunk(messageId, chunk) {\n        return __awaiter(this, void 0, void 0, function* () {\n            // Silent - too noisy to log each chunk\n            yield this.redis.publish(`${this.PUBSUB_PREFIX}${messageId}`, JSON.stringify({ type: 'thinking_chunk', content: chunk }));\n        });\n    }\n    /**\n     * Publish thinking/reasoning content (legacy - for full blocks)\n     */\n    publishThinking(messageId, thinking) {\n        return __awaiter(this, void 0, void 0, function* () {\n            // Publish thinking event\n            yield this.redis.publish(`${this.PUBSUB_PREFIX}${messageId}`, JSON.stringify({ type: 'thinking', content: thinking }));\n            console.log(`[MessageQueue] Published thinking for ${messageId} (${thinking.length} chars)`);\n        });\n    }\n    /**\n     * Mark message generation as failed\n     */\n    failGeneration(messageId, error) {\n        return __awaiter(this, void 0, void 0, function* () {\n            const key = `${this.CONTENT_KEY_PREFIX}${messageId}`;\n            const stateJson = yield this.redis.get(key);\n            if (!stateJson) {\n                console.warn(`[MessageQueue] Cannot fail non-existent message: ${messageId}`);\n                return;\n            }\n            const state = JSON.parse(stateJson);\n            state.status = 'error';\n            state.error = error;\n            state.completedAt = Date.now();\n            yield this.redis.setex(key, this.STATE_TTL, JSON.stringify(state));\n            // Remove from generating index\n            yield this.redis.srem(`${this.INDEX_KEY_PREFIX}${state.conversationId}`, messageId);\n            // Publish error event\n            yield this.redis.publish(`${this.PUBSUB_PREFIX}${messageId}`, JSON.stringify({ type: 'error', error }));\n            console.error(`[MessageQueue] Failed generation: ${messageId} - ${error}`);\n        });\n    }\n    /**\n     * Get current state of a generating message\n     */\n    getMessageState(messageId) {\n        return __awaiter(this, void 0, void 0, function* () {\n            const key = `${this.CONTENT_KEY_PREFIX}${messageId}`;\n            const stateJson = yield this.redis.get(key);\n            if (!stateJson) {\n                return null;\n            }\n            return JSON.parse(stateJson);\n        });\n    }\n    /**\n     * Get all generating messages for a conversation\n     */\n    getGeneratingMessages(conversationId) {\n        return __awaiter(this, void 0, void 0, function* () {\n            const messageIds = yield this.redis.smembers(`${this.INDEX_KEY_PREFIX}${conversationId}`);\n            if (messageIds.length === 0) {\n                return [];\n            }\n            const states = [];\n            for (const messageId of messageIds) {\n                const state = yield this.getMessageState(messageId);\n                if (state) {\n                    states.push(state);\n                }\n            }\n            return states;\n        });\n    }\n    /**\n     * Clean up completed/failed message state\n     */\n    cleanupMessage(messageId) {\n        return __awaiter(this, void 0, void 0, function* () {\n            const key = `${this.CONTENT_KEY_PREFIX}${messageId}`;\n            yield this.redis.del(key);\n        });\n    }\n    /**\n     * Subscribe to a message stream via Redis pub/sub\n     * Returns an async generator that yields chunks, completion, or errors\n     */\n    subscribeToMessage(messageId) {\n        return __asyncGenerator(this, arguments, function* subscribeToMessage_1() {\n            var _a, e_1, _b, _c;\n            // First, get any existing content\n            const state = yield __await(this.getMessageState(messageId));\n            if (!state) {\n                throw new Error(`Message ${messageId} not found`);\n            }\n            // Yield existing content if any\n            if (state.content) {\n                yield yield __await({ type: 'init', existingContent: state.content });\n            }\n            // If already completed, just send completion event\n            if (state.status === 'completed') {\n                yield yield __await({ type: 'complete', metadata: state.metadata });\n                return yield __await(void 0);\n            }\n            if (state.status === 'error') {\n                yield yield __await({ type: 'error', error: state.error });\n                return yield __await(void 0);\n            }\n            // Subscribe to pub/sub for new chunks\n            const subscriber = this.redis.duplicate();\n            // Increase max listeners to prevent warnings when multiple clients connect\n            subscriber.setMaxListeners(50);\n            const channel = `${this.PUBSUB_PREFIX}${messageId}`;\n            const getState = this.getMessageState.bind(this);\n            let cleanedUp = false;\n            const cleanup = () => __awaiter(this, void 0, void 0, function* () {\n                if (cleanedUp)\n                    return;\n                cleanedUp = true;\n                try {\n                    yield subscriber.unsubscribe(channel);\n                    yield subscriber.quit();\n                    console.log(`[MessageQueue] Cleaned up subscriber for ${messageId}`);\n                }\n                catch (e) {\n                    // Ignore cleanup errors\n                }\n            });\n            try {\n                yield __await(subscriber.subscribe(channel));\n                // Create a promise-based message handler\n                const messageIterator = function (sub) {\n                    return __asyncGenerator(this, arguments, function* () {\n                        while (true) {\n                            const message = yield __await(new Promise((resolve) => {\n                                sub.once('message', (ch, msg) => {\n                                    if (ch === channel) {\n                                        resolve(msg);\n                                    }\n                                });\n                                // Timeout after 30 seconds of no activity\n                                setTimeout(() => resolve(null), 30000);\n                            }));\n                            if (message === null) {\n                                // Timeout - check if generation completed\n                                const currentState = yield __await(getState(messageId));\n                                if (!currentState || currentState.status !== 'generating') {\n                                    break;\n                                }\n                                continue;\n                            }\n                            yield yield __await(message);\n                        }\n                    });\n                }(subscriber);\n                try {\n                    for (var _d = true, messageIterator_1 = __asyncValues(messageIterator), messageIterator_1_1; messageIterator_1_1 = yield __await(messageIterator_1.next()), _a = messageIterator_1_1.done, !_a; _d = true) {\n                        _c = messageIterator_1_1.value;\n                        _d = false;\n                        const message = _c;\n                        const event = JSON.parse(message);\n                        if (event.type === 'chunk') {\n                            yield yield __await({ type: 'chunk', content: event.content });\n                        }\n                        else if (event.type === 'status') {\n                            yield yield __await({ type: 'status', action: event.action, description: event.description });\n                        }\n                        else if (event.type === 'thinking_chunk') {\n                            yield yield __await({ type: 'thinking_chunk', content: event.content });\n                        }\n                        else if (event.type === 'thinking') {\n                            yield yield __await({ type: 'thinking', content: event.content });\n                        }\n                        else if (event.type === 'tool_status') {\n                            yield yield __await({ type: 'tool_status', status: event.status, action: event.action });\n                        }\n                        else if (event.type === 'complete') {\n                            yield yield __await({ type: 'complete', metadata: event.metadata });\n                            break;\n                        }\n                        else if (event.type === 'error') {\n                            yield yield __await({ type: 'error', error: event.error });\n                            break;\n                        }\n                    }\n                }\n                catch (e_1_1) { e_1 = { error: e_1_1 }; }\n                finally {\n                    try {\n                        if (!_d && !_a && (_b = messageIterator_1.return)) yield __await(_b.call(messageIterator_1));\n                    }\n                    finally { if (e_1) throw e_1.error; }\n                }\n            }\n            finally {\n                yield __await(cleanup());\n            }\n        });\n    }\n}\nexports.MessageQueue = MessageQueue;\n"],"names":[],"mappings":"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","ignoreList":[0],"debugId":null}},
    {"offset": {"line": 1916, "column": 0}, "map": {"version":3,"sources":["file:///home/alpha/code/%40redbtn/webapp/node_modules/%40redbtn/ai/dist/lib/logs/types.js"],"sourcesContent":["\"use strict\";\n/**\n * Log types and data structures for the Red AI logging system\n */\nObject.defineProperty(exports, \"__esModule\", { value: true });\nexports.TTL = exports.RedisKeys = void 0;\n/**\n * Redis key patterns\n */\nexports.RedisKeys = {\n    // Log storage\n    log: (logId) => `log:${logId}`,\n    generationLogs: (genId) => `generation:${genId}:logs`,\n    conversationLogs: (convId) => `conversation:${convId}:logs`,\n    // Generation tracking\n    generation: (genId) => `generation:${genId}`,\n    conversationGeneration: (convId) => `conversation:${convId}:generation`,\n    // Pub/sub channels\n    logChannel: (genId) => `logs:generation:${genId}`,\n    conversationLogChannel: (convId) => `logs:conversation:${convId}`,\n    allLogsChannel: 'logs:all',\n};\n/**\n * TTL values (in seconds)\n */\nexports.TTL = {\n    LOG: 30 * 24 * 60 * 60, // 30 days for individual logs\n    GENERATION: 30 * 24 * 60 * 60, // 30 days for generation data\n    LOG_LIST: 30 * 24 * 60 * 60, // 30 days for log lists\n};\n"],"names":[],"mappings":"AACA;;CAEC,GACD,OAAO,cAAc,CAAC,SAAS,cAAc;IAAE,OAAO;AAAK;AAC3D,QAAQ,GAAG,GAAG,QAAQ,SAAS,GAAG,KAAK;AACvC;;CAEC,GACD,QAAQ,SAAS,GAAG;IAChB,cAAc;IACd,KAAK,CAAC,QAAU,CAAC,IAAI,EAAE,OAAO;IAC9B,gBAAgB,CAAC,QAAU,CAAC,WAAW,EAAE,MAAM,KAAK,CAAC;IACrD,kBAAkB,CAAC,SAAW,CAAC,aAAa,EAAE,OAAO,KAAK,CAAC;IAC3D,sBAAsB;IACtB,YAAY,CAAC,QAAU,CAAC,WAAW,EAAE,OAAO;IAC5C,wBAAwB,CAAC,SAAW,CAAC,aAAa,EAAE,OAAO,WAAW,CAAC;IACvE,mBAAmB;IACnB,YAAY,CAAC,QAAU,CAAC,gBAAgB,EAAE,OAAO;IACjD,wBAAwB,CAAC,SAAW,CAAC,kBAAkB,EAAE,QAAQ;IACjE,gBAAgB;AACpB;AACA;;CAEC,GACD,QAAQ,GAAG,GAAG;IACV,KAAK,KAAK,KAAK,KAAK;IACpB,YAAY,KAAK,KAAK,KAAK;IAC3B,UAAU,KAAK,KAAK,KAAK;AAC7B","ignoreList":[0],"debugId":null}},
    {"offset": {"line": 1948, "column": 0}, "map": {"version":3,"sources":["file:///home/alpha/code/%40redbtn/webapp/node_modules/%40redbtn/ai/dist/lib/logs/logger.js"],"sourcesContent":["\"use strict\";\nvar __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {\n    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }\n    return new (P || (P = Promise))(function (resolve, reject) {\n        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }\n        function rejected(value) { try { step(generator[\"throw\"](value)); } catch (e) { reject(e); } }\n        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }\n        step((generator = generator.apply(thisArg, _arguments || [])).next());\n    });\n};\nvar __await = (this && this.__await) || function (v) { return this instanceof __await ? (this.v = v, this) : new __await(v); }\nvar __asyncGenerator = (this && this.__asyncGenerator) || function (thisArg, _arguments, generator) {\n    if (!Symbol.asyncIterator) throw new TypeError(\"Symbol.asyncIterator is not defined.\");\n    var g = generator.apply(thisArg, _arguments || []), i, q = [];\n    return i = Object.create((typeof AsyncIterator === \"function\" ? AsyncIterator : Object).prototype), verb(\"next\"), verb(\"throw\"), verb(\"return\", awaitReturn), i[Symbol.asyncIterator] = function () { return this; }, i;\n    function awaitReturn(f) { return function (v) { return Promise.resolve(v).then(f, reject); }; }\n    function verb(n, f) { if (g[n]) { i[n] = function (v) { return new Promise(function (a, b) { q.push([n, v, a, b]) > 1 || resume(n, v); }); }; if (f) i[n] = f(i[n]); } }\n    function resume(n, v) { try { step(g[n](v)); } catch (e) { settle(q[0][3], e); } }\n    function step(r) { r.value instanceof __await ? Promise.resolve(r.value.v).then(fulfill, reject) : settle(q[0][2], r); }\n    function fulfill(value) { resume(\"next\", value); }\n    function reject(value) { resume(\"throw\", value); }\n    function settle(f, v) { if (f(v), q.shift(), q.length) resume(q[0][0], q[0][1]); }\n};\nObject.defineProperty(exports, \"__esModule\", { value: true });\nexports.Logger = void 0;\nconst types_1 = require(\"./types\");\n/**\n * The most fantastic logging system known to man\n *\n * Features:\n * - Redis pub/sub for real-time log streaming\n * - 30-day TTL for all logs\n * - Generation-level tracking with unique IDs\n * - Thought logs separate from response logs\n * - Color tag support for frontends\n * - Conversation-level aggregated logs\n * - Concurrent generation prevention\n */\nclass Logger {\n    constructor(redis) {\n        this.redis = redis;\n        // Increase max listeners for pub/sub\n        this.redis.setMaxListeners(100);\n    }\n    /**\n     * Generate a unique generation ID\n     */\n    generateGenerationId() {\n        const timestamp = Date.now();\n        const random = Math.random().toString(36).substring(2, 11);\n        return `gen_${timestamp}_${random}`;\n    }\n    /**\n     * Generate a unique log ID\n     */\n    generateLogId() {\n        return `log_${Date.now()}_${Math.random().toString(36).substring(2, 11)}`;\n    }\n    /**\n     * Start a new generation\n     * Returns null if a generation is already in progress for this conversation\n     * Automatically cleans up stale generations (older than 5 minutes)\n     */\n    startGeneration(conversationId, generationId) {\n        return __awaiter(this, void 0, void 0, function* () {\n            const genId = generationId || this.generateGenerationId();\n            // Check if a generation is already in progress\n            const stateKey = types_1.RedisKeys.conversationGeneration(conversationId);\n            const stateJson = yield this.redis.get(stateKey);\n            if (stateJson) {\n                const state = JSON.parse(stateJson);\n                if (state.currentGenerationId) {\n                    // Check if it's still actually generating\n                    const genKey = types_1.RedisKeys.generation(state.currentGenerationId);\n                    const genJson = yield this.redis.get(genKey);\n                    if (genJson) {\n                        const gen = JSON.parse(genJson);\n                        if (gen.status === 'generating') {\n                            // Check if generation is stale (older than 5 minutes)\n                            const ageMs = Date.now() - gen.startedAt;\n                            const maxAgeMs = 5 * 60 * 1000; // 5 minutes\n                            if (ageMs > maxAgeMs) {\n                                console.log(`[Logger] Cleaning up stale generation: ${state.currentGenerationId} (age: ${Math.round(ageMs / 1000)}s)`);\n                                // Mark as error and allow new generation\n                                yield this.failGeneration(state.currentGenerationId, 'Generation timed out (stale)');\n                            }\n                            else {\n                                console.log(`[Logger] Generation already in progress: ${state.currentGenerationId} (age: ${Math.round(ageMs / 1000)}s)`);\n                                return null; // Reject concurrent generation\n                            }\n                        }\n                    }\n                    else {\n                        // Generation record not found, clean up state\n                        console.log(`[Logger] Cleaning up orphaned generation state: ${state.currentGenerationId}`);\n                        state.currentGenerationId = undefined;\n                        yield this.redis.setex(stateKey, types_1.TTL.GENERATION, JSON.stringify(state));\n                    }\n                }\n            }\n            // Create generation record\n            const generation = {\n                id: genId,\n                conversationId,\n                status: 'generating',\n                startedAt: Date.now(),\n            };\n            yield this.redis.setex(types_1.RedisKeys.generation(genId), types_1.TTL.GENERATION, JSON.stringify(generation));\n            // Update conversation generation state\n            const newState = {\n                conversationId,\n                currentGenerationId: genId,\n                lastGenerationId: genId,\n                generationCount: stateJson ? JSON.parse(stateJson).generationCount + 1 : 1,\n            };\n            yield this.redis.setex(stateKey, types_1.TTL.GENERATION, JSON.stringify(newState));\n            // Log generation start\n            yield this.log({\n                level: 'info',\n                category: 'generation',\n                message: `<cyan>Generation started</cyan>`,\n                generationId: genId,\n                conversationId,\n            });\n            return genId;\n        });\n    }\n    /**\n     * Complete a generation\n     */\n    completeGeneration(generationId, data) {\n        return __awaiter(this, void 0, void 0, function* () {\n            const genKey = types_1.RedisKeys.generation(generationId);\n            const genJson = yield this.redis.get(genKey);\n            if (!genJson) {\n                console.warn(`[Logger] Generation not found: ${generationId}`);\n                return;\n            }\n            const generation = JSON.parse(genJson);\n            generation.status = 'completed';\n            generation.completedAt = Date.now();\n            generation.response = data.response;\n            generation.thinking = data.thinking;\n            generation.route = data.route;\n            generation.toolsUsed = data.toolsUsed;\n            generation.model = data.model;\n            generation.tokens = data.tokens;\n            yield this.redis.setex(genKey, types_1.TTL.GENERATION, JSON.stringify(generation));\n            // Clear current generation from conversation state\n            const stateKey = types_1.RedisKeys.conversationGeneration(generation.conversationId);\n            const stateJson = yield this.redis.get(stateKey);\n            if (stateJson) {\n                const state = JSON.parse(stateJson);\n                if (state.currentGenerationId === generationId) {\n                    state.currentGenerationId = undefined;\n                    yield this.redis.setex(stateKey, types_1.TTL.GENERATION, JSON.stringify(state));\n                }\n            }\n            // Log completion\n            const duration = generation.completedAt - generation.startedAt;\n            yield this.log({\n                level: 'success',\n                category: 'generation',\n                message: `<green>Generation completed</green> <dim>(${duration}ms)</dim>`,\n                generationId,\n                conversationId: generation.conversationId,\n                metadata: {\n                    duration,\n                    tokens: data.tokens,\n                    route: data.route,\n                    toolsUsed: data.toolsUsed,\n                },\n            });\n            // Also persist the assistant response as a chat log so UI and DB have the actual text\n            if (data.response && typeof data.response === 'string') {\n                const maxLen = 10000; // safety cutoff to avoid extremely large single logs\n                const truncated = data.response.length > maxLen;\n                const respText = truncated ? data.response.slice(0, maxLen) : data.response;\n                yield this.log({\n                    level: 'info',\n                    category: 'chat',\n                    message: respText,\n                    generationId,\n                    conversationId: generation.conversationId,\n                    metadata: {\n                        contentLength: data.response.length,\n                        truncated,\n                        model: data.model,\n                    },\n                });\n            }\n        });\n    }\n    /**\n     * Fail a generation\n     */\n    failGeneration(generationId, error) {\n        return __awaiter(this, void 0, void 0, function* () {\n            const genKey = types_1.RedisKeys.generation(generationId);\n            const genJson = yield this.redis.get(genKey);\n            if (!genJson) {\n                console.warn(`[Logger] Generation not found: ${generationId}`);\n                return;\n            }\n            const generation = JSON.parse(genJson);\n            generation.status = 'error';\n            generation.completedAt = Date.now();\n            generation.error = error;\n            yield this.redis.setex(genKey, types_1.TTL.GENERATION, JSON.stringify(generation));\n            // Clear current generation from conversation state\n            const stateKey = types_1.RedisKeys.conversationGeneration(generation.conversationId);\n            const stateJson = yield this.redis.get(stateKey);\n            if (stateJson) {\n                const state = JSON.parse(stateJson);\n                if (state.currentGenerationId === generationId) {\n                    state.currentGenerationId = undefined;\n                    yield this.redis.setex(stateKey, types_1.TTL.GENERATION, JSON.stringify(state));\n                }\n            }\n            // Log error\n            yield this.log({\n                level: 'error',\n                category: 'generation',\n                message: `<red>Generation failed:</red> ${error}`,\n                generationId,\n                conversationId: generation.conversationId,\n                metadata: { error },\n            });\n        });\n    }\n    /**\n     * Log a message\n     */\n    log(params) {\n        return __awaiter(this, void 0, void 0, function* () {\n            const logEntry = {\n                id: this.generateLogId(),\n                timestamp: Date.now(),\n                level: params.level,\n                category: params.category,\n                message: params.message,\n                generationId: params.generationId,\n                conversationId: params.conversationId,\n                metadata: params.metadata,\n            };\n            // Store individual log\n            yield this.redis.setex(types_1.RedisKeys.log(logEntry.id), types_1.TTL.LOG, JSON.stringify(logEntry));\n            // Add to generation logs list\n            if (params.generationId) {\n                const listKey = types_1.RedisKeys.generationLogs(params.generationId);\n                yield this.redis.rpush(listKey, logEntry.id);\n                yield this.redis.expire(listKey, types_1.TTL.LOG_LIST);\n            }\n            // Add to conversation logs list\n            if (params.conversationId) {\n                const listKey = types_1.RedisKeys.conversationLogs(params.conversationId);\n                yield this.redis.rpush(listKey, logEntry.id);\n                yield this.redis.expire(listKey, types_1.TTL.LOG_LIST);\n            }\n            // Publish to pub/sub channels\n            const logJson = JSON.stringify(logEntry);\n            // Publish to generation channel\n            if (params.generationId) {\n                yield this.redis.publish(types_1.RedisKeys.logChannel(params.generationId), logJson);\n            }\n            // Publish to conversation channel\n            if (params.conversationId) {\n                yield this.redis.publish(types_1.RedisKeys.conversationLogChannel(params.conversationId), logJson);\n            }\n            // Publish to all logs channel\n            yield this.redis.publish(types_1.RedisKeys.allLogsChannel, logJson);\n        });\n    }\n    /**\n     * Log thinking/reasoning separately from responses\n     */\n    logThought(params) {\n        return __awaiter(this, void 0, void 0, function* () {\n            yield this.log({\n                level: 'debug',\n                category: 'thought',\n                message: `<dim>💭 ${params.source} thinking:</dim>\\n${params.content}`,\n                generationId: params.generationId,\n                conversationId: params.conversationId,\n                metadata: Object.assign({ source: params.source }, params.metadata),\n            });\n        });\n    }\n    /**\n     * Get all logs for a generation\n     */\n    getGenerationLogs(generationId) {\n        return __awaiter(this, void 0, void 0, function* () {\n            const listKey = types_1.RedisKeys.generationLogs(generationId);\n            const logIds = yield this.redis.lrange(listKey, 0, -1);\n            const logs = [];\n            for (const logId of logIds) {\n                const logJson = yield this.redis.get(types_1.RedisKeys.log(logId));\n                if (logJson) {\n                    logs.push(JSON.parse(logJson));\n                }\n            }\n            return logs;\n        });\n    }\n    /**\n     * Get all logs for a conversation\n     */\n    getConversationLogs(conversationId, limit) {\n        return __awaiter(this, void 0, void 0, function* () {\n            const listKey = types_1.RedisKeys.conversationLogs(conversationId);\n            const logIds = yield this.redis.lrange(listKey, limit ? -limit : 0, -1);\n            const logs = [];\n            for (const logId of logIds) {\n                const logJson = yield this.redis.get(types_1.RedisKeys.log(logId));\n                if (logJson) {\n                    logs.push(JSON.parse(logJson));\n                }\n            }\n            return logs;\n        });\n    }\n    /**\n     * Get generation data\n     */\n    getGeneration(generationId) {\n        return __awaiter(this, void 0, void 0, function* () {\n            const genJson = yield this.redis.get(types_1.RedisKeys.generation(generationId));\n            return genJson ? JSON.parse(genJson) : null;\n        });\n    }\n    /**\n     * Get conversation generation state\n     */\n    getConversationGenerationState(conversationId) {\n        return __awaiter(this, void 0, void 0, function* () {\n            const stateJson = yield this.redis.get(types_1.RedisKeys.conversationGeneration(conversationId));\n            return stateJson ? JSON.parse(stateJson) : null;\n        });\n    }\n    /**\n     * Subscribe to logs for a generation (real-time streaming)\n     */\n    subscribeToGeneration(generationId) {\n        return __asyncGenerator(this, arguments, function* subscribeToGeneration_1() {\n            const subscriber = this.redis.duplicate();\n            subscriber.setMaxListeners(100);\n            const channel = types_1.RedisKeys.logChannel(generationId);\n            try {\n                yield __await(subscriber.subscribe(channel));\n                // Yield existing logs first\n                const existingLogs = yield __await(this.getGenerationLogs(generationId));\n                for (const log of existingLogs) {\n                    yield yield __await(log);\n                }\n                // Then stream new logs\n                while (true) {\n                    const message = yield __await(new Promise((resolve) => {\n                        subscriber.once('message', (ch, msg) => {\n                            if (ch === channel)\n                                resolve(msg);\n                        });\n                        // Timeout after 30 seconds\n                        setTimeout(() => resolve(null), 30000);\n                    }));\n                    if (message === null) {\n                        // Check if generation is complete\n                        const gen = yield __await(this.getGeneration(generationId));\n                        if (!gen || gen.status !== 'generating') {\n                            break;\n                        }\n                        continue;\n                    }\n                    const logEntry = JSON.parse(message);\n                    yield yield __await(logEntry);\n                    // Break if generation complete/error log\n                    if (logEntry.category === 'generation' &&\n                        (logEntry.message.includes('completed') || logEntry.message.includes('failed'))) {\n                        break;\n                    }\n                }\n            }\n            finally {\n                yield __await(subscriber.unsubscribe(channel));\n                yield __await(subscriber.quit());\n            }\n        });\n    }\n    /**\n     * Subscribe to all logs for a conversation (real-time streaming)\n     */\n    subscribeToConversation(conversationId) {\n        return __asyncGenerator(this, arguments, function* subscribeToConversation_1() {\n            const subscriber = this.redis.duplicate();\n            subscriber.setMaxListeners(100);\n            const channel = types_1.RedisKeys.conversationLogChannel(conversationId);\n            try {\n                yield __await(subscriber.subscribe(channel));\n                while (true) {\n                    const message = yield __await(new Promise((resolve) => {\n                        subscriber.once('message', (ch, msg) => {\n                            if (ch === channel)\n                                resolve(msg);\n                        });\n                        // Timeout after 60 seconds\n                        setTimeout(() => resolve(null), 60000);\n                    }));\n                    if (message === null) {\n                        continue; // Keep alive\n                    }\n                    const logEntry = JSON.parse(message);\n                    yield yield __await(logEntry);\n                }\n            }\n            finally {\n                yield __await(subscriber.unsubscribe(channel));\n                yield __await(subscriber.quit());\n            }\n        });\n    }\n}\nexports.Logger = Logger;\n"],"names":[],"mappings":"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","ignoreList":[0],"debugId":null}},
    {"offset": {"line": 2414, "column": 0}, "map": {"version":3,"sources":["file:///home/alpha/code/%40redbtn/webapp/node_modules/%40redbtn/ai/dist/lib/models.js"],"sourcesContent":["\"use strict\";\n// /lib/models.ts\nObject.defineProperty(exports, \"__esModule\", { value: true });\nexports.createLocalModel = createLocalModel;\nexports.createOpenAIModel = createOpenAIModel;\nexports.createGeminiModel = createGeminiModel;\nconst ollama_1 = require(\"@langchain/ollama\");\nconst openai_1 = require(\"@langchain/openai\");\nconst google_genai_1 = require(\"@langchain/google-genai\");\n/**\n * Creates a fast chat model instance based on the provided configuration.\n * Supports DeepSeek-R1 and other Ollama models.\n * @param config The Red configuration object.\n * @returns A configured instance of ChatOllama.\n */\nfunction createLocalModel(config) {\n    // Allow model override via environment variable\n    const modelName = process.env.OLLAMA_MODEL || \"Red\";\n    return new ollama_1.ChatOllama({\n        baseUrl: config.defaultLlmUrl ||\n            process.env.OLLAMA_BASE_URL ||\n            \"http://localhost:11434\", // Use the URL from the config\n        model: modelName,\n        temperature: 0.0,\n        // NOTE: DeepSeek-R1 reasoning models can take 2-5 minutes to respond\n        // If using remote Ollama (llm.redbtn.io), ensure reverse proxy timeout is set to at least 300s\n        // Example nginx config: proxy_read_timeout 300s;\n    });\n}\nfunction createOpenAIModel() {\n    return new openai_1.ChatOpenAI({\n        modelName: \"gpt-5\",\n        temperature: 0.0,\n        streaming: true,\n        openAIApiKey: process.env.OPENAI_API_KEY,\n    });\n}\n/**\n * Creates a Gemini chat model instance.\n * @returns A configured instance of ChatGoogleGenerativeAI.\n */\nfunction createGeminiModel() {\n    return new google_genai_1.ChatGoogleGenerativeAI({\n        model: \"gemini-2.5-pro\",\n        temperature: 0.0,\n        streaming: true,\n        apiKey: process.env.GOOGLE_API_KEY,\n    });\n}\n"],"names":[],"mappings":"AACA,iBAAiB;AACjB,OAAO,cAAc,CAAC,SAAS,cAAc;IAAE,OAAO;AAAK;AAC3D,QAAQ,gBAAgB,GAAG;AAC3B,QAAQ,iBAAiB,GAAG;AAC5B,QAAQ,iBAAiB,GAAG;AAC5B,MAAM;AACN,MAAM;AACN,MAAM;AACN;;;;;CAKC,GACD,SAAS,iBAAiB,MAAM;IAC5B,gDAAgD;IAChD,MAAM,YAAY,QAAQ,GAAG,CAAC,YAAY,IAAI;IAC9C,OAAO,IAAI,SAAS,UAAU,CAAC;QAC3B,SAAS,OAAO,aAAa,IACzB,QAAQ,GAAG,CAAC,eAAe,IAC3B;QACJ,OAAO;QACP,aAAa;IAIjB;AACJ;AACA,SAAS;IACL,OAAO,IAAI,SAAS,UAAU,CAAC;QAC3B,WAAW;QACX,aAAa;QACb,WAAW;QACX,cAAc,QAAQ,GAAG,CAAC,cAAc;IAC5C;AACJ;AACA;;;CAGC,GACD,SAAS;IACL,OAAO,IAAI,eAAe,sBAAsB,CAAC;QAC7C,OAAO;QACP,aAAa;QACb,WAAW;QACX,QAAQ,QAAQ,GAAG,CAAC,cAAc;IACtC;AACJ","ignoreList":[0],"debugId":null}},
    {"offset": {"line": 2461, "column": 0}, "map": {"version":3,"sources":["file:///home/alpha/code/%40redbtn/webapp/node_modules/%40redbtn/ai/dist/functions/background/summarization.js"],"sourcesContent":["\"use strict\";\n/**\n * Background summarization utilities\n */\nvar __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {\n    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }\n    return new (P || (P = Promise))(function (resolve, reject) {\n        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }\n        function rejected(value) { try { step(generator[\"throw\"](value)); } catch (e) { reject(e); } }\n        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }\n        step((generator = generator.apply(thisArg, _arguments || [])).next());\n    });\n};\nObject.defineProperty(exports, \"__esModule\", { value: true });\nexports.summarizeInBackground = summarizeInBackground;\nexports.generateExecutiveSummaryInBackground = generateExecutiveSummaryInBackground;\n/**\n * Trigger summarization in background (non-blocking)\n */\nfunction summarizeInBackground(conversationId, memory, localModel) {\n    memory.summarizeIfNeeded(conversationId, (prompt) => __awaiter(this, void 0, void 0, function* () {\n        const response = yield localModel.invoke([{ role: 'user', content: prompt }]);\n        return response.content;\n    })).catch(err => console.error('[Red] Summarization failed:', err));\n}\n/**\n * Generate executive summary in background (non-blocking)\n * Called after 3rd+ AI response\n */\nfunction generateExecutiveSummaryInBackground(conversationId, memory, localModel) {\n    memory.generateExecutiveSummary(conversationId, (prompt) => __awaiter(this, void 0, void 0, function* () {\n        const response = yield localModel.invoke([{ role: 'user', content: prompt }]);\n        return response.content;\n    })).catch(err => console.error('[Red] Executive summary generation failed:', err));\n}\n"],"names":[],"mappings":"AACA;;CAEC,GACD,IAAI,YAAY,4DAAS,yDAAK,SAAS,IAAK,SAAU,OAAO,EAAE,UAAU,EAAE,CAAC,EAAE,SAAS;IACnF,SAAS,MAAM,KAAK;QAAI,OAAO,iBAAiB,IAAI,QAAQ,IAAI,EAAE,SAAU,OAAO;YAAI,QAAQ;QAAQ;IAAI;IAC3G,OAAO,IAAI,CAAC,KAAK,CAAC,IAAI,OAAO,CAAC,EAAE,SAAU,OAAO,EAAE,MAAM;QACrD,SAAS,UAAU,KAAK;YAAI,IAAI;gBAAE,KAAK,UAAU,IAAI,CAAC;YAAS,EAAE,OAAO,GAAG;gBAAE,OAAO;YAAI;QAAE;QAC1F,SAAS,SAAS,KAAK;YAAI,IAAI;gBAAE,KAAK,SAAS,CAAC,QAAQ,CAAC;YAAS,EAAE,OAAO,GAAG;gBAAE,OAAO;YAAI;QAAE;QAC7F,SAAS,KAAK,MAAM;YAAI,OAAO,IAAI,GAAG,QAAQ,OAAO,KAAK,IAAI,MAAM,OAAO,KAAK,EAAE,IAAI,CAAC,WAAW;QAAW;QAC7G,KAAK,CAAC,YAAY,UAAU,KAAK,CAAC,SAAS,cAAc,EAAE,CAAC,EAAE,IAAI;IACtE;AACJ;AACA,OAAO,cAAc,CAAC,SAAS,cAAc;IAAE,OAAO;AAAK;AAC3D,QAAQ,qBAAqB,GAAG;AAChC,QAAQ,oCAAoC,GAAG;AAC/C;;CAEC,GACD,SAAS,sBAAsB,cAAc,EAAE,MAAM,EAAE,UAAU;IAC7D,OAAO,iBAAiB,CAAC,gBAAgB,CAAC,SAAW,UAAU,IAAI,EAAE,KAAK,GAAG,KAAK,GAAG;YACjF,MAAM,WAAW,MAAM,WAAW,MAAM,CAAC;gBAAC;oBAAE,MAAM;oBAAQ,SAAS;gBAAO;aAAE;YAC5E,OAAO,SAAS,OAAO;QAC3B,IAAI,KAAK,CAAC,CAAA,MAAO,QAAQ,KAAK,CAAC,+BAA+B;AAClE;AACA;;;CAGC,GACD,SAAS,qCAAqC,cAAc,EAAE,MAAM,EAAE,UAAU;IAC5E,OAAO,wBAAwB,CAAC,gBAAgB,CAAC,SAAW,UAAU,IAAI,EAAE,KAAK,GAAG,KAAK,GAAG;YACxF,MAAM,WAAW,MAAM,WAAW,MAAM,CAAC;gBAAC;oBAAE,MAAM;oBAAQ,SAAS;gBAAO;aAAE;YAC5E,OAAO,SAAS,OAAO;QAC3B,IAAI,KAAK,CAAC,CAAA,MAAO,QAAQ,KAAK,CAAC,8CAA8C;AACjF","ignoreList":[0],"debugId":null}},
    {"offset": {"line": 2526, "column": 0}, "map": {"version":3,"sources":["file:///home/alpha/code/%40redbtn/webapp/node_modules/%40redbtn/ai/dist/functions/background/title.js"],"sourcesContent":["\"use strict\";\n/**\n * Background title generation utilities\n */\nvar __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {\n    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }\n    return new (P || (P = Promise))(function (resolve, reject) {\n        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }\n        function rejected(value) { try { step(generator[\"throw\"](value)); } catch (e) { reject(e); } }\n        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }\n        step((generator = generator.apply(thisArg, _arguments || [])).next());\n    });\n};\nObject.defineProperty(exports, \"__esModule\", { value: true });\nexports.generateTitleInBackground = generateTitleInBackground;\nexports.setConversationTitle = setConversationTitle;\nexports.getConversationTitle = getConversationTitle;\n/**\n * Generate a title for the conversation based on the first few messages\n * Runs after 2nd message (initial title) and 6th message (refined title)\n */\nfunction generateTitleInBackground(conversationId, messageCount, memory, localModel) {\n    return __awaiter(this, void 0, void 0, function* () {\n        try {\n            // Only generate title after 2nd or 6th message\n            if (messageCount !== 2 && messageCount !== 6) {\n                return;\n            }\n            // Check if title was manually set by user\n            const metadata = yield memory.getMetadata(conversationId);\n            if (metadata === null || metadata === void 0 ? void 0 : metadata.titleSetByUser) {\n                return; // Don't override user-set titles after 6th message\n            }\n            // Get recent messages for context\n            const messages = yield memory.getMessages(conversationId);\n            const conversationText = messages\n                .slice(0, Math.min(6, messages.length)) // Use first 6 messages max\n                .map(m => `${m.role.toUpperCase()}: ${m.content}`)\n                .join('\\n');\n            // Create prompt for title generation\n            const titlePrompt = `Based on this conversation, generate a short, descriptive title (3-6 words max). Only respond with the title, nothing else:\n\n${conversationText}`;\n            // Generate title using LLM\n            const response = yield localModel.invoke([{ role: 'user', content: titlePrompt }]);\n            const title = response.content.trim().replace(/^[\"']|[\"']$/g, ''); // Remove quotes if any\n            // Store title in metadata\n            const metaKey = `conversation:${conversationId}:metadata`;\n            yield memory['redis'].hset(metaKey, 'title', title);\n            console.log(`[Red] Generated title for ${conversationId}: \"${title}\"`);\n        }\n        catch (err) {\n            console.error('[Red] Title generation failed:', err);\n        }\n    });\n}\n/**\n * Set a custom title for a conversation (set by user)\n * This prevents automatic title generation from overwriting it\n */\nfunction setConversationTitle(conversationId, title, memory) {\n    return __awaiter(this, void 0, void 0, function* () {\n        const metaKey = `conversation:${conversationId}:metadata`;\n        yield memory['redis'].hset(metaKey, {\n            'title': title,\n            'titleSetByUser': 'true'\n        });\n        console.log(`[Red] User set title for ${conversationId}: \"${title}\"`);\n    });\n}\n/**\n * Get the title for a conversation\n */\nfunction getConversationTitle(conversationId, memory) {\n    return __awaiter(this, void 0, void 0, function* () {\n        const metadata = yield memory.getMetadata(conversationId);\n        return (metadata === null || metadata === void 0 ? void 0 : metadata.title) || null;\n    });\n}\n"],"names":[],"mappings":"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","ignoreList":[0],"debugId":null}},
    {"offset": {"line": 2626, "column": 0}, "map": {"version":3,"sources":["file:///home/alpha/code/%40redbtn/webapp/node_modules/%40redbtn/ai/dist/functions/background/heartbeat.js"],"sourcesContent":["\"use strict\";\n/**\n * Node heartbeat utilities for distributed system monitoring\n */\nvar __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {\n    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }\n    return new (P || (P = Promise))(function (resolve, reject) {\n        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }\n        function rejected(value) { try { step(generator[\"throw\"](value)); } catch (e) { reject(e); } }\n        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }\n        step((generator = generator.apply(thisArg, _arguments || [])).next());\n    });\n};\nObject.defineProperty(exports, \"__esModule\", { value: true });\nexports.startHeartbeat = startHeartbeat;\nexports.sendHeartbeat = sendHeartbeat;\nexports.stopHeartbeat = stopHeartbeat;\nexports.getActiveNodes = getActiveNodes;\n/**\n * Starts the heartbeat mechanism to register this node as active in Redis.\n * Heartbeat runs every 10 seconds with a 20-second TTL.\n */\nfunction startHeartbeat(nodeId, redis) {\n    if (!nodeId) {\n        console.warn('[Heartbeat] No nodeId set, skipping heartbeat');\n        throw new Error('nodeId is required for heartbeat');\n    }\n    // Initial heartbeat\n    sendHeartbeat(nodeId, redis);\n    // Set up interval for continuous heartbeats\n    const interval = setInterval(() => {\n        sendHeartbeat(nodeId, redis);\n    }, 10000); // Every 10 seconds\n    console.log(`[Heartbeat] Started for node: ${nodeId}`);\n    return interval;\n}\n/**\n * Sends a heartbeat signal to Redis, adding the node to the active set.\n */\nfunction sendHeartbeat(nodeId, redis) {\n    return __awaiter(this, void 0, void 0, function* () {\n        if (!nodeId)\n            return;\n        try {\n            const key = `nodes:active:${nodeId}`;\n            const timestamp = Date.now();\n            // Set key with value as timestamp and 20-second TTL\n            yield redis.setex(key, 20, timestamp.toString());\n        }\n        catch (error) {\n            console.error('[Heartbeat] Failed to send heartbeat:', error);\n        }\n    });\n}\n/**\n * Stops the heartbeat mechanism and removes the node from active set.\n */\nfunction stopHeartbeat(nodeId, redis, interval) {\n    return __awaiter(this, void 0, void 0, function* () {\n        if (interval) {\n            clearInterval(interval);\n        }\n        if (nodeId) {\n            try {\n                // Remove node from active set\n                const key = `nodes:active:${nodeId}`;\n                yield redis.del(key);\n                console.log(`[Heartbeat] Stopped for node: ${nodeId}`);\n            }\n            catch (error) {\n                console.error('[Heartbeat] Failed to cleanup on stop:', error);\n            }\n        }\n    });\n}\n/**\n * Gets a list of all currently active nodes.\n * @returns Array of active node IDs\n */\nfunction getActiveNodes(redis) {\n    return __awaiter(this, void 0, void 0, function* () {\n        try {\n            // Scan for all keys matching nodes:active:*\n            const keys = yield redis.keys('nodes:active:*');\n            // Extract nodeId from keys (nodes:active:nodeId)\n            return keys.map((key) => key.replace('nodes:active:', ''));\n        }\n        catch (error) {\n            console.error('[Heartbeat] Failed to get active nodes:', error);\n            return [];\n        }\n    });\n}\n"],"names":[],"mappings":"AACA;;CAEC,GACD,IAAI,YAAY,4DAAS,yDAAK,SAAS,IAAK,SAAU,OAAO,EAAE,UAAU,EAAE,CAAC,EAAE,SAAS;IACnF,SAAS,MAAM,KAAK;QAAI,OAAO,iBAAiB,IAAI,QAAQ,IAAI,EAAE,SAAU,OAAO;YAAI,QAAQ;QAAQ;IAAI;IAC3G,OAAO,IAAI,CAAC,KAAK,CAAC,IAAI,OAAO,CAAC,EAAE,SAAU,OAAO,EAAE,MAAM;QACrD,SAAS,UAAU,KAAK;YAAI,IAAI;gBAAE,KAAK,UAAU,IAAI,CAAC;YAAS,EAAE,OAAO,GAAG;gBAAE,OAAO;YAAI;QAAE;QAC1F,SAAS,SAAS,KAAK;YAAI,IAAI;gBAAE,KAAK,SAAS,CAAC,QAAQ,CAAC;YAAS,EAAE,OAAO,GAAG;gBAAE,OAAO;YAAI;QAAE;QAC7F,SAAS,KAAK,MAAM;YAAI,OAAO,IAAI,GAAG,QAAQ,OAAO,KAAK,IAAI,MAAM,OAAO,KAAK,EAAE,IAAI,CAAC,WAAW;QAAW;QAC7G,KAAK,CAAC,YAAY,UAAU,KAAK,CAAC,SAAS,cAAc,EAAE,CAAC,EAAE,IAAI;IACtE;AACJ;AACA,OAAO,cAAc,CAAC,SAAS,cAAc;IAAE,OAAO;AAAK;AAC3D,QAAQ,cAAc,GAAG;AACzB,QAAQ,aAAa,GAAG;AACxB,QAAQ,aAAa,GAAG;AACxB,QAAQ,cAAc,GAAG;AACzB;;;CAGC,GACD,SAAS,eAAe,MAAM,EAAE,KAAK;IACjC,IAAI,CAAC,QAAQ;QACT,QAAQ,IAAI,CAAC;QACb,MAAM,IAAI,MAAM;IACpB;IACA,oBAAoB;IACpB,cAAc,QAAQ;IACtB,4CAA4C;IAC5C,MAAM,WAAW,YAAY;QACzB,cAAc,QAAQ;IAC1B,GAAG,QAAQ,mBAAmB;IAC9B,QAAQ,GAAG,CAAC,CAAC,8BAA8B,EAAE,QAAQ;IACrD,OAAO;AACX;AACA;;CAEC,GACD,SAAS,cAAc,MAAM,EAAE,KAAK;IAChC,OAAO,UAAU,IAAI,EAAE,KAAK,GAAG,KAAK,GAAG;QACnC,IAAI,CAAC,QACD;QACJ,IAAI;YACA,MAAM,MAAM,CAAC,aAAa,EAAE,QAAQ;YACpC,MAAM,YAAY,KAAK,GAAG;YAC1B,oDAAoD;YACpD,MAAM,MAAM,KAAK,CAAC,KAAK,IAAI,UAAU,QAAQ;QACjD,EACA,OAAO,OAAO;YACV,QAAQ,KAAK,CAAC,yCAAyC;QAC3D;IACJ;AACJ;AACA;;CAEC,GACD,SAAS,cAAc,MAAM,EAAE,KAAK,EAAE,QAAQ;IAC1C,OAAO,UAAU,IAAI,EAAE,KAAK,GAAG,KAAK,GAAG;QACnC,IAAI,UAAU;YACV,cAAc;QAClB;QACA,IAAI,QAAQ;YACR,IAAI;gBACA,8BAA8B;gBAC9B,MAAM,MAAM,CAAC,aAAa,EAAE,QAAQ;gBACpC,MAAM,MAAM,GAAG,CAAC;gBAChB,QAAQ,GAAG,CAAC,CAAC,8BAA8B,EAAE,QAAQ;YACzD,EACA,OAAO,OAAO;gBACV,QAAQ,KAAK,CAAC,0CAA0C;YAC5D;QACJ;IACJ;AACJ;AACA;;;CAGC,GACD,SAAS,eAAe,KAAK;IACzB,OAAO,UAAU,IAAI,EAAE,KAAK,GAAG,KAAK,GAAG;QACnC,IAAI;YACA,4CAA4C;YAC5C,MAAM,OAAO,MAAM,MAAM,IAAI,CAAC;YAC9B,iDAAiD;YACjD,OAAO,KAAK,GAAG,CAAC,CAAC,MAAQ,IAAI,OAAO,CAAC,iBAAiB;QAC1D,EACA,OAAO,OAAO;YACV,QAAQ,KAAK,CAAC,2CAA2C;YACzD,OAAO,EAAE;QACb;IACJ;AACJ","ignoreList":[0],"debugId":null}},
    {"offset": {"line": 2733, "column": 0}, "map": {"version":3,"sources":["file:///home/alpha/code/%40redbtn/webapp/node_modules/%40redbtn/ai/dist/functions/background/index.js"],"sourcesContent":["\"use strict\";\n/**\n * Background process utilities\n * Re-exports all background processing functions\n */\nvar __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {\n    if (k2 === undefined) k2 = k;\n    var desc = Object.getOwnPropertyDescriptor(m, k);\n    if (!desc || (\"get\" in desc ? !m.__esModule : desc.writable || desc.configurable)) {\n      desc = { enumerable: true, get: function() { return m[k]; } };\n    }\n    Object.defineProperty(o, k2, desc);\n}) : (function(o, m, k, k2) {\n    if (k2 === undefined) k2 = k;\n    o[k2] = m[k];\n}));\nvar __exportStar = (this && this.__exportStar) || function(m, exports) {\n    for (var p in m) if (p !== \"default\" && !Object.prototype.hasOwnProperty.call(exports, p)) __createBinding(exports, m, p);\n};\nObject.defineProperty(exports, \"__esModule\", { value: true });\n__exportStar(require(\"./summarization\"), exports);\n__exportStar(require(\"./title\"), exports);\n__exportStar(require(\"./heartbeat\"), exports);\n"],"names":[],"mappings":"AACA;;;CAGC,GACD,IAAI,kBAAkB,4DAAS,yDAAK,eAAe,IAAK,CAAC,OAAO,MAAM,GAAI,SAAS,CAAC,EAAE,CAAC,EAAE,CAAC,EAAE,EAAE;IAC1F,IAAI,OAAO,WAAW,KAAK;IAC3B,IAAI,OAAO,OAAO,wBAAwB,CAAC,GAAG;IAC9C,IAAI,CAAC,QAAQ,CAAC,SAAS,OAAO,CAAC,EAAE,UAAU,GAAG,KAAK,QAAQ,IAAI,KAAK,YAAY,GAAG;QACjF,OAAO;YAAE,YAAY;YAAM,KAAK;gBAAa,OAAO,CAAC,CAAC,EAAE;YAAE;QAAE;IAC9D;IACA,OAAO,cAAc,CAAC,GAAG,IAAI;AACjC,IAAM,SAAS,CAAC,EAAE,CAAC,EAAE,CAAC,EAAE,EAAE;IACtB,IAAI,OAAO,WAAW,KAAK;IAC3B,CAAC,CAAC,GAAG,GAAG,CAAC,CAAC,EAAE;AAChB,CAAE;AACF,IAAI,eAAe,4DAAS,yDAAK,YAAY,IAAK,SAAS,CAAC,EAAE,QAAO;IACjE,IAAK,IAAI,KAAK,EAAG,IAAI,MAAM,aAAa,CAAC,OAAO,SAAS,CAAC,cAAc,CAAC,IAAI,CAAC,UAAS,IAAI,gBAAgB,UAAS,GAAG;AAC3H;AACA,OAAO,cAAc,CAAC,SAAS,cAAc;IAAE,OAAO;AAAK;AAC3D,+IAAyC;AACzC,uIAAiC;AACjC,2IAAqC","ignoreList":[0],"debugId":null}},
    {"offset": {"line": 2765, "column": 0}, "map": {"version":3,"sources":["file:///home/alpha/code/%40redbtn/webapp/node_modules/%40redbtn/ai/dist/lib/utils/thinking.js"],"sourcesContent":["\"use strict\";\n/**\n * Utility functions for extracting and logging reasoning/thinking from LLM responses\n * Works with any model - thinking models (DeepSeek-R1) and non-thinking models (qwen, GPT)\n */\nObject.defineProperty(exports, \"__esModule\", { value: true });\nexports.extractThinking = extractThinking;\nexports.logThinking = logThinking;\nexports.extractAndLogThinking = extractAndLogThinking;\n/**\n * Extracts thinking content from DeepSeek-R1 style <think>...</think> tags\n * Safe for all models - returns original content if no thinking tags found\n * @param content The full content from the LLM response\n * @returns Object with thinking (if any) and cleaned content\n */\nfunction extractThinking(content) {\n    if (!content || typeof content !== 'string') {\n        return { thinking: null, cleanedContent: content || '' };\n    }\n    // Match <think>...</think> tags (case insensitive, multiline)\n    const thinkRegex = /<think>([\\s\\S]*?)<\\/think>/gi;\n    const matches = [...content.matchAll(thinkRegex)];\n    if (matches.length === 0) {\n        // No thinking tags - return content as-is\n        return { thinking: null, cleanedContent: content };\n    }\n    // Extract all thinking sections\n    const thinkingSections = matches.map(m => m[1].trim());\n    const thinking = thinkingSections.join('\\n\\n---\\n\\n');\n    // Remove thinking tags from content and clean up whitespace\n    let cleanedContent = content.replace(thinkRegex, '');\n    // Remove leading/trailing whitespace and collapse multiple newlines\n    cleanedContent = cleanedContent\n        .trim()\n        .replace(/\\n{3,}/g, '\\n\\n'); // Max 2 consecutive newlines\n    return { thinking, cleanedContent };\n}\n/**\n * Logs thinking to console with nice formatting\n * Only logs if thinking content exists - safe to call with null\n * @param thinking The thinking/reasoning text to log (can be null)\n * @param context Optional context label (e.g., \"Router\", \"Chat\", \"ToolPicker\")\n */\nfunction logThinking(thinking, context = 'LLM') {\n    // Don't log if no thinking content\n    if (!thinking || thinking.trim().length === 0) {\n        return;\n    }\n    const boxWidth = 80;\n    const borderTop = '╔' + '═'.repeat(boxWidth - 2) + '╗';\n    const borderBottom = '╚' + '═'.repeat(boxWidth - 2) + '╝';\n    const header = `💭 ${context} Thinking`;\n    console.log('\\n' + borderTop);\n    console.log('║ ' + header.padEnd(boxWidth - 3) + '║');\n    console.log('╠' + '═'.repeat(boxWidth - 2) + '╣');\n    // Split thinking into lines and wrap to fit in box\n    const lines = thinking.split('\\n');\n    lines.forEach(line => {\n        if (line.length === 0) {\n            console.log('║' + ' '.repeat(boxWidth - 2) + '║');\n            return;\n        }\n        // Word wrap long lines\n        const words = line.split(' ');\n        let currentLine = '';\n        words.forEach(word => {\n            if ((currentLine + ' ' + word).length > boxWidth - 6) {\n                // Print current line and start new one\n                console.log('║ ' + currentLine.padEnd(boxWidth - 3) + '║');\n                currentLine = word;\n            }\n            else {\n                currentLine = currentLine ? currentLine + ' ' + word : word;\n            }\n        });\n        // Print remaining text\n        if (currentLine) {\n            console.log('║ ' + currentLine.padEnd(boxWidth - 3) + '║');\n        }\n    });\n    console.log(borderBottom + '\\n');\n}\n/**\n * Extracts and logs thinking from content in one call\n * Returns the cleaned content\n * @param content The full content from the LLM response\n * @param context Optional context label\n * @returns The cleaned content (without thinking tags)\n */\nfunction extractAndLogThinking(content, context = 'LLM') {\n    const { thinking, cleanedContent } = extractThinking(content);\n    if (thinking) {\n        logThinking(thinking, context);\n    }\n    return cleanedContent;\n}\n"],"names":[],"mappings":"AACA;;;CAGC,GACD,OAAO,cAAc,CAAC,SAAS,cAAc;IAAE,OAAO;AAAK;AAC3D,QAAQ,eAAe,GAAG;AAC1B,QAAQ,WAAW,GAAG;AACtB,QAAQ,qBAAqB,GAAG;AAChC;;;;;CAKC,GACD,SAAS,gBAAgB,OAAO;IAC5B,IAAI,CAAC,WAAW,OAAO,YAAY,UAAU;QACzC,OAAO;YAAE,UAAU;YAAM,gBAAgB,WAAW;QAAG;IAC3D;IACA,8DAA8D;IAC9D,MAAM,aAAa;IACnB,MAAM,UAAU;WAAI,QAAQ,QAAQ,CAAC;KAAY;IACjD,IAAI,QAAQ,MAAM,KAAK,GAAG;QACtB,0CAA0C;QAC1C,OAAO;YAAE,UAAU;YAAM,gBAAgB;QAAQ;IACrD;IACA,gCAAgC;IAChC,MAAM,mBAAmB,QAAQ,GAAG,CAAC,CAAA,IAAK,CAAC,CAAC,EAAE,CAAC,IAAI;IACnD,MAAM,WAAW,iBAAiB,IAAI,CAAC;IACvC,4DAA4D;IAC5D,IAAI,iBAAiB,QAAQ,OAAO,CAAC,YAAY;IACjD,oEAAoE;IACpE,iBAAiB,eACZ,IAAI,GACJ,OAAO,CAAC,WAAW,SAAS,6BAA6B;IAC9D,OAAO;QAAE;QAAU;IAAe;AACtC;AACA;;;;;CAKC,GACD,SAAS,YAAY,QAAQ,EAAE,UAAU,KAAK;IAC1C,mCAAmC;IACnC,IAAI,CAAC,YAAY,SAAS,IAAI,GAAG,MAAM,KAAK,GAAG;QAC3C;IACJ;IACA,MAAM,WAAW;IACjB,MAAM,YAAY,MAAM,IAAI,MAAM,CAAC,WAAW,KAAK;IACnD,MAAM,eAAe,MAAM,IAAI,MAAM,CAAC,WAAW,KAAK;IACtD,MAAM,SAAS,CAAC,GAAG,EAAE,QAAQ,SAAS,CAAC;IACvC,QAAQ,GAAG,CAAC,OAAO;IACnB,QAAQ,GAAG,CAAC,OAAO,OAAO,MAAM,CAAC,WAAW,KAAK;IACjD,QAAQ,GAAG,CAAC,MAAM,IAAI,MAAM,CAAC,WAAW,KAAK;IAC7C,mDAAmD;IACnD,MAAM,QAAQ,SAAS,KAAK,CAAC;IAC7B,MAAM,OAAO,CAAC,CAAA;QACV,IAAI,KAAK,MAAM,KAAK,GAAG;YACnB,QAAQ,GAAG,CAAC,MAAM,IAAI,MAAM,CAAC,WAAW,KAAK;YAC7C;QACJ;QACA,uBAAuB;QACvB,MAAM,QAAQ,KAAK,KAAK,CAAC;QACzB,IAAI,cAAc;QAClB,MAAM,OAAO,CAAC,CAAA;YACV,IAAI,CAAC,cAAc,MAAM,IAAI,EAAE,MAAM,GAAG,WAAW,GAAG;gBAClD,uCAAuC;gBACvC,QAAQ,GAAG,CAAC,OAAO,YAAY,MAAM,CAAC,WAAW,KAAK;gBACtD,cAAc;YAClB,OACK;gBACD,cAAc,cAAc,cAAc,MAAM,OAAO;YAC3D;QACJ;QACA,uBAAuB;QACvB,IAAI,aAAa;YACb,QAAQ,GAAG,CAAC,OAAO,YAAY,MAAM,CAAC,WAAW,KAAK;QAC1D;IACJ;IACA,QAAQ,GAAG,CAAC,eAAe;AAC/B;AACA;;;;;;CAMC,GACD,SAAS,sBAAsB,OAAO,EAAE,UAAU,KAAK;IACnD,MAAM,EAAE,QAAQ,EAAE,cAAc,EAAE,GAAG,gBAAgB;IACrD,IAAI,UAAU;QACV,YAAY,UAAU;IAC1B;IACA,OAAO;AACX","ignoreList":[0],"debugId":null}},
    {"offset": {"line": 2870, "column": 0}, "map": {"version":3,"sources":["file:///home/alpha/code/%40redbtn/webapp/node_modules/%40redbtn/ai/dist/lib/nodes/router.js"],"sourcesContent":["\"use strict\";\nvar __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {\n    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }\n    return new (P || (P = Promise))(function (resolve, reject) {\n        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }\n        function rejected(value) { try { step(generator[\"throw\"](value)); } catch (e) { reject(e); } }\n        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }\n        step((generator = generator.apply(thisArg, _arguments || [])).next());\n    });\n};\nObject.defineProperty(exports, \"__esModule\", { value: true });\nexports.routerNode = void 0;\nconst thinking_1 = require(\"../utils/thinking\");\n/**\n * The first node in redGraph, acting as an intelligent router.\n * Analyzes the user query with conversation context to determine the next action:\n * - web_search: Query needs current information from the internet\n * - scrape_url: User provided a specific URL to scrape\n * - system_command: User wants to execute a system command\n * - chat: Query can be answered directly without external tools\n *\n * @param state The current state of the graph.\n * @returns A partial state object indicating the next step.\n */\nconst routerNode = (state) => __awaiter(void 0, void 0, void 0, function* () {\n    var _a, _b, _c, _d;\n    const query = ((_a = state.messages[state.messages.length - 1]) === null || _a === void 0 ? void 0 : _a.content) || ((_b = state.query) === null || _b === void 0 ? void 0 : _b.message) || '';\n    const redInstance = state.redInstance;\n    const conversationId = (_c = state.options) === null || _c === void 0 ? void 0 : _c.conversationId;\n    const generationId = (_d = state.options) === null || _d === void 0 ? void 0 : _d.generationId;\n    // Log router start\n    yield redInstance.logger.log({\n        level: 'info',\n        category: 'router',\n        message: `<cyan>🧭 Analyzing query:</cyan> <dim>${query.substring(0, 80)}${query.length > 80 ? '...' : ''}</dim>`,\n        generationId,\n        conversationId,\n    });\n    // Get executive summary for context (if exists)\n    let contextSummary = '';\n    if (conversationId) {\n        const summary = yield redInstance.memory.getExecutiveSummary(conversationId);\n        if (summary) {\n            contextSummary = `\\n\\nConversation Context: ${summary}`;\n        }\n    }\n    try {\n        const currentDate = new Date().toLocaleDateString('en-US', {\n            weekday: 'long',\n            year: 'numeric',\n            month: 'long',\n            day: 'numeric'\n        });\n        const routingDecision = yield redInstance.localModel.invoke([\n            {\n                role: 'system',\n                content: `You are a routing cognition node for an Artificial Intelligence named Red.\n\n          TODAY'S DATE: ${currentDate}\n\n          ${contextSummary ? `CONVERSATION SUMMARY: ${contextSummary}` : ''}`\n            },\n            {\n                role: 'user',\n                content: `Analyze the user's message and classify it into ONE category.\n\nCategories:\n- WEB_SEARCH = needs current/recent information from the internet\n- SCRAPE_URL = user provided a specific URL to read\n- SYSTEM_COMMAND = user wants to execute a system command  \n- CHAT = everything else (greetings, questions, general knowledge)\n\nYour response MUST be EXACTLY one of these formats:\n- WEB_SEARCH\n- SCRAPE_URL: [url]\n- SYSTEM_COMMAND: [command]\n- CHAT\n\nUse <think> tags for your reasoning, then give ONLY the category name outside the tags.\n\nUser message: ${query}`\n            }\n        ]);\n        let rawContent = routingDecision.content.toString().trim();\n        // Extract thinking if present (safe for all models - returns original if no thinking)\n        const { thinking, cleanedContent } = (0, thinking_1.extractThinking)(rawContent);\n        // Log thinking to console (for development)\n        (0, thinking_1.logThinking)(thinking, 'Router');\n        // Log thinking to logging system (separate from response)\n        if (thinking && generationId && conversationId) {\n            yield redInstance.logger.logThought({\n                content: thinking,\n                source: 'router',\n                generationId,\n                conversationId,\n            });\n        }\n        // Extract just the routing action from the response\n        // Look for WEB_SEARCH, CHAT, SCRAPE_URL, or SYSTEM_COMMAND\n        // Prioritize patterns with URL/command, then standalone keywords\n        // Also handle variations like \"Web Search:\" or \"web_search\"\n        const routingPatterns = [\n            { pattern: /\\b(SCRAPE_URL:\\s*https?:\\/\\/[^\\s<]+)/i, name: 'SCRAPE_URL_WITH_URL' },\n            { pattern: /\\b(SYSTEM_COMMAND:\\s*[^\\n<]+)/i, name: 'SYSTEM_COMMAND_WITH_CMD' },\n            { pattern: /^(WEB[_\\s-]?SEARCH)\\b/im, name: 'WEB_SEARCH_LINE_START' }, // Matches WEB_SEARCH, WEB SEARCH, etc.\n            { pattern: /\\b(WEB[_\\s-]?SEARCH)\\b/i, name: 'WEB_SEARCH' },\n            { pattern: /^(SCRAPE[_\\s-]?URL)\\b/im, name: 'SCRAPE_URL_LINE_START' },\n            { pattern: /\\b(SCRAPE[_\\s-]?URL)\\b/i, name: 'SCRAPE_URL' },\n            { pattern: /^(SYSTEM[_\\s-]?COMMAND)\\b/im, name: 'SYSTEM_COMMAND_LINE_START' },\n            { pattern: /\\b(SYSTEM[_\\s-]?COMMAND)\\b/i, name: 'SYSTEM_COMMAND' },\n            { pattern: /^(CHAT)\\b/im, name: 'CHAT_LINE_START' },\n            { pattern: /\\b(CHAT)\\b/i, name: 'CHAT' }\n        ];\n        let decision = '';\n        // First try to find pattern in cleaned content (outside thinking tags)\n        for (const { pattern, name } of routingPatterns) {\n            const match = cleanedContent.match(pattern);\n            if (match) {\n                // Normalize to standard format (WEB_SEARCH, not WEB SEARCH)\n                decision = match[1].toUpperCase().replace(/[\\s-]/g, '_').trim();\n                break;\n            }\n        }\n        // If not found in cleaned content, look in thinking\n        if (!decision && thinking) {\n            for (const { pattern, name } of routingPatterns) {\n                const match = thinking.match(pattern);\n                if (match) {\n                    // Normalize to standard format (WEB_SEARCH, not WEB SEARCH)\n                    decision = match[1].toUpperCase().replace(/[\\s-]/g, '_').trim();\n                    break;\n                }\n            }\n        }\n        // Single log showing final routing decision with cleaned answer\n        console.log(`[Router] Decision: ${decision || 'CHAT'} (from ${cleanedContent.substring(0, 50)}${cleanedContent.length > 50 ? '...' : ''})`);\n        if (decision.startsWith('WEB_SEARCH')) {\n            yield redInstance.logger.log({\n                level: 'success',\n                category: 'router',\n                message: `<green>→ Route:</green> <bold>WEB_SEARCH</bold>`,\n                generationId,\n                conversationId,\n                metadata: { decision: 'WEB_SEARCH', nextGraph: 'toolPicker', toolAction: 'web_search' },\n            });\n            return { nextGraph: 'toolPicker', toolAction: 'web_search' };\n        }\n        if (decision.startsWith('SCRAPE_URL')) {\n            const urlMatch = decision.match(/SCRAPE_URL:\\s*(.+)$/i);\n            const url = urlMatch ? urlMatch[1].trim() : '';\n            yield redInstance.logger.log({\n                level: 'success',\n                category: 'router',\n                message: `<green>→ Route:</green> <bold>SCRAPE_URL</bold> <dim>${url}</dim>`,\n                generationId,\n                conversationId,\n                metadata: { decision: 'SCRAPE_URL', url, nextGraph: 'toolPicker', toolAction: 'scrape_url' },\n            });\n            return { nextGraph: 'toolPicker', toolAction: 'scrape_url', toolParam: url };\n        }\n        if (decision.startsWith('SYSTEM_COMMAND')) {\n            const cmdMatch = decision.match(/SYSTEM_COMMAND:\\s*(.+)$/i);\n            const command = cmdMatch ? cmdMatch[1].trim() : '';\n            yield redInstance.logger.log({\n                level: 'success',\n                category: 'router',\n                message: `<green>→ Route:</green> <bold>SYSTEM_COMMAND</bold> <dim>${command}</dim>`,\n                generationId,\n                conversationId,\n                metadata: { decision: 'SYSTEM_COMMAND', command, nextGraph: 'toolPicker', toolAction: 'system_command' },\n            });\n            return { nextGraph: 'toolPicker', toolAction: 'system_command', toolParam: command };\n        }\n        // Default to CHAT\n        yield redInstance.logger.log({\n            level: 'success',\n            category: 'router',\n            message: `<green>→ Route:</green> <bold>CHAT</bold>`,\n            generationId,\n            conversationId,\n            metadata: { decision: 'CHAT', nextGraph: 'chat' },\n        });\n        return { nextGraph: 'chat' };\n    }\n    catch (error) {\n        const errorMessage = error instanceof Error ? error.message : String(error);\n        yield redInstance.logger.log({\n            level: 'error',\n            category: 'router',\n            message: `<red>✗ Router error:</red> ${errorMessage} <dim>(defaulting to CHAT)</dim>`,\n            generationId,\n            conversationId,\n            metadata: { error: errorMessage },\n        });\n        return { nextGraph: 'chat' };\n    }\n});\nexports.routerNode = routerNode;\n"],"names":[],"mappings":"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","ignoreList":[0],"debugId":null}},
    {"offset": {"line": 3153, "column": 0}, "map": {"version":3,"sources":["file:///home/alpha/code/%40redbtn/webapp/node_modules/%40redbtn/ai/dist/lib/nodes/chat.js"],"sourcesContent":["\"use strict\";\nvar __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {\n    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }\n    return new (P || (P = Promise))(function (resolve, reject) {\n        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }\n        function rejected(value) { try { step(generator[\"throw\"](value)); } catch (e) { reject(e); } }\n        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }\n        step((generator = generator.apply(thisArg, _arguments || [])).next());\n    });\n};\nvar __asyncValues = (this && this.__asyncValues) || function (o) {\n    if (!Symbol.asyncIterator) throw new TypeError(\"Symbol.asyncIterator is not defined.\");\n    var m = o[Symbol.asyncIterator], i;\n    return m ? m.call(o) : (o = typeof __values === \"function\" ? __values(o) : o[Symbol.iterator](), i = {}, verb(\"next\"), verb(\"throw\"), verb(\"return\"), i[Symbol.asyncIterator] = function () { return this; }, i);\n    function verb(n) { i[n] = o[n] && function (v) { return new Promise(function (resolve, reject) { v = o[n](v), settle(resolve, reject, v.done, v.value); }); }; }\n    function settle(resolve, reject, d, v) { Promise.resolve(v).then(function(v) { resolve({ value: v, done: d }); }, reject); }\n};\nObject.defineProperty(exports, \"__esModule\", { value: true });\nexports.chatNode = void 0;\nconst messages_1 = require(\"@langchain/core/messages\");\n/**\n * The chat node that processes queries and generates responses.\n * Tools are bound to the model, and tool execution is handled by the toolNode.\n * @param state The current state of the graph.\n * @returns A partial state object with the response and updated messages.\n */\nconst chatNode = (state) => __awaiter(void 0, void 0, void 0, function* () {\n    var _a, e_1, _b, _c;\n    var _d, _e;\n    try {\n        const redInstance = state.redInstance;\n        const query = state.query;\n        const options = state.options || {};\n        const conversationId = options.conversationId;\n        const generationId = options.generationId;\n        // Log chat node start\n        yield redInstance.logger.log({\n            level: 'info',\n            category: 'chat',\n            message: `<cyan>💬 Generating response...</cyan>`,\n            generationId,\n            conversationId,\n        });\n        // Never bind tools in chat node - tools are only executed by toolPicker\n        // This prevents infinite loops where the LLM keeps calling tools\n        const modelWithTools = redInstance.localModel;\n        // Build messages array - start with existing messages from state\n        let messages = [...(state.messages || [])];\n        console.log('[Chat] Initial messages from state:', messages.length);\n        // Check if the user query is already in messages\n        const userQueryAlreadyAdded = messages.some(m => {\n            var _a;\n            return (m.role === 'user' || ((_a = m._getType) === null || _a === void 0 ? void 0 : _a.call(m)) === 'human') &&\n                m.content === query.message;\n        });\n        console.log('[Chat] User query already in messages?', userQueryAlreadyAdded);\n        if (!userQueryAlreadyAdded) {\n            const initialMessages = [];\n            // Inject system message if provided by the caller (respond())\n            if (state.systemMessage) {\n                initialMessages.push({ role: 'system', content: state.systemMessage });\n            }\n            if (conversationId) {\n                // Get summary (if exists) and recent messages separately\n                const summary = yield redInstance.memory.getContextSummary(conversationId);\n                const recentMessages = yield redInstance.memory.getContextForConversation(conversationId);\n                console.log('[Chat] Loaded from memory - Summary:', !!summary, 'Recent messages:', recentMessages.length);\n                console.log('[Chat] Recent messages:', recentMessages.map(m => { var _a; return ({ role: m.role, content: (_a = m.content) === null || _a === void 0 ? void 0 : _a.substring(0, 30) }); }));\n                // Since Ollama doesn't combine system messages, we append summary\n                // as a contextual user message instead (less intrusive than overriding system prompt)\n                if (summary) {\n                    initialMessages.push({\n                        role: 'user',\n                        content: `[Previous conversation context: ${summary}]`\n                    });\n                }\n                // Add recent conversation messages (user/assistant pairs)\n                // Filter out the CURRENT user message (it will be added separately)\n                const filteredMessages = recentMessages.filter(msg => !(msg.role === 'user' && msg.content === query.message));\n                console.log('[Chat] Filtered out current message, remaining:', filteredMessages.length);\n                initialMessages.push(...filteredMessages.map(msg => ({\n                    role: msg.role,\n                    content: msg.content\n                })));\n            }\n            // Prepend initial context, then add existing messages (e.g., tool results), then user query\n            messages = [...initialMessages, ...messages];\n            // Add the current user query\n            if (query && query.message) {\n                messages.push({\n                    role: 'user',\n                    content: query.message\n                });\n            }\n        }\n        console.log('[Chat] Final message count before LLM:', messages.length);\n        console.log('[Chat] Last 3 messages:', messages.slice(-3).map(m => { var _a; return ({ role: m.role, content: (_a = m.content) === null || _a === void 0 ? void 0 : _a.substring(0, 50) }); }));\n        // Use streaming to get real-time chunks (including thinking tags)\n        const stream = yield modelWithTools.stream(messages);\n        let fullContent = '';\n        let usage_metadata = null;\n        let response_metadata = null;\n        try {\n            // Accumulate chunks into full content\n            for (var _f = true, stream_1 = __asyncValues(stream), stream_1_1; stream_1_1 = yield stream_1.next(), _a = stream_1_1.done, !_a; _f = true) {\n                _c = stream_1_1.value;\n                _f = false;\n                const chunk = _c;\n                if (chunk.content) {\n                    fullContent += chunk.content;\n                }\n                if (chunk.usage_metadata) {\n                    usage_metadata = chunk.usage_metadata;\n                }\n                if (chunk.response_metadata) {\n                    response_metadata = chunk.response_metadata;\n                }\n            }\n        }\n        catch (e_1_1) { e_1 = { error: e_1_1 }; }\n        finally {\n            try {\n                if (!_f && !_a && (_b = stream_1.return)) yield _b.call(stream_1);\n            }\n            finally { if (e_1) throw e_1.error; }\n        }\n        // LOG THE FULL CONTENT TO PROVE THINKING IS THERE\n        console.log('='.repeat(80));\n        console.log('[Chat] FULL ACCUMULATED CONTENT FROM LLM:');\n        console.log('='.repeat(80));\n        console.log(fullContent);\n        console.log('='.repeat(80));\n        console.log(`[Chat] Total length: ${fullContent.length} chars`);\n        console.log('='.repeat(80));\n        // Construct AIMessage from accumulated content\n        const aiMessage = new messages_1.AIMessage({\n            content: fullContent,\n            usage_metadata,\n            response_metadata,\n        });\n        // Log response metadata (including thinking tags if present)\n        yield redInstance.logger.log({\n            level: 'success',\n            category: 'chat',\n            message: `<green>✓ Response generated</green> <dim>(${fullContent.length} chars, ${(usage_metadata === null || usage_metadata === void 0 ? void 0 : usage_metadata.total_tokens) || 0} tokens)</dim>`,\n            generationId,\n            conversationId,\n            metadata: {\n                contentLength: fullContent.length,\n                tokens: usage_metadata,\n                model: response_metadata === null || response_metadata === void 0 ? void 0 : response_metadata.model,\n            },\n        });\n        return {\n            response: aiMessage,\n            messages: [aiMessage] // Add AI message to state messages\n        };\n    }\n    catch (error) {\n        const errorMessage = error instanceof Error ? error.message : String(error);\n        const generationId = (_d = state.options) === null || _d === void 0 ? void 0 : _d.generationId;\n        const conversationId = (_e = state.options) === null || _e === void 0 ? void 0 : _e.conversationId;\n        if (generationId && conversationId) {\n            yield state.redInstance.logger.log({\n                level: 'error',\n                category: 'chat',\n                message: `<red>✗ Chat error:</red> ${errorMessage}`,\n                generationId,\n                conversationId,\n                metadata: { error: errorMessage },\n            });\n        }\n        return {\n            response: { content: 'Error processing request.' },\n            messages: []\n        };\n    }\n});\nexports.chatNode = chatNode;\n"],"names":[],"mappings":"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","ignoreList":[0],"debugId":null}},
    {"offset": {"line": 3398, "column": 0}, "map": {"version":3,"sources":["file:///home/alpha/code/%40redbtn/webapp/node_modules/%40redbtn/ai/dist/lib/tools/search_web.js"],"sourcesContent":["\"use strict\";\nvar __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {\n    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }\n    return new (P || (P = Promise))(function (resolve, reject) {\n        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }\n        function rejected(value) { try { step(generator[\"throw\"](value)); } catch (e) { reject(e); } }\n        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }\n        step((generator = generator.apply(thisArg, _arguments || [])).next());\n    });\n};\nObject.defineProperty(exports, \"__esModule\", { value: true });\nexports.webSearchTool = void 0;\nconst tools_1 = require(\"@langchain/core/tools\");\nconst zod_1 = require(\"zod\");\nconst searchSchema = zod_1.z.object({\n    query: zod_1.z.string().describe(\"The search query to look up on Google\"),\n});\n/**\n * Web Search Tool - Searches Google using Custom Search API and scrapes each result\n * Requires GOOGLE_API_KEY and GOOGLE_SEARCH_ENGINE_ID environment variables\n */\nclass WebSearchTool extends tools_1.StructuredTool {\n    constructor() {\n        super(...arguments);\n        this.name = \"web_search\";\n        this.description = \"Search the web using Google and get actual content from the pages. Use this when you need current information, facts, news, or data that you don't have in your training data. Returns up to 10 search results with titles, snippets, URLs, and relevant body content from each page.\";\n        this.schema = searchSchema; // Type assertion to bypass deep instantiation\n    }\n    _call(_a) {\n        return __awaiter(this, arguments, void 0, function* ({ query }) {\n            const startTime = Date.now();\n            try {\n                const apiKey = process.env.GOOGLE_API_KEY;\n                const searchEngineId = process.env.GOOGLE_SEARCH_ENGINE_ID || process.env.GOOGLE_CSE_ID;\n                if (!apiKey) {\n                    return \"Error: GOOGLE_API_KEY environment variable is not set. Cannot perform web search.\";\n                }\n                if (!searchEngineId) {\n                    return \"Error: GOOGLE_SEARCH_ENGINE_ID or GOOGLE_CSE_ID environment variable is not set. Cannot perform web search.\";\n                }\n                console.log(`[Web Search Tool] Searching for: \"${query}\"`);\n                const searchStartTime = Date.now();\n                const url = `https://www.googleapis.com/customsearch/v1?key=${apiKey}&cx=${searchEngineId}&q=${encodeURIComponent(query)}&num=10`;\n                const response = yield fetch(url);\n                const searchDuration = Date.now() - searchStartTime;\n                console.log(`[Web Search Tool] ⏱️  Google search took ${searchDuration}ms`);\n                if (!response.ok) {\n                    const errorData = yield response.text();\n                    return `Error searching Google: ${response.status} ${response.statusText}. ${errorData}`;\n                }\n                const data = yield response.json();\n                if (!data.items || data.items.length === 0) {\n                    return `No results found for query: \"${query}\"`;\n                }\n                // Scrape each result URL in parallel\n                console.log(`[Web Search Tool] Scraping ${data.items.length} results...`);\n                const scrapeStartTime = Date.now();\n                const scrapePromises = data.items.map((item) => this.scrapeUrl(item.link, query).catch(err => `Error: ${err.message}`));\n                const scrapedContents = yield Promise.all(scrapePromises);\n                const scrapeDuration = Date.now() - scrapeStartTime;\n                console.log(`[Web Search Tool] ⏱️  Scraped ${data.items.length} pages in ${scrapeDuration}ms (${Math.round(scrapeDuration / data.items.length)}ms avg)`);\n                // Format results with scraped content\n                const results = data.items.map((item, index) => {\n                    const content = scrapedContents[index];\n                    return `${index + 1}. **${item.title}**\n   Snippet: ${item.snippet}\n   URL: ${item.link}\n   \n   Content:\n   ${content}`;\n                }).join('\\n\\n---\\n\\n');\n                const totalDuration = Date.now() - startTime;\n                console.log(`[Web Search Tool] ⏱️  Total execution time: ${totalDuration}ms`);\n                return `Search results for \"${query}\":\\n\\n${results}`;\n            }\n            catch (error) {\n                const totalDuration = Date.now() - startTime;\n                console.error(`[Web Search Tool] Error after ${totalDuration}ms:`, error);\n                return `Error performing web search: ${error instanceof Error ? error.message : String(error)}`;\n            }\n        });\n    }\n    /**\n     * Scrape a URL and extract relevant text content based on query keywords\n     * Extracts up to 1500 tokens of the most relevant content\n     */\n    scrapeUrl(url, query) {\n        return __awaiter(this, void 0, void 0, function* () {\n            const scrapeStart = Date.now();\n            try {\n                const response = yield fetch(url, {\n                    headers: {\n                        'User-Agent': 'Mozilla/5.0 (compatible; RedBot/1.0; +https://redbtn.io)'\n                    },\n                    signal: AbortSignal.timeout(8000) // 8 second timeout per page\n                });\n                if (!response.ok) {\n                    console.log(`[Web Search Tool] ⏱️  ${url} - Failed (${Date.now() - scrapeStart}ms): HTTP ${response.status}`);\n                    return `[Failed to fetch: HTTP ${response.status}]`;\n                }\n                const contentType = response.headers.get('content-type') || '';\n                if (!contentType.includes('text/html') && !contentType.includes('text/plain')) {\n                    console.log(`[Web Search Tool] ⏱️  ${url} - Skipped (${Date.now() - scrapeStart}ms): ${contentType}`);\n                    return `[Non-HTML content: ${contentType}]`;\n                }\n                const html = yield response.text();\n                const textContent = this.extractTextFromHtml(html);\n                if (!textContent.trim()) {\n                    console.log(`[Web Search Tool] ⏱️  ${url} - Empty (${Date.now() - scrapeStart}ms)`);\n                    return '[No text content found]';\n                }\n                // Extract relevant sections based on query keywords\n                const relevantContent = this.extractRelevantSections(textContent, query, 1500);\n                const duration = Date.now() - scrapeStart;\n                console.log(`[Web Search Tool] ⏱️  ${url} - Success (${duration}ms, ${relevantContent.length} chars)`);\n                return relevantContent;\n            }\n            catch (error) {\n                const duration = Date.now() - scrapeStart;\n                if (error.name === 'AbortError' || error.name === 'TimeoutError') {\n                    console.log(`[Web Search Tool] ⏱️  ${url} - Timeout (${duration}ms)`);\n                    return '[Timeout]';\n                }\n                console.log(`[Web Search Tool] ⏱️  ${url} - Error (${duration}ms): ${error.message}`);\n                return `[Error: ${error.message}]`;\n            }\n        });\n    }\n    /**\n     * Extract the most relevant sections from text based on query keywords\n     * Uses keyword matching to find paragraphs/sections that contain query terms\n     */\n    extractRelevantSections(text, query, maxTokens) {\n        // Extract keywords from query (remove common words)\n        const stopWords = new Set(['a', 'an', 'the', 'is', 'are', 'was', 'were', 'be', 'been', 'being',\n            'have', 'has', 'had', 'do', 'does', 'did', 'will', 'would', 'should', 'could', 'may', 'might',\n            'what', 'when', 'where', 'who', 'which', 'why', 'how', 'for', 'to', 'of', 'in', 'on', 'at',\n            'by', 'with', 'from', 'about', 'as', 'into', 'through', 'during', 'before', 'after', 'above',\n            'below', 'between', 'under', 'again', 'further', 'then', 'once', 'here', 'there', 'all', 'any',\n            'both', 'each', 'few', 'more', 'most', 'other', 'some', 'such', 'no', 'nor', 'not', 'only',\n            'own', 'same', 'so', 'than', 'too', 'very', 'can', 'just', 'today', 'tonight', 'this', 'that']);\n        const keywords = query.toLowerCase()\n            .split(/\\s+/)\n            .filter(word => word.length > 2 && !stopWords.has(word));\n        if (keywords.length === 0) {\n            // No meaningful keywords, just truncate from beginning\n            return this.truncateToTokens(text, maxTokens);\n        }\n        // Split text into sentences\n        const sentences = text.match(/[^.!?]+[.!?]+/g) || [text];\n        // Score each sentence based on keyword matches\n        const scoredSentences = sentences.map(sentence => {\n            const lowerSentence = sentence.toLowerCase();\n            let score = 0;\n            for (const keyword of keywords) {\n                const regex = new RegExp(`\\\\b${keyword}\\\\w*\\\\b`, 'gi');\n                const matches = lowerSentence.match(regex);\n                if (matches) {\n                    score += matches.length * 10; // Weight keyword matches heavily\n                }\n            }\n            // Bonus for sentences with numbers (often contain useful data like dates, scores, times)\n            if (/\\d+/.test(sentence)) {\n                score += 5;\n            }\n            return { sentence: sentence.trim(), score };\n        });\n        // Sort by score (highest first) and collect relevant content\n        scoredSentences.sort((a, b) => b.score - a.score);\n        let collectedText = '';\n        const usedSentences = new Set();\n        // First pass: collect high-scoring sentences\n        for (const item of scoredSentences) {\n            if (item.score > 0 && !usedSentences.has(item.sentence)) {\n                const potentialText = collectedText + (collectedText ? ' ' : '') + item.sentence;\n                const tokenCount = this.estimateTokens(potentialText);\n                if (tokenCount > maxTokens) {\n                    break;\n                }\n                collectedText = potentialText;\n                usedSentences.add(item.sentence);\n            }\n        }\n        // If we didn't collect enough content, add some context from the beginning\n        if (this.estimateTokens(collectedText) < maxTokens * 0.5) {\n            const beginningText = sentences.slice(0, 10).map(s => s.trim()).join(' ');\n            const combined = beginningText + ' ... ' + collectedText;\n            return this.truncateToTokens(combined, maxTokens);\n        }\n        return collectedText || this.truncateToTokens(text, maxTokens);\n    }\n    /**\n     * Estimate token count (rough approximation: 1 token ≈ 4 characters)\n     */\n    estimateTokens(text) {\n        return Math.ceil(text.length / 4);\n    }\n    /**\n     * Extract text from HTML by removing scripts, styles, and tags\n     */\n    extractTextFromHtml(html) {\n        let text = html.replace(/<script\\b[^<]*(?:(?!<\\/script>)<[^<]*)*<\\/script>/gi, ' ');\n        text = text.replace(/<style\\b[^<]*(?:(?!<\\/style>)<[^<]*)*<\\/style>/gi, ' ');\n        text = text.replace(/<!--[\\s\\S]*?-->/g, ' ');\n        text = text.replace(/<[^>]+>/g, ' ');\n        text = text.replace(/&nbsp;/g, ' ');\n        text = text.replace(/&amp;/g, '&');\n        text = text.replace(/&lt;/g, '<');\n        text = text.replace(/&gt;/g, '>');\n        text = text.replace(/&quot;/g, '\"');\n        text = text.replace(/&#39;/g, \"'\");\n        text = text.replace(/&mdash;/g, '—');\n        text = text.replace(/&ndash;/g, '–');\n        text = text.replace(/\\s+/g, ' ');\n        text = text.trim();\n        return text;\n    }\n    /**\n     * Truncate text to a maximum number of tokens\n     */\n    truncateToTokens(text, maxTokens) {\n        try {\n            // Lazy-load tiktoken to avoid build-time issues with WASM\n            const { encoding_for_model } = require('tiktoken');\n            const encoding = encoding_for_model('gpt-3.5-turbo');\n            const tokens = encoding.encode(text);\n            if (tokens.length <= maxTokens) {\n                encoding.free();\n                return text;\n            }\n            const truncatedTokens = tokens.slice(0, maxTokens);\n            const truncated = new TextDecoder().decode(encoding.decode(truncatedTokens));\n            encoding.free();\n            return truncated + '...';\n        }\n        catch (error) {\n            // Fallback if tiktoken fails to load\n            const estimatedChars = maxTokens * 4;\n            if (text.length <= estimatedChars) {\n                return text;\n            }\n            return text.substring(0, estimatedChars) + '...';\n        }\n    }\n}\nexports.webSearchTool = new WebSearchTool(); // Type assertion for export\n"],"names":[],"mappings":"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","ignoreList":[0],"debugId":null}},
    {"offset": {"line": 3737, "column": 0}, "map": {"version":3,"sources":["file:///home/alpha/code/%40redbtn/webapp/node_modules/%40redbtn/ai/dist/lib/tools/send_command.js"],"sourcesContent":["\"use strict\";\nvar __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {\n    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }\n    return new (P || (P = Promise))(function (resolve, reject) {\n        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }\n        function rejected(value) { try { step(generator[\"throw\"](value)); } catch (e) { reject(e); } }\n        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }\n        step((generator = generator.apply(thisArg, _arguments || [])).next());\n    });\n};\nObject.defineProperty(exports, \"__esModule\", { value: true });\nexports.sendCommandTool = void 0;\nconst tools_1 = require(\"@langchain/core/tools\");\nconst zod_1 = require(\"zod\");\nconst child_process_1 = require(\"child_process\");\nconst util_1 = require(\"util\");\nconst execAsync = (0, util_1.promisify)(child_process_1.exec);\nconst commandSchema = zod_1.z.object({\n    command: zod_1.z.string().describe(\"The CLI command to execute (e.g., 'ls -la', 'pwd', 'echo hello')\"),\n    timeout: zod_1.z.number().optional().describe(\"Optional timeout in milliseconds (default: 30000)\"),\n});\n/**\n * Send Command Tool - Executes CLI commands on the system\n * SECURITY WARNING: This tool can execute arbitrary commands. Use with caution and\n * implement proper security measures in production environments.\n */\nclass SendCommandTool extends tools_1.StructuredTool {\n    constructor() {\n        super(...arguments);\n        this.name = \"send_command\";\n        this.description = \"Execute a command line (CLI) command on the system. Use this to run shell commands, check system status, manage files, or interact with the operating system. Returns the command output (stdout/stderr). Use with caution as this executes real commands.\";\n        this.schema = commandSchema; // Type assertion to bypass deep instantiation\n    }\n    _call(_a) {\n        return __awaiter(this, arguments, void 0, function* ({ command, timeout = 30000 }) {\n            const startTime = Date.now();\n            try {\n                // Security check: block dangerous commands\n                const dangerousPatterns = [\n                    /rm\\s+-rf\\s+\\/($|\\s)/, // rm -rf /\n                    /:\\(\\)\\{.*:\\|:.*\\};:/, // fork bomb\n                    /mkfs\\./, // format filesystem\n                    /dd\\s+if=/, // dd commands (can be dangerous)\n                ];\n                for (const pattern of dangerousPatterns) {\n                    if (pattern.test(command)) {\n                        return `Error: Command blocked for security reasons. This command pattern is not allowed.`;\n                    }\n                }\n                console.log(`[Send Command Tool] Executing: ${command}`);\n                const execStart = Date.now();\n                const { stdout, stderr } = yield execAsync(command, {\n                    timeout,\n                    maxBuffer: 1024 * 1024, // 1MB buffer\n                    shell: '/bin/bash', // Use bash for better compatibility\n                });\n                const execDuration = Date.now() - execStart;\n                console.log(`[Send Command Tool] ⏱️  Command completed in ${execDuration}ms`);\n                // Combine stdout and stderr\n                let output = '';\n                if (stdout) {\n                    output += stdout;\n                }\n                if (stderr) {\n                    output += (output ? '\\n' : '') + `[STDERR]: ${stderr}`;\n                }\n                if (!output) {\n                    output = 'Command executed successfully with no output.';\n                }\n                // Truncate very long output\n                if (output.length > 4000) {\n                    output = output.substring(0, 4000) + '\\n\\n... (output truncated)';\n                }\n                const totalDuration = Date.now() - startTime;\n                console.log(`[Send Command Tool] ⏱️  Total execution time: ${totalDuration}ms`);\n                return `Command: ${command}\\n\\nOutput:\\n${output}`;\n            }\n            catch (error) {\n                const totalDuration = Date.now() - startTime;\n                console.error(`[Send Command Tool] ⏱️  Error after ${totalDuration}ms:`, error);\n                // Handle timeout\n                if (error.killed && error.signal === 'SIGTERM') {\n                    return `Error: Command timed out after ${timeout}ms`;\n                }\n                // Handle command execution errors\n                let errorMessage = `Error executing command: ${command}\\n\\n`;\n                if (error.stdout) {\n                    errorMessage += `STDOUT:\\n${error.stdout}\\n\\n`;\n                }\n                if (error.stderr) {\n                    errorMessage += `STDERR:\\n${error.stderr}\\n\\n`;\n                }\n                if (error.code) {\n                    errorMessage += `Exit code: ${error.code}`;\n                }\n                return errorMessage.trim();\n            }\n        });\n    }\n}\nexports.sendCommandTool = new SendCommandTool(); // Type assertion for export\n"],"names":[],"mappings":"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","ignoreList":[0],"debugId":null}},
    {"offset": {"line": 3859, "column": 0}, "map": {"version":3,"sources":["file:///home/alpha/code/%40redbtn/webapp/node_modules/%40redbtn/ai/dist/lib/tools/scrape_url.js"],"sourcesContent":["\"use strict\";\nvar __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {\n    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }\n    return new (P || (P = Promise))(function (resolve, reject) {\n        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }\n        function rejected(value) { try { step(generator[\"throw\"](value)); } catch (e) { reject(e); } }\n        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }\n        step((generator = generator.apply(thisArg, _arguments || [])).next());\n    });\n};\nObject.defineProperty(exports, \"__esModule\", { value: true });\nexports.scrapeUrlTool = void 0;\nconst tools_1 = require(\"@langchain/core/tools\");\nconst zod_1 = require(\"zod\");\nconst urlSchema = zod_1.z.object({\n    url: zod_1.z.string().describe(\"The URL to scrape (must be http or https)\"),\n});\nclass ScrapeUrlTool extends tools_1.StructuredTool {\n    constructor() {\n        super(...arguments);\n        this.name = \"scrape_url\";\n        this.description = \"Fetch and extract text content from a webpage. Returns the main body text from the URL, limited to 1000 tokens.\";\n        this.schema = urlSchema;\n    }\n    _call(_a) {\n        return __awaiter(this, arguments, void 0, function* ({ url }) {\n            const startTime = Date.now();\n            try {\n                let validUrl;\n                try {\n                    validUrl = new URL(url);\n                }\n                catch (_b) {\n                    return `Error: Invalid URL format: ${url}`;\n                }\n                if (!['http:', 'https:'].includes(validUrl.protocol)) {\n                    return `Error: Only HTTP and HTTPS protocols are allowed`;\n                }\n                console.log(`[Scrape URL Tool] Fetching: ${url}`);\n                const response = yield fetch(url, {\n                    headers: {\n                        'User-Agent': 'Mozilla/5.0 (compatible; RedBot/1.0; +https://redbtn.io)'\n                    },\n                    signal: AbortSignal.timeout(10000)\n                });\n                if (!response.ok) {\n                    return `Error: HTTP ${response.status} ${response.statusText}`;\n                }\n                const contentType = response.headers.get('content-type') || '';\n                if (!contentType.includes('text/html') && !contentType.includes('text/plain')) {\n                    return `Error: URL does not return HTML or text content (got: ${contentType})`;\n                }\n                const html = yield response.text();\n                const textContent = extractTextFromHtml(html);\n                if (!textContent.trim()) {\n                    return `Error: No text content found on the page`;\n                }\n                const truncated = truncateToTokens(textContent, 1000);\n                const duration = Date.now() - startTime;\n                console.log(`[Scrape URL Tool] ⏱️  Scraped successfully in ${duration}ms (${truncated.length} chars)`);\n                return `Content from ${url}:\\n\\n${truncated}`;\n            }\n            catch (error) {\n                const duration = Date.now() - startTime;\n                console.error(`[Scrape URL Tool] ⏱️  Error after ${duration}ms:`, error);\n                if (error.name === 'AbortError' || error.name === 'TimeoutError') {\n                    return `Error: Request timed out after 10 seconds`;\n                }\n                return `Error scraping URL: ${error instanceof Error ? error.message : String(error)}`;\n            }\n        });\n    }\n}\nfunction extractTextFromHtml(html) {\n    let text = html.replace(/<script\\b[^<]*(?:(?!<\\/script>)<[^<]*)*<\\/script>/gi, ' ');\n    text = text.replace(/<style\\b[^<]*(?:(?!<\\/style>)<[^<]*)*<\\/style>/gi, ' ');\n    text = text.replace(/<!--[\\s\\S]*?-->/g, ' ');\n    text = text.replace(/<[^>]+>/g, ' ');\n    text = text.replace(/&nbsp;/g, ' ');\n    text = text.replace(/&amp;/g, '&');\n    text = text.replace(/&lt;/g, '<');\n    text = text.replace(/&gt;/g, '>');\n    text = text.replace(/&quot;/g, '\"');\n    text = text.replace(/&#39;/g, \"'\");\n    text = text.replace(/&mdash;/g, '—');\n    text = text.replace(/&ndash;/g, '–');\n    text = text.replace(/\\s+/g, ' ');\n    text = text.trim();\n    return text;\n}\nfunction truncateToTokens(text, maxTokens) {\n    try {\n        // Lazy-load tiktoken to avoid build-time issues with WASM\n        const { encoding_for_model } = require('tiktoken');\n        const encoding = encoding_for_model('gpt-3.5-turbo');\n        const tokens = encoding.encode(text);\n        if (tokens.length <= maxTokens) {\n            encoding.free();\n            return text;\n        }\n        const truncatedTokens = tokens.slice(0, maxTokens);\n        const truncated = new TextDecoder().decode(encoding.decode(truncatedTokens));\n        encoding.free();\n        return truncated + '\\n\\n... (content truncated to 1000 tokens)';\n    }\n    catch (error) {\n        // Fallback if tiktoken fails to load (e.g., in browser environments)\n        const estimatedChars = maxTokens * 4;\n        if (text.length <= estimatedChars) {\n            return text;\n        }\n        return text.substring(0, estimatedChars) + '\\n\\n... (content truncated to ~1000 tokens)';\n    }\n}\nexports.scrapeUrlTool = new ScrapeUrlTool();\n"],"names":[],"mappings":"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","ignoreList":[0],"debugId":null}},
    {"offset": {"line": 3997, "column": 0}, "map": {"version":3,"sources":["file:///home/alpha/code/%40redbtn/webapp/node_modules/%40redbtn/ai/dist/lib/tools/index.js"],"sourcesContent":["\"use strict\";\n/**\n * @file src/lib/tools/index.ts\n * @description Central registry for all AI tools available to the Red agent\n */\nObject.defineProperty(exports, \"__esModule\", { value: true });\nexports.scrapeUrlTool = exports.sendCommandTool = exports.webSearchTool = exports.allTools = void 0;\nconst search_web_1 = require(\"./search_web\");\nObject.defineProperty(exports, \"webSearchTool\", { enumerable: true, get: function () { return search_web_1.webSearchTool; } });\nconst send_command_1 = require(\"./send_command\");\nObject.defineProperty(exports, \"sendCommandTool\", { enumerable: true, get: function () { return send_command_1.sendCommandTool; } });\nconst scrape_url_1 = require(\"./scrape_url\");\nObject.defineProperty(exports, \"scrapeUrlTool\", { enumerable: true, get: function () { return scrape_url_1.scrapeUrlTool; } });\n/**\n * Array of all available tools that can be bound to the LLM.\n * These are action tools that should only be used when necessary.\n */\nexports.allTools = [\n    search_web_1.webSearchTool,\n    send_command_1.sendCommandTool,\n    scrape_url_1.scrapeUrlTool,\n];\n"],"names":[],"mappings":"AACA;;;CAGC,GACD,OAAO,cAAc,CAAC,SAAS,cAAc;IAAE,OAAO;AAAK;AAC3D,QAAQ,aAAa,GAAG,QAAQ,eAAe,GAAG,QAAQ,aAAa,GAAG,QAAQ,QAAQ,GAAG,KAAK;AAClG,MAAM;AACN,OAAO,cAAc,CAAC,SAAS,iBAAiB;IAAE,YAAY;IAAM,KAAK;QAAc,OAAO,aAAa,aAAa;IAAE;AAAE;AAC5H,MAAM;AACN,OAAO,cAAc,CAAC,SAAS,mBAAmB;IAAE,YAAY;IAAM,KAAK;QAAc,OAAO,eAAe,eAAe;IAAE;AAAE;AAClI,MAAM;AACN,OAAO,cAAc,CAAC,SAAS,iBAAiB;IAAE,YAAY;IAAM,KAAK;QAAc,OAAO,aAAa,aAAa;IAAE;AAAE;AAC5H;;;CAGC,GACD,QAAQ,QAAQ,GAAG;IACf,aAAa,aAAa;IAC1B,eAAe,eAAe;IAC9B,aAAa,aAAa;CAC7B","ignoreList":[0],"debugId":null}},
    {"offset": {"line": 4037, "column": 0}, "map": {"version":3,"sources":["file:///home/alpha/code/%40redbtn/webapp/node_modules/%40redbtn/ai/dist/lib/nodes/tool.js"],"sourcesContent":["\"use strict\";\nObject.defineProperty(exports, \"__esModule\", { value: true });\nexports.toolNode = void 0;\nconst prebuilt_1 = require(\"@langchain/langgraph/prebuilt\");\nconst tools_1 = require(\"../tools\");\n/**\n * Tool execution node using LangGraph's built-in ToolNode\n * Automatically handles tool execution based on tool_calls from the LLM\n */\nexports.toolNode = new prebuilt_1.ToolNode(tools_1.allTools);\n"],"names":[],"mappings":"AACA,OAAO,cAAc,CAAC,SAAS,cAAc;IAAE,OAAO;AAAK;AAC3D,QAAQ,QAAQ,GAAG,KAAK;AACxB,MAAM;AACN,MAAM;AACN;;;CAGC,GACD,QAAQ,QAAQ,GAAG,IAAI,WAAW,QAAQ,CAAC,QAAQ,QAAQ","ignoreList":[0],"debugId":null}},
    {"offset": {"line": 4051, "column": 0}, "map": {"version":3,"sources":["file:///home/alpha/code/%40redbtn/webapp/node_modules/%40redbtn/ai/dist/lib/nodes/toolPicker.js"],"sourcesContent":["\"use strict\";\nvar __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {\n    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }\n    return new (P || (P = Promise))(function (resolve, reject) {\n        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }\n        function rejected(value) { try { step(generator[\"throw\"](value)); } catch (e) { reject(e); } }\n        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }\n        step((generator = generator.apply(thisArg, _arguments || [])).next());\n    });\n};\nObject.defineProperty(exports, \"__esModule\", { value: true });\nexports.toolPickerNode = toolPickerNode;\nconst tools_1 = require(\"../tools\");\nconst messages_1 = require(\"@langchain/core/messages\");\nconst thinking_1 = require(\"../utils/thinking\");\n/**\n * The toolPicker node executes web_search tool before routing to chat.\n * This provides the chat node with fresh context without exposing tools\n * to conversational queries, preserving streaming.\n *\n * @param state The current state of the graph.\n * @returns A partial state with tool results added to messages.\n */\nfunction toolPickerNode(state) {\n    return __awaiter(this, void 0, void 0, function* () {\n        var _a, _b, _c;\n        const query = ((_a = state.query) === null || _a === void 0 ? void 0 : _a.message) || '';\n        const redInstance = state.redInstance;\n        const toolAction = state.toolAction || 'web_search';\n        const toolParam = state.toolParam || '';\n        const generationId = (_b = state.options) === null || _b === void 0 ? void 0 : _b.generationId;\n        const conversationId = (_c = state.options) === null || _c === void 0 ? void 0 : _c.conversationId;\n        try {\n            // Log tool execution start\n            const toolEmojis = {\n                'web_search': '🔍',\n                'scrape_url': '📄',\n                'system_command': '⚙️',\n            };\n            const emoji = toolEmojis[toolAction] || '🔧';\n            yield redInstance.logger.log({\n                level: 'info',\n                category: 'tool',\n                message: `<yellow>${emoji} Executing tool:</yellow> <bold>${toolAction}</bold>`,\n                generationId,\n                conversationId,\n                metadata: { tool: toolAction, param: toolParam },\n            });\n            let result = '';\n            let toolUsed = toolAction;\n            let searchQuery = query; // Default to original query\n            // For web_search, let LLM optimize the search terms\n            if (toolAction === 'web_search') {\n                yield redInstance.logger.log({\n                    level: 'debug',\n                    category: 'tool',\n                    message: `<dim>Optimizing search query...</dim>`,\n                    generationId,\n                    conversationId,\n                });\n                const currentDate = new Date().toLocaleDateString('en-US', {\n                    weekday: 'long',\n                    year: 'numeric',\n                    month: 'long',\n                    day: 'numeric'\n                });\n                const searchOptimization = yield redInstance.localModel.invoke([\n                    {\n                        role: 'system',\n                        content: `Today's date: ${currentDate}. You are a search query optimizer. Extract the key search terms from the user's question. Return ONLY the optimized search query, nothing else.\n\nExamples:\n\"What baseball games are happening tonight?\" → \"MLB games today schedule\"\n\"Who won the election last week?\" → \"election results 2025\"\n\"What's the weather like in Paris?\" → \"Paris weather today\"\n\"Tell me about the new iPhone\" → \"latest iPhone 2025 features\"`\n                    },\n                    {\n                        role: 'user',\n                        content: query\n                    }\n                ]);\n                const { thinking, cleanedContent } = (0, thinking_1.extractThinking)(searchOptimization.content.toString());\n                // Log optimization thinking\n                if (thinking && generationId && conversationId) {\n                    yield redInstance.logger.logThought({\n                        content: thinking,\n                        source: 'toolPicker-search-optimization',\n                        generationId,\n                        conversationId,\n                    });\n                }\n                (0, thinking_1.logThinking)(thinking, 'ToolPicker (Search Optimization)');\n                searchQuery = cleanedContent.trim();\n                yield redInstance.logger.log({\n                    level: 'info',\n                    category: 'tool',\n                    message: `<cyan>Optimized search:</cyan> <dim>\"${query.substring(0, 40)}${query.length > 40 ? '...' : ''}\"</dim> → <green>\"${searchQuery}\"</green>`,\n                    generationId,\n                    conversationId,\n                    metadata: { originalQuery: query, optimizedQuery: searchQuery },\n                });\n            }\n            // Execute the specific tool the router chose\n            if (toolAction === 'web_search') {\n                const webSearchTool = tools_1.allTools.find(t => t.name === 'web_search');\n                if (!webSearchTool) {\n                    yield redInstance.logger.log({\n                        level: 'error',\n                        category: 'tool',\n                        message: `<red>✗ Tool not found:</red> web_search`,\n                        generationId,\n                        conversationId,\n                    });\n                    return { selectedTools: [], messages: [], toolStatus: 'error: tool not found' };\n                }\n                result = yield webSearchTool.invoke({ query: searchQuery });\n            }\n            else if (toolAction === 'scrape_url') {\n                const scrapeTool = tools_1.allTools.find(t => t.name === 'scrape_url');\n                if (!scrapeTool) {\n                    yield redInstance.logger.log({\n                        level: 'error',\n                        category: 'tool',\n                        message: `<red>✗ Tool not found:</red> scrape_url`,\n                        generationId,\n                        conversationId,\n                    });\n                    return { selectedTools: [], messages: [], toolStatus: 'error: tool not found' };\n                }\n                const urlToScrape = toolParam || query;\n                yield redInstance.logger.log({\n                    level: 'debug',\n                    category: 'tool',\n                    message: `<dim>Scraping URL: ${urlToScrape}</dim>`,\n                    generationId,\n                    conversationId,\n                });\n                result = yield scrapeTool.invoke({ url: urlToScrape });\n            }\n            else if (toolAction === 'system_command') {\n                const commandTool = tools_1.allTools.find(t => t.name === 'send_command');\n                if (!commandTool) {\n                    yield redInstance.logger.log({\n                        level: 'error',\n                        category: 'tool',\n                        message: `<red>✗ Tool not found:</red> send_command`,\n                        generationId,\n                        conversationId,\n                    });\n                    return { selectedTools: [], messages: [], toolStatus: 'error: tool not found' };\n                }\n                const command = toolParam || query;\n                yield redInstance.logger.log({\n                    level: 'debug',\n                    category: 'tool',\n                    message: `<dim>Executing command: ${command}</dim>`,\n                    generationId,\n                    conversationId,\n                });\n                result = yield commandTool.invoke({ command });\n            }\n            // Log tool completion\n            yield redInstance.logger.log({\n                level: 'success',\n                category: 'tool',\n                message: `<green>✓ Tool completed:</green> <bold>${toolAction}</bold> <dim>(${result.length} chars)</dim>`,\n                generationId,\n                conversationId,\n                metadata: { tool: toolAction, resultLength: result.length },\n            });\n            // Extract and summarize the information\n            yield redInstance.logger.log({\n                level: 'debug',\n                category: 'tool',\n                message: `<dim>Extracting key information...</dim>`,\n                generationId,\n                conversationId,\n            });\n            const currentDate = new Date().toLocaleDateString('en-US', {\n                weekday: 'long',\n                year: 'numeric',\n                month: 'long',\n                day: 'numeric'\n            });\n            const extractedInfo = yield redInstance.localModel.invoke([\n                {\n                    role: 'system',\n                    content: `Today's date: ${currentDate}. You are an information extraction expert. Extract key facts and data to answer the user's query accurately and concisely.`\n                },\n                {\n                    role: 'user',\n                    content: `User Query: ${query}\\n\\nTool Results:\\n${result}\\n\\nExtract and summarize the key information that answers this query:`\n                }\n            ]);\n            let summary = extractedInfo.content.toString().trim();\n            // Extract and log thinking if present (safe for all models)\n            const { thinking, cleanedContent } = (0, thinking_1.extractThinking)(summary);\n            // Log extraction thinking\n            if (thinking && generationId && conversationId) {\n                yield redInstance.logger.logThought({\n                    content: thinking,\n                    source: 'toolPicker-extraction',\n                    generationId,\n                    conversationId,\n                });\n            }\n            (0, thinking_1.logThinking)(thinking, 'ToolPicker');\n            summary = cleanedContent;\n            yield redInstance.logger.log({\n                level: 'success',\n                category: 'tool',\n                message: `<green>✓ Information extracted</green> <dim>(${summary.length} chars)</dim>`,\n                generationId,\n                conversationId,\n                metadata: { summaryLength: summary.length },\n            });\n            // Add extracted/summarized info as a SystemMessage\n            return {\n                selectedTools: [toolUsed],\n                messages: [\n                    new messages_1.SystemMessage(`[INTERNAL CONTEXT - User cannot see this]\\nRelevant information found:\\n\\n${summary}\\n\\nUse this information to answer the user's query directly and confidently. Do not say \"according to search results\" or reference external sources - answer as if you know this information.`)\n                ]\n            };\n        }\n        catch (error) {\n            const errorMessage = error instanceof Error ? error.message : String(error);\n            yield redInstance.logger.log({\n                level: 'error',\n                category: 'tool',\n                message: `<red>✗ Tool execution error:</red> ${errorMessage}`,\n                generationId,\n                conversationId,\n                metadata: { error: errorMessage, tool: toolAction },\n            });\n            return { selectedTools: [], messages: [] };\n        }\n    });\n}\n"],"names":[],"mappings":"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","ignoreList":[0],"debugId":null}},
    {"offset": {"line": 4346, "column": 0}, "map": {"version":3,"sources":["file:///home/alpha/code/%40redbtn/webapp/node_modules/%40redbtn/ai/dist/lib/graphs/red.js"],"sourcesContent":["\"use strict\";\nObject.defineProperty(exports, \"__esModule\", { value: true });\nexports.redGraph = void 0;\nconst langgraph_1 = require(\"@langchain/langgraph\");\nconst router_1 = require(\"../nodes/router\");\nconst chat_1 = require(\"../nodes/chat\");\nconst tool_1 = require(\"../nodes/tool\");\nconst toolPicker_1 = require(\"../nodes/toolPicker\");\n/**\n * 1. Define the State using Annotation\n * This is the shared memory object that flows between nodes.\n */\nconst RedGraphState = langgraph_1.Annotation.Root({\n    query: (0, langgraph_1.Annotation)({\n        reducer: (x, y) => y,\n        default: () => ({})\n    }),\n    options: (0, langgraph_1.Annotation)({\n        reducer: (x, y) => y,\n        default: () => ({})\n    }),\n    // Carry the Red instance through the graph so nodes can access configured models\n    redInstance: (0, langgraph_1.Annotation)({\n        reducer: (x, y) => y,\n        default: () => ({})\n    }),\n    // Messages array that accumulates throughout the tool calling loop\n    messages: (0, langgraph_1.Annotation)({\n        reducer: (x, y) => x.concat(y),\n        default: () => []\n    }),\n    // Response contains the full AIMessage object with content, tokens, and metadata\n    response: (0, langgraph_1.Annotation)({\n        reducer: (x, y) => y\n    }),\n    nextGraph: (0, langgraph_1.Annotation)({\n        reducer: (x, y) => y\n    }),\n    // Track which tools were selected by toolPicker for this query\n    selectedTools: (0, langgraph_1.Annotation)({\n        reducer: (x, y) => y,\n        default: () => []\n    })\n});\n// --- Graph Definition ---\n// Helper function to determine if we should continue to tools or end\nfunction shouldContinue(state) {\n    var _a;\n    const toolCalls = (_a = state.response) === null || _a === void 0 ? void 0 : _a.tool_calls;\n    // If the LLM makes tool calls, route to the tools node for execution\n    if (toolCalls && toolCalls.length > 0) {\n        return \"tools\";\n    }\n    // Otherwise, end the graph (no tools to execute)\n    return langgraph_1.END;\n}\n// Create a new graph instance\nconst redGraphBuilder = new langgraph_1.StateGraph(RedGraphState)\n    .addNode(\"router\", router_1.routerNode)\n    .addNode(\"toolPicker\", toolPicker_1.toolPickerNode) // Pre-filter and execute tools if needed\n    .addNode(\"chat\", chat_1.chatNode)\n    .addNode(\"tools\", tool_1.toolNode) // For follow-up tool calls from chat\n    .addEdge(\"__start__\", \"router\")\n    .addConditionalEdges(\"router\", (state) => state.nextGraph || \"chat\", {\n    \"homeGraph\": langgraph_1.END,\n    \"assistantGraph\": langgraph_1.END,\n    \"toolPicker\": \"toolPicker\", // Route to toolPicker when action needed\n    \"chat\": \"chat\", // Route directly to chat for conversation\n})\n    // After toolPicker executes tools, go to chat with results\n    .addEdge(\"toolPicker\", \"chat\")\n    // After chat, check if we need to call MORE tools (for follow-ups)\n    .addConditionalEdges(\"chat\", shouldContinue, {\n    tools: \"tools\",\n    [langgraph_1.END]: langgraph_1.END\n})\n    // After follow-up tools, go back to chat to process results\n    .addEdge(\"tools\", \"chat\");\n// Compile the graph into a runnable object\nexports.redGraph = redGraphBuilder.compile();\n"],"names":[],"mappings":"AACA,OAAO,cAAc,CAAC,SAAS,cAAc;IAAE,OAAO;AAAK;AAC3D,QAAQ,QAAQ,GAAG,KAAK;AACxB,MAAM;AACN,MAAM;AACN,MAAM;AACN,MAAM;AACN,MAAM;AACN;;;CAGC,GACD,MAAM,gBAAgB,YAAY,UAAU,CAAC,IAAI,CAAC;IAC9C,OAAO,CAAC,GAAG,YAAY,UAAU,EAAE;QAC/B,SAAS,CAAC,GAAG,IAAM;QACnB,SAAS,IAAM,CAAC,CAAC,CAAC;IACtB;IACA,SAAS,CAAC,GAAG,YAAY,UAAU,EAAE;QACjC,SAAS,CAAC,GAAG,IAAM;QACnB,SAAS,IAAM,CAAC,CAAC,CAAC;IACtB;IACA,iFAAiF;IACjF,aAAa,CAAC,GAAG,YAAY,UAAU,EAAE;QACrC,SAAS,CAAC,GAAG,IAAM;QACnB,SAAS,IAAM,CAAC,CAAC,CAAC;IACtB;IACA,mEAAmE;IACnE,UAAU,CAAC,GAAG,YAAY,UAAU,EAAE;QAClC,SAAS,CAAC,GAAG,IAAM,EAAE,MAAM,CAAC;QAC5B,SAAS,IAAM,EAAE;IACrB;IACA,iFAAiF;IACjF,UAAU,CAAC,GAAG,YAAY,UAAU,EAAE;QAClC,SAAS,CAAC,GAAG,IAAM;IACvB;IACA,WAAW,CAAC,GAAG,YAAY,UAAU,EAAE;QACnC,SAAS,CAAC,GAAG,IAAM;IACvB;IACA,+DAA+D;IAC/D,eAAe,CAAC,GAAG,YAAY,UAAU,EAAE;QACvC,SAAS,CAAC,GAAG,IAAM;QACnB,SAAS,IAAM,EAAE;IACrB;AACJ;AACA,2BAA2B;AAC3B,qEAAqE;AACrE,SAAS,eAAe,KAAK;IACzB,IAAI;IACJ,MAAM,YAAY,CAAC,KAAK,MAAM,QAAQ,MAAM,QAAQ,OAAO,KAAK,IAAI,KAAK,IAAI,GAAG,UAAU;IAC1F,qEAAqE;IACrE,IAAI,aAAa,UAAU,MAAM,GAAG,GAAG;QACnC,OAAO;IACX;IACA,iDAAiD;IACjD,OAAO,YAAY,GAAG;AAC1B;AACA,8BAA8B;AAC9B,MAAM,kBAAkB,IAAI,YAAY,UAAU,CAAC,eAC9C,OAAO,CAAC,UAAU,SAAS,UAAU,EACrC,OAAO,CAAC,cAAc,aAAa,cAAc,EAAE,yCAAyC;CAC5F,OAAO,CAAC,QAAQ,OAAO,QAAQ,EAC/B,OAAO,CAAC,SAAS,OAAO,QAAQ,EAAE,qCAAqC;CACvE,OAAO,CAAC,aAAa,UACrB,mBAAmB,CAAC,UAAU,CAAC,QAAU,MAAM,SAAS,IAAI,QAAQ;IACrE,aAAa,YAAY,GAAG;IAC5B,kBAAkB,YAAY,GAAG;IACjC,cAAc;IACd,QAAQ;AACZ,EACI,2DAA2D;CAC1D,OAAO,CAAC,cAAc,OACvB,mEAAmE;CAClE,mBAAmB,CAAC,QAAQ,gBAAgB;IAC7C,OAAO;IACP,CAAC,YAAY,GAAG,CAAC,EAAE,YAAY,GAAG;AACtC,EACI,4DAA4D;CAC3D,OAAO,CAAC,SAAS;AACtB,2CAA2C;AAC3C,QAAQ,QAAQ,GAAG,gBAAgB,OAAO","ignoreList":[0],"debugId":null}},
    {"offset": {"line": 4423, "column": 0}, "map": {"version":3,"sources":["file:///home/alpha/code/%40redbtn/webapp/node_modules/%40redbtn/ai/dist/functions/respond.js"],"sourcesContent":["\"use strict\";\n/**\n * Response generation and streaming utilities\n */\nvar __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {\n    if (k2 === undefined) k2 = k;\n    var desc = Object.getOwnPropertyDescriptor(m, k);\n    if (!desc || (\"get\" in desc ? !m.__esModule : desc.writable || desc.configurable)) {\n      desc = { enumerable: true, get: function() { return m[k]; } };\n    }\n    Object.defineProperty(o, k2, desc);\n}) : (function(o, m, k, k2) {\n    if (k2 === undefined) k2 = k;\n    o[k2] = m[k];\n}));\nvar __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {\n    Object.defineProperty(o, \"default\", { enumerable: true, value: v });\n}) : function(o, v) {\n    o[\"default\"] = v;\n});\nvar __importStar = (this && this.__importStar) || (function () {\n    var ownKeys = function(o) {\n        ownKeys = Object.getOwnPropertyNames || function (o) {\n            var ar = [];\n            for (var k in o) if (Object.prototype.hasOwnProperty.call(o, k)) ar[ar.length] = k;\n            return ar;\n        };\n        return ownKeys(o);\n    };\n    return function (mod) {\n        if (mod && mod.__esModule) return mod;\n        var result = {};\n        if (mod != null) for (var k = ownKeys(mod), i = 0; i < k.length; i++) if (k[i] !== \"default\") __createBinding(result, mod, k[i]);\n        __setModuleDefault(result, mod);\n        return result;\n    };\n})();\nvar __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {\n    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }\n    return new (P || (P = Promise))(function (resolve, reject) {\n        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }\n        function rejected(value) { try { step(generator[\"throw\"](value)); } catch (e) { reject(e); } }\n        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }\n        step((generator = generator.apply(thisArg, _arguments || [])).next());\n    });\n};\nvar __await = (this && this.__await) || function (v) { return this instanceof __await ? (this.v = v, this) : new __await(v); }\nvar __asyncValues = (this && this.__asyncValues) || function (o) {\n    if (!Symbol.asyncIterator) throw new TypeError(\"Symbol.asyncIterator is not defined.\");\n    var m = o[Symbol.asyncIterator], i;\n    return m ? m.call(o) : (o = typeof __values === \"function\" ? __values(o) : o[Symbol.iterator](), i = {}, verb(\"next\"), verb(\"throw\"), verb(\"return\"), i[Symbol.asyncIterator] = function () { return this; }, i);\n    function verb(n) { i[n] = o[n] && function (v) { return new Promise(function (resolve, reject) { v = o[n](v), settle(resolve, reject, v.done, v.value); }); }; }\n    function settle(resolve, reject, d, v) { Promise.resolve(v).then(function(v) { resolve({ value: v, done: d }); }, reject); }\n};\nvar __asyncGenerator = (this && this.__asyncGenerator) || function (thisArg, _arguments, generator) {\n    if (!Symbol.asyncIterator) throw new TypeError(\"Symbol.asyncIterator is not defined.\");\n    var g = generator.apply(thisArg, _arguments || []), i, q = [];\n    return i = Object.create((typeof AsyncIterator === \"function\" ? AsyncIterator : Object).prototype), verb(\"next\"), verb(\"throw\"), verb(\"return\", awaitReturn), i[Symbol.asyncIterator] = function () { return this; }, i;\n    function awaitReturn(f) { return function (v) { return Promise.resolve(v).then(f, reject); }; }\n    function verb(n, f) { if (g[n]) { i[n] = function (v) { return new Promise(function (a, b) { q.push([n, v, a, b]) > 1 || resume(n, v); }); }; if (f) i[n] = f(i[n]); } }\n    function resume(n, v) { try { step(g[n](v)); } catch (e) { settle(q[0][3], e); } }\n    function step(r) { r.value instanceof __await ? Promise.resolve(r.value.v).then(fulfill, reject) : settle(q[0][2], r); }\n    function fulfill(value) { resume(\"next\", value); }\n    function reject(value) { resume(\"throw\", value); }\n    function settle(f, v) { if (f(v), q.shift(), q.length) resume(q[0][0], q[0][1]); }\n};\nObject.defineProperty(exports, \"__esModule\", { value: true });\nexports.respond = respond;\nconst red_1 = require(\"../lib/graphs/red\");\nconst background = __importStar(require(\"./background\"));\n/**\n * Handles a direct, on-demand request from a user-facing application.\n * Automatically manages conversation history, memory, and summarization.\n * @param red The Red instance\n * @param query The user's input or request data (must have a 'message' property)\n * @param options Metadata about the source of the request and conversation settings\n * @returns For non-streaming: the full AIMessage object with content, tokens, metadata, and conversationId.\n *          For streaming: an async generator that yields metadata first (with conversationId), then string chunks, then finally the full AIMessage.\n */\nfunction respond(red_2, query_1) {\n    return __awaiter(this, arguments, void 0, function* (red, query, options = {}) {\n        var _a, _b;\n        // Generate conversation ID if not provided\n        const conversationId = options.conversationId || red.memory.generateConversationId(query.message);\n        // Extract messageId for Redis pub/sub (if provided)\n        const messageId = options.messageId;\n        console.log(`[Respond] Starting response with messageId: ${messageId || 'NONE'}, conversationId: ${conversationId}`);\n        // Start a new generation (will fail if one is already in progress)\n        const generationId = yield red.logger.startGeneration(conversationId);\n        if (!generationId) {\n            throw new Error('A generation is already in progress for this conversation');\n        }\n        // Store user message in memory\n        yield red.memory.addMessage(conversationId, {\n            role: 'user',\n            content: query.message,\n            timestamp: Date.now()\n        });\n        const initialState = {\n            query,\n            options: Object.assign(Object.assign({}, options), { conversationId, generationId }), // Add generationId to options\n            redInstance: red, // Pass the entire instance into the graph\n        };\n        // Inject a system message into the graph state for every respond() call.\n        // Use env override if available so this can be configured without code changes.\n        const SYSTEM_PROMPT = process.env.SYSTEM_PROMPT || `You are Red, an AI assistant developed by redbtn.io.\nCurrent date: ${new Date().toLocaleDateString()}\nDevice: ${((_a = options.source) === null || _a === void 0 ? void 0 : _a.device) || 'unknown'}\nApplication: ${((_b = options.source) === null || _b === void 0 ? void 0 : _b.application) || 'unknown'}\n\nCRITICAL RULES:\n1. NEVER mention \"knowledge cutoff\", \"training data\", \"as of my knowledge\", or any limitations\n2. NEVER introduce yourself unless this is the FIRST message in a new conversation or you're asked to do so\n3. NEVER add disclaimers like \"please note\" or \"for the most up-to-date information\", and don't repeat the query to the user\n4. If you have search results, use them directly and confidently\n5. Be concise and helpful - answer the question directly without extra explanations`;\n        // Attach as `systemMessage` so the chat node can include it while still loading\n        // memory and the user query (we avoid pre-populating `messages` which would\n        // prevent chatNode from inserting memory context).\n        initialState.systemMessage = SYSTEM_PROMPT;\n        // Check if streaming is requested\n        if (options.stream) {\n            // Use LangGraph's streaming capabilities to stream through the graph\n            return streamThroughGraphWithMemory(red, initialState, conversationId, generationId, messageId);\n        }\n        else {\n            // Invoke the graph and return the full AIMessage\n            const result = yield red_1.redGraph.invoke(initialState);\n            const response = result.response;\n            // Store assistant response in memory\n            yield red.memory.addMessage(conversationId, {\n                role: 'assistant',\n                content: typeof response.content === 'string' ? response.content : JSON.stringify(response.content),\n                timestamp: Date.now()\n            });\n            // Get message count for title generation\n            const metadata = yield red.memory.getMetadata(conversationId);\n            const messageCount = (metadata === null || metadata === void 0 ? void 0 : metadata.messageCount) || 0;\n            // Trigger background summarization (non-blocking)\n            background.summarizeInBackground(conversationId, red.memory, red.localModel);\n            // Trigger background title generation (non-blocking)\n            background.generateTitleInBackground(conversationId, messageCount, red.memory, red.localModel);\n            // Attach conversationId to response for server access\n            return Object.assign(Object.assign({}, response), { conversationId });\n        }\n    });\n}\n/**\n * Internal method to handle streaming responses through the graph with memory management.\n * Yields metadata first (with conversationId), then string chunks, then the final AIMessage object.\n * Extracts and logs thinking from models like DeepSeek-R1.\n * @private\n */\nfunction streamThroughGraphWithMemory(red, initialState, conversationId, generationId, messageId) {\n    return __asyncGenerator(this, arguments, function* streamThroughGraphWithMemory_1() {\n        var _a, e_1, _b, _c;\n        var _d, _e, _f, _g, _h, _j, _k;\n        try {\n            // Import thinking utilities\n            const { extractThinking, logThinking } = yield __await(Promise.resolve().then(() => __importStar(require('../lib/utils/thinking'))));\n            // Yield metadata first so server can capture conversationId and generationId immediately\n            yield yield __await({ _metadata: true, conversationId, generationId });\n            // Emit initial status\n            if (messageId) {\n                yield yield __await({ _status: true, action: 'processing', description: 'Starting generation' });\n            }\n            // Use LangGraph's streamEvents to get token-level streaming\n            const stream = red_1.redGraph.streamEvents(initialState, { version: \"v1\" });\n            let finalMessage = null;\n            let fullContent = '';\n            let streamedTokens = false;\n            let thinkingBuffer = '';\n            let inThinkingTag = false;\n            let eventCount = 0;\n            let toolIndicatorSent = false;\n            try {\n                for (var _l = true, stream_1 = __asyncValues(stream), stream_1_1; stream_1_1 = yield __await(stream_1.next()), _a = stream_1_1.done, !_a; _l = true) {\n                    _c = stream_1_1.value;\n                    _l = false;\n                    const event = _c;\n                    eventCount++;\n                    // Detect when toolPicker node starts (tool execution indicator)\n                    const nodeName = ((_d = event.metadata) === null || _d === void 0 ? void 0 : _d.langgraph_node) || '';\n                    if (nodeName === 'toolPicker' && event.event === 'on_chain_start' && !toolIndicatorSent) {\n                        // Only yield tool indicator ONCE at the very start\n                        toolIndicatorSent = true;\n                        const toolAction = initialState.toolAction || 'web_search';\n                        const toolMessages = {\n                            'web_search': '🔍 Searching the web...',\n                            'scrape_url': '📄 Reading webpage...',\n                            'system_command': '⚙️ Executing command...'\n                        };\n                        const indicator = toolMessages[toolAction] || '🔧 Using tool...';\n                        // Yield as metadata so it can be displayed differently\n                        yield yield __await({ _toolStatus: true, status: indicator, action: toolAction });\n                        console.log(`[Streaming] Tool indicator: ${indicator}`);\n                    }\n                    // Filter out LLM calls from router and toolPicker nodes (classification/tool selection)\n                    // Check multiple event properties to identify the source node\n                    const eventName = event.name || '';\n                    const eventTags = event.tags || [];\n                    const runName = ((_e = event.metadata) === null || _e === void 0 ? void 0 : _e.langgraph_node) || '';\n                    // A node is router/toolPicker if any identifier contains those strings\n                    const isRouterOrToolPicker = eventName.toLowerCase().includes('router') ||\n                        eventName.toLowerCase().includes('toolpicker') ||\n                        runName.toLowerCase().includes('router') ||\n                        runName.toLowerCase().includes('toolpicker') ||\n                        eventTags.some((tag) => tag.toLowerCase().includes('router') || tag.toLowerCase().includes('toolpicker'));\n                    // Yield streaming content chunks (for models that stream tokens)\n                    // But only from the chat node, not router/toolPicker\n                    if (event.event === \"on_llm_stream\" && ((_g = (_f = event.data) === null || _f === void 0 ? void 0 : _f.chunk) === null || _g === void 0 ? void 0 : _g.content) && !isRouterOrToolPicker) {\n                        let content = event.data.chunk.content;\n                        // Handle thinking tags in streamed content\n                        // We DON'T store thinking in fullContent - it will be stored separately\n                        // Only stream and store the cleaned content for conversation context\n                        for (let i = 0; i < content.length; i++) {\n                            const char = content[i];\n                            // Check for opening think tag\n                            if (!inThinkingTag && content.slice(i, i + 7) === '<think>') {\n                                inThinkingTag = true;\n                                i += 6; // Skip the tag\n                                // Emit status that thinking is starting\n                                if (messageId) {\n                                    yield yield __await({ _status: true, action: 'thinking', description: 'Reasoning through the problem' });\n                                    process.stdout.write(`[Respond] Streaming thinking: 0 chars\\r`);\n                                }\n                                continue;\n                            }\n                            // Check for closing think tag\n                            if (inThinkingTag && content.slice(i, i + 8) === '</think>') {\n                                if (messageId) {\n                                    process.stdout.write(`\\n[Respond] Thinking complete: ${thinkingBuffer.length} chars\\n`);\n                                }\n                                inThinkingTag = false;\n                                i += 7; // Skip the tag\n                                // Log the accumulated thinking\n                                if (thinkingBuffer.trim()) {\n                                    logThinking(thinkingBuffer.trim(), 'Chat (Streaming)');\n                                    // Store thinking separately in database\n                                    if (generationId && conversationId) {\n                                        const thinkingContent = thinkingBuffer.trim();\n                                        try {\n                                            const db = yield __await(Promise.resolve().then(() => __importStar(require('../lib/memory/database'))).then(m => m.getDatabase()));\n                                            const thoughtId = yield __await(db.storeThought({\n                                                thoughtId: `thought_${generationId}_${Date.now()}`,\n                                                conversationId,\n                                                generationId,\n                                                source: 'chat',\n                                                content: thinkingContent,\n                                                timestamp: new Date(),\n                                                metadata: {\n                                                    streamChunk: true,\n                                                },\n                                            }));\n                                        }\n                                        catch (err) {\n                                            console.error('[Respond] Failed to store streaming thinking:', err);\n                                        }\n                                    }\n                                }\n                                thinkingBuffer = '';\n                                continue;\n                            }\n                            // Accumulate thinking or stream regular content\n                            if (inThinkingTag) {\n                                thinkingBuffer += char;\n                                // Stream thinking character-by-character via special object\n                                if (messageId) {\n                                    // Update progress indicator without logging each character\n                                    if (thinkingBuffer.length % 100 === 0) {\n                                        process.stdout.write(`[Respond] Streaming thinking: ${thinkingBuffer.length} chars\\r`);\n                                    }\n                                    yield yield __await({ _thinkingChunk: true, content: char });\n                                }\n                            }\n                            else {\n                                // Skip leading whitespace at the start of content\n                                if (!streamedTokens && (char === '\\n' || char === '\\r' || char === ' ')) {\n                                    continue;\n                                }\n                                fullContent += char;\n                                streamedTokens = true;\n                                yield yield __await(char); // Only stream non-thinking content\n                            }\n                        }\n                    }\n                    // Capture the final message when LLM completes - use on_llm_end\n                    // Only from chat node\n                    if (event.event === \"on_llm_end\" && !isRouterOrToolPicker) {\n                        // The AIMessage is nested in the generations array\n                        const generations = (_j = (_h = event.data) === null || _h === void 0 ? void 0 : _h.output) === null || _j === void 0 ? void 0 : _j.generations;\n                        if (generations && generations[0] && ((_k = generations[0][0]) === null || _k === void 0 ? void 0 : _k.message)) {\n                            finalMessage = generations[0][0].message;\n                        }\n                    }\n                }\n            }\n            catch (e_1_1) { e_1 = { error: e_1_1 }; }\n            finally {\n                try {\n                    if (!_l && !_a && (_b = stream_1.return)) yield __await(_b.call(stream_1));\n                }\n                finally { if (e_1) throw e_1.error; }\n            }\n            // If there's remaining thinking content at the end, log it\n            if (thinkingBuffer.trim()) {\n                logThinking(thinkingBuffer.trim(), 'Chat (Streaming)');\n            }\n            // If no tokens were streamed (e.g., when using tool calls like 'speak'),\n            // get the final content and stream it character by character\n            if (!streamedTokens && finalMessage && finalMessage.content) {\n                // Extract thinking for logging (console)\n                const { thinking, cleanedContent } = extractThinking(finalMessage.content);\n                if (thinking) {\n                    logThinking(thinking, 'Chat (Non-streamed)');\n                    // Store thinking separately in database\n                    if (generationId && conversationId) {\n                        try {\n                            const db = yield __await(Promise.resolve().then(() => __importStar(require('../lib/memory/database'))).then(m => m.getDatabase()));\n                            const thoughtId = yield __await(db.storeThought({\n                                thoughtId: `thought_${generationId}`,\n                                conversationId,\n                                generationId,\n                                source: 'chat',\n                                content: thinking,\n                                timestamp: new Date(),\n                                metadata: {\n                                    model: red.localModel.model,\n                                },\n                            }));\n                            console.log(`[Respond] Stored thinking: ${thoughtId}`);\n                            // Publish to Redis for real-time updates\n                            if (messageId) {\n                                console.log(`[Respond] Publishing non-stream thinking to Redis for messageId: ${messageId}, length: ${thinking.length}`);\n                                yield __await(red.messageQueue.publishThinking(messageId, thinking));\n                                console.log(`[Respond] Published non-stream thinking successfully`);\n                            }\n                            else {\n                                console.warn(`[Respond] No messageId provided for non-stream thinking`);\n                            }\n                        }\n                        catch (err) {\n                            console.error('[Respond] Failed to store non-streamed thinking:', err);\n                        }\n                    }\n                }\n                // Use CLEANED content (thinking will be stored separately)\n                fullContent = cleanedContent;\n                // Stream the cleaned content for UX\n                const words = cleanedContent.split(' ');\n                for (let i = 0; i < words.length; i++) {\n                    const word = words[i];\n                    yield yield __await(i === 0 ? word : ' ' + word);\n                    // Small delay for smooth streaming effect (optional)\n                    yield __await(new Promise(resolve => setTimeout(resolve, 20)));\n                }\n            }\n            // Store assistant response in memory (after streaming completes)\n            if (fullContent) {\n                // Store content in memory for LLM context (already cleaned in streaming/non-streaming paths)\n                yield __await(red.memory.addMessage(conversationId, {\n                    role: 'assistant',\n                    content: fullContent,\n                    timestamp: Date.now()\n                }));\n                // Complete the generation\n                yield __await(red.logger.completeGeneration(generationId, {\n                    response: fullContent,\n                    thinking: thinkingBuffer || undefined,\n                    route: initialState.toolAction || 'chat',\n                    toolsUsed: initialState.selectedTools,\n                    model: red.localModel.model,\n                    tokens: finalMessage === null || finalMessage === void 0 ? void 0 : finalMessage.usage_metadata,\n                }));\n                // Get message count for title generation\n                const metadata = yield __await(red.memory.getMetadata(conversationId));\n                const messageCount = (metadata === null || metadata === void 0 ? void 0 : metadata.messageCount) || 0;\n                // Trigger background summarization (non-blocking)\n                background.summarizeInBackground(conversationId, red.memory, red.localModel);\n                // Trigger background title generation (non-blocking)\n                background.generateTitleInBackground(conversationId, messageCount, red.memory, red.localModel);\n                // Trigger executive summary generation after 3rd+ message (non-blocking)\n                if (messageCount >= 3) {\n                    background.generateExecutiveSummaryInBackground(conversationId, red.memory, red.localModel);\n                }\n            }\n            // After all chunks are sent, yield the final AIMessage with complete token data\n            if (finalMessage) {\n                yield yield __await(finalMessage);\n            }\n        }\n        catch (error) {\n            // Log the failure and mark generation as failed\n            yield __await(red.logger.failGeneration(generationId, error instanceof Error ? error.message : String(error)));\n            throw error; // Re-throw to propagate the error\n        }\n    });\n}\n"],"names":[],"mappings":"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","ignoreList":[0],"debugId":null}},
    {"offset": {"line": 4925, "column": 0}, "map": {"version":3,"sources":["file:///home/alpha/code/%40redbtn/webapp/node_modules/%40redbtn/ai/dist/lib/logs/colors.js"],"sourcesContent":["\"use strict\";\n/**\n * Color tag utilities for log messages\n *\n * Frontends can parse these tags and apply colors\n * Servers can strip them for plain text output\n */\nObject.defineProperty(exports, \"__esModule\", { value: true });\nexports.ColorTags = void 0;\nexports.stripColorTags = stripColorTags;\nexports.parseColorTagsToAnsi = parseColorTagsToAnsi;\nexports.parseColorTagsToHtml = parseColorTagsToHtml;\nexports.ColorTags = {\n    // Basic colors\n    red: (text) => `<red>${text}</red>`,\n    green: (text) => `<green>${text}</green>`,\n    yellow: (text) => `<yellow>${text}</yellow>`,\n    blue: (text) => `<blue>${text}</blue>`,\n    magenta: (text) => `<magenta>${text}</magenta>`,\n    cyan: (text) => `<cyan>${text}</cyan>`,\n    white: (text) => `<white>${text}</white>`,\n    gray: (text) => `<gray>${text}</gray>`,\n    // Styles\n    bold: (text) => `<bold>${text}</bold>`,\n    dim: (text) => `<dim>${text}</dim>`,\n    italic: (text) => `<italic>${text}</italic>`,\n    underline: (text) => `<underline>${text}</underline>`,\n    // Semantic colors\n    error: (text) => `<red>${text}</red>`,\n    success: (text) => `<green>${text}</green>`,\n    warning: (text) => `<yellow>${text}</yellow>`,\n    info: (text) => `<cyan>${text}</cyan>`,\n    debug: (text) => `<dim>${text}</dim>`,\n};\n/**\n * Strip all color tags from text\n */\nfunction stripColorTags(text) {\n    return text.replace(/<\\/?[a-z]+>/gi, '');\n}\n/**\n * Parse color tags into ANSI codes for terminal output\n */\nfunction parseColorTagsToAnsi(text) {\n    const ansiCodes = {\n        red: '\\x1b[31m',\n        green: '\\x1b[32m',\n        yellow: '\\x1b[33m',\n        blue: '\\x1b[34m',\n        magenta: '\\x1b[35m',\n        cyan: '\\x1b[36m',\n        white: '\\x1b[37m',\n        gray: '\\x1b[90m',\n        bold: '\\x1b[1m',\n        dim: '\\x1b[2m',\n        italic: '\\x1b[3m',\n        underline: '\\x1b[4m',\n    };\n    const reset = '\\x1b[0m';\n    let result = text;\n    // Replace opening tags\n    for (const [tag, code] of Object.entries(ansiCodes)) {\n        result = result.replace(new RegExp(`<${tag}>`, 'gi'), code);\n    }\n    // Replace closing tags\n    result = result.replace(/<\\/[a-z]+>/gi, reset);\n    return result;\n}\n/**\n * Parse color tags to HTML/CSS\n */\nfunction parseColorTagsToHtml(text) {\n    const htmlColors = {\n        red: 'color: #ef4444',\n        green: 'color: #10b981',\n        yellow: 'color: #f59e0b',\n        blue: 'color: #3b82f6',\n        magenta: 'color: #a855f7',\n        cyan: 'color: #06b6d4',\n        white: 'color: #ffffff',\n        gray: 'color: #6b7280',\n        bold: 'font-weight: bold',\n        dim: 'opacity: 0.6',\n        italic: 'font-style: italic',\n        underline: 'text-decoration: underline',\n    };\n    let result = text;\n    // Replace opening tags with spans\n    for (const [tag, style] of Object.entries(htmlColors)) {\n        result = result.replace(new RegExp(`<${tag}>`, 'gi'), `<span style=\"${style}\">`);\n    }\n    // Replace closing tags\n    result = result.replace(/<\\/[a-z]+>/gi, '</span>');\n    return result;\n}\n"],"names":[],"mappings":"AACA;;;;;CAKC,GACD,OAAO,cAAc,CAAC,SAAS,cAAc;IAAE,OAAO;AAAK;AAC3D,QAAQ,SAAS,GAAG,KAAK;AACzB,QAAQ,cAAc,GAAG;AACzB,QAAQ,oBAAoB,GAAG;AAC/B,QAAQ,oBAAoB,GAAG;AAC/B,QAAQ,SAAS,GAAG;IAChB,eAAe;IACf,KAAK,CAAC,OAAS,CAAC,KAAK,EAAE,KAAK,MAAM,CAAC;IACnC,OAAO,CAAC,OAAS,CAAC,OAAO,EAAE,KAAK,QAAQ,CAAC;IACzC,QAAQ,CAAC,OAAS,CAAC,QAAQ,EAAE,KAAK,SAAS,CAAC;IAC5C,MAAM,CAAC,OAAS,CAAC,MAAM,EAAE,KAAK,OAAO,CAAC;IACtC,SAAS,CAAC,OAAS,CAAC,SAAS,EAAE,KAAK,UAAU,CAAC;IAC/C,MAAM,CAAC,OAAS,CAAC,MAAM,EAAE,KAAK,OAAO,CAAC;IACtC,OAAO,CAAC,OAAS,CAAC,OAAO,EAAE,KAAK,QAAQ,CAAC;IACzC,MAAM,CAAC,OAAS,CAAC,MAAM,EAAE,KAAK,OAAO,CAAC;IACtC,SAAS;IACT,MAAM,CAAC,OAAS,CAAC,MAAM,EAAE,KAAK,OAAO,CAAC;IACtC,KAAK,CAAC,OAAS,CAAC,KAAK,EAAE,KAAK,MAAM,CAAC;IACnC,QAAQ,CAAC,OAAS,CAAC,QAAQ,EAAE,KAAK,SAAS,CAAC;IAC5C,WAAW,CAAC,OAAS,CAAC,WAAW,EAAE,KAAK,YAAY,CAAC;IACrD,kBAAkB;IAClB,OAAO,CAAC,OAAS,CAAC,KAAK,EAAE,KAAK,MAAM,CAAC;IACrC,SAAS,CAAC,OAAS,CAAC,OAAO,EAAE,KAAK,QAAQ,CAAC;IAC3C,SAAS,CAAC,OAAS,CAAC,QAAQ,EAAE,KAAK,SAAS,CAAC;IAC7C,MAAM,CAAC,OAAS,CAAC,MAAM,EAAE,KAAK,OAAO,CAAC;IACtC,OAAO,CAAC,OAAS,CAAC,KAAK,EAAE,KAAK,MAAM,CAAC;AACzC;AACA;;CAEC,GACD,SAAS,eAAe,IAAI;IACxB,OAAO,KAAK,OAAO,CAAC,iBAAiB;AACzC;AACA;;CAEC,GACD,SAAS,qBAAqB,IAAI;IAC9B,MAAM,YAAY;QACd,KAAK;QACL,OAAO;QACP,QAAQ;QACR,MAAM;QACN,SAAS;QACT,MAAM;QACN,OAAO;QACP,MAAM;QACN,MAAM;QACN,KAAK;QACL,QAAQ;QACR,WAAW;IACf;IACA,MAAM,QAAQ;IACd,IAAI,SAAS;IACb,uBAAuB;IACvB,KAAK,MAAM,CAAC,KAAK,KAAK,IAAI,OAAO,OAAO,CAAC,WAAY;QACjD,SAAS,OAAO,OAAO,CAAC,IAAI,OAAO,CAAC,CAAC,EAAE,IAAI,CAAC,CAAC,EAAE,OAAO;IAC1D;IACA,uBAAuB;IACvB,SAAS,OAAO,OAAO,CAAC,gBAAgB;IACxC,OAAO;AACX;AACA;;CAEC,GACD,SAAS,qBAAqB,IAAI;IAC9B,MAAM,aAAa;QACf,KAAK;QACL,OAAO;QACP,QAAQ;QACR,MAAM;QACN,SAAS;QACT,MAAM;QACN,OAAO;QACP,MAAM;QACN,MAAM;QACN,KAAK;QACL,QAAQ;QACR,WAAW;IACf;IACA,IAAI,SAAS;IACb,kCAAkC;IAClC,KAAK,MAAM,CAAC,KAAK,MAAM,IAAI,OAAO,OAAO,CAAC,YAAa;QACnD,SAAS,OAAO,OAAO,CAAC,IAAI,OAAO,CAAC,CAAC,EAAE,IAAI,CAAC,CAAC,EAAE,OAAO,CAAC,aAAa,EAAE,MAAM,EAAE,CAAC;IACnF;IACA,uBAAuB;IACvB,SAAS,OAAO,OAAO,CAAC,gBAAgB;IACxC,OAAO;AACX","ignoreList":[0],"debugId":null}},
    {"offset": {"line": 5021, "column": 0}, "map": {"version":3,"sources":["file:///home/alpha/code/%40redbtn/webapp/node_modules/%40redbtn/ai/dist/lib/logs/index.js"],"sourcesContent":["\"use strict\";\n/**\n * Red AI Logging System\n *\n * The most fantastic logging system known to man.\n */\nvar __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {\n    if (k2 === undefined) k2 = k;\n    var desc = Object.getOwnPropertyDescriptor(m, k);\n    if (!desc || (\"get\" in desc ? !m.__esModule : desc.writable || desc.configurable)) {\n      desc = { enumerable: true, get: function() { return m[k]; } };\n    }\n    Object.defineProperty(o, k2, desc);\n}) : (function(o, m, k, k2) {\n    if (k2 === undefined) k2 = k;\n    o[k2] = m[k];\n}));\nvar __exportStar = (this && this.__exportStar) || function(m, exports) {\n    for (var p in m) if (p !== \"default\" && !Object.prototype.hasOwnProperty.call(exports, p)) __createBinding(exports, m, p);\n};\nObject.defineProperty(exports, \"__esModule\", { value: true });\n__exportStar(require(\"./types\"), exports);\n__exportStar(require(\"./logger\"), exports);\n__exportStar(require(\"./colors\"), exports);\n"],"names":[],"mappings":"AACA;;;;CAIC,GACD,IAAI,kBAAkB,4DAAS,yDAAK,eAAe,IAAK,CAAC,OAAO,MAAM,GAAI,SAAS,CAAC,EAAE,CAAC,EAAE,CAAC,EAAE,EAAE;IAC1F,IAAI,OAAO,WAAW,KAAK;IAC3B,IAAI,OAAO,OAAO,wBAAwB,CAAC,GAAG;IAC9C,IAAI,CAAC,QAAQ,CAAC,SAAS,OAAO,CAAC,EAAE,UAAU,GAAG,KAAK,QAAQ,IAAI,KAAK,YAAY,GAAG;QACjF,OAAO;YAAE,YAAY;YAAM,KAAK;gBAAa,OAAO,CAAC,CAAC,EAAE;YAAE;QAAE;IAC9D;IACA,OAAO,cAAc,CAAC,GAAG,IAAI;AACjC,IAAM,SAAS,CAAC,EAAE,CAAC,EAAE,CAAC,EAAE,EAAE;IACtB,IAAI,OAAO,WAAW,KAAK;IAC3B,CAAC,CAAC,GAAG,GAAG,CAAC,CAAC,EAAE;AAChB,CAAE;AACF,IAAI,eAAe,4DAAS,yDAAK,YAAY,IAAK,SAAS,CAAC,EAAE,QAAO;IACjE,IAAK,IAAI,KAAK,EAAG,IAAI,MAAM,aAAa,CAAC,OAAO,SAAS,CAAC,cAAc,CAAC,IAAI,CAAC,UAAS,IAAI,gBAAgB,UAAS,GAAG;AAC3H;AACA,OAAO,cAAc,CAAC,SAAS,cAAc;IAAE,OAAO;AAAK;AAC3D,2HAAiC;AACjC,4HAAkC;AAClC,4HAAkC","ignoreList":[0],"debugId":null}},
    {"offset": {"line": 5054, "column": 0}, "map": {"version":3,"sources":["file:///home/alpha/code/%40redbtn/webapp/node_modules/%40redbtn/ai/dist/lib/logs/persistent-logger.js"],"sourcesContent":["\"use strict\";\nvar __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {\n    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }\n    return new (P || (P = Promise))(function (resolve, reject) {\n        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }\n        function rejected(value) { try { step(generator[\"throw\"](value)); } catch (e) { reject(e); } }\n        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }\n        step((generator = generator.apply(thisArg, _arguments || [])).next());\n    });\n};\nObject.defineProperty(exports, \"__esModule\", { value: true });\nexports.PersistentLogger = void 0;\nconst logger_1 = require(\"./logger\");\nconst database_1 = require(\"../memory/database\");\n/**\n * Enhanced Logger with MongoDB persistence\n *\n * Features:\n * - All original Logger functionality (Redis pub/sub, 30-day TTL)\n * - Async batch writes to MongoDB (5-second intervals)\n * - 6-month TTL in MongoDB (automatic cleanup)\n * - Graceful error handling (Redis always succeeds even if MongoDB fails)\n * - Automatic flush on shutdown\n */\nclass PersistentLogger extends logger_1.Logger {\n    constructor(redis, nodeId = 'default') {\n        super(redis);\n        this.db = (0, database_1.getDatabase)();\n        this.logQueue = [];\n        this.generationQueue = new Map();\n        this.flushInterval = null;\n        this.FLUSH_INTERVAL_MS = 5000; // 5 seconds\n        this.MAX_BATCH_SIZE = 100;\n        this.nodeId = nodeId;\n        this.startFlushInterval();\n    }\n    /**\n     * Start the automatic flush interval\n     */\n    startFlushInterval() {\n        this.flushInterval = setInterval(() => __awaiter(this, void 0, void 0, function* () {\n            yield this.flushQueues();\n        }), this.FLUSH_INTERVAL_MS);\n    }\n    /**\n     * Flush queued logs and generations to MongoDB\n     */\n    flushQueues() {\n        return __awaiter(this, void 0, void 0, function* () {\n            // Flush logs\n            if (this.logQueue.length > 0) {\n                const batch = this.logQueue.splice(0, this.logQueue.length);\n                try {\n                    yield this.db.storeLogs(batch);\n                    console.log(`[PersistentLogger] Persisted ${batch.length} logs to MongoDB`);\n                }\n                catch (error) {\n                    console.error('[PersistentLogger] Failed to persist logs to MongoDB:', error);\n                    // Don't re-queue to avoid infinite growth on persistent failures\n                }\n            }\n            // Flush generations\n            if (this.generationQueue.size > 0) {\n                const generations = Array.from(this.generationQueue.values());\n                this.generationQueue.clear();\n                for (const gen of generations) {\n                    try {\n                        // Check if generation exists, update if it does, insert if not\n                        const existing = yield this.db.getGeneration(gen.generationId);\n                        if (existing) {\n                            yield this.db.updateGenerationStatus(gen.generationId, gen.status, {\n                                endTime: gen.endTime,\n                                duration: gen.duration,\n                                error: gen.error,\n                            });\n                        }\n                        else {\n                            yield this.db.storeGeneration(gen);\n                        }\n                    }\n                    catch (error) {\n                        console.error(`[PersistentLogger] Failed to persist generation ${gen.generationId}:`, error);\n                    }\n                }\n                if (generations.length > 0) {\n                    console.log(`[PersistentLogger] Persisted ${generations.length} generation(s) to MongoDB`);\n                }\n            }\n        });\n    }\n    /**\n     * Convert LogEntry to StoredLog format\n     */\n    convertToStoredLog(logEntry) {\n        return {\n            logId: logEntry.id,\n            generationId: logEntry.generationId,\n            conversationId: logEntry.conversationId,\n            level: this.mapLogLevel(logEntry.level),\n            category: logEntry.category,\n            message: logEntry.message,\n            timestamp: new Date(logEntry.timestamp),\n            nodeId: this.nodeId,\n            metadata: logEntry.metadata,\n        };\n    }\n    /**\n     * Map log levels to StoredLog format\n     */\n    mapLogLevel(level) {\n        const mapped = {\n            'info': 'info',\n            'warn': 'warn',\n            'error': 'error',\n            'debug': 'debug',\n            'trace': 'trace',\n            // Fallback\n            'log': 'info',\n        };\n        return mapped[level] || 'info';\n    }\n    /**\n     * Override log method to also queue for MongoDB persistence\n     */\n    log(params) {\n        const _super = Object.create(null, {\n            log: { get: () => super.log }\n        });\n        return __awaiter(this, void 0, void 0, function* () {\n            // Call parent method (writes to Redis, publishes to pub/sub)\n            yield _super.log.call(this, params);\n            // Queue for MongoDB persistence\n            try {\n                const storedLog = this.convertToStoredLog({\n                    id: `log_${Date.now()}_${Math.random().toString(36).substring(2, 11)}`,\n                    timestamp: Date.now(),\n                    level: params.level,\n                    category: params.category,\n                    message: params.message,\n                    generationId: params.generationId,\n                    conversationId: params.conversationId,\n                    metadata: params.metadata,\n                });\n                this.logQueue.push(storedLog);\n                // Flush immediately if queue is too large\n                if (this.logQueue.length >= this.MAX_BATCH_SIZE) {\n                    yield this.flushQueues();\n                }\n            }\n            catch (error) {\n                console.error('[PersistentLogger] Failed to queue log for MongoDB:', error);\n                // Don't throw - Redis write already succeeded\n            }\n        });\n    }\n    /**\n     * Override startGeneration to also track in MongoDB\n     */\n    startGeneration(conversationId, generationId) {\n        const _super = Object.create(null, {\n            startGeneration: { get: () => super.startGeneration }\n        });\n        return __awaiter(this, void 0, void 0, function* () {\n            const genId = yield _super.startGeneration.call(this, conversationId, generationId);\n            if (genId) {\n                try {\n                    // Queue generation for MongoDB\n                    const dbGeneration = {\n                        generationId: genId,\n                        conversationId,\n                        status: 'pending',\n                        nodeId: this.nodeId,\n                        startTime: new Date(),\n                    };\n                    this.generationQueue.set(genId, dbGeneration);\n                }\n                catch (error) {\n                    console.error('[PersistentLogger] Failed to queue generation for MongoDB:', error);\n                    // Don't throw - Redis write already succeeded\n                }\n            }\n            return genId;\n        });\n    }\n    /**\n     * Override completeGeneration to track in MongoDB\n     */\n    completeGeneration(generationId, data) {\n        const _super = Object.create(null, {\n            completeGeneration: { get: () => super.completeGeneration }\n        });\n        return __awaiter(this, void 0, void 0, function* () {\n            var _a;\n            yield _super.completeGeneration.call(this, generationId, data);\n            try {\n                const existing = this.generationQueue.get(generationId);\n                if (existing) {\n                    existing.status = 'completed';\n                    existing.endTime = new Date();\n                    existing.duration = existing.endTime.getTime() - existing.startTime.getTime();\n                    if (data.tokens) {\n                        existing.tokensUsed = data.tokens.total || 0;\n                    }\n                    existing.model = data.model;\n                }\n                else {\n                    // Create completed entry\n                    this.generationQueue.set(generationId, {\n                        generationId,\n                        conversationId: '',\n                        status: 'completed',\n                        nodeId: this.nodeId,\n                        model: data.model,\n                        startTime: new Date(),\n                        endTime: new Date(),\n                        duration: 0,\n                        tokensUsed: ((_a = data.tokens) === null || _a === void 0 ? void 0 : _a.total) || 0,\n                    });\n                }\n                // Flush immediately on completion\n                yield this.flushQueues();\n            }\n            catch (error) {\n                console.error('[PersistentLogger] Failed to complete generation in MongoDB:', error);\n            }\n        });\n    }\n    /**\n     * Override failGeneration to track in MongoDB\n     */\n    failGeneration(generationId, error) {\n        const _super = Object.create(null, {\n            failGeneration: { get: () => super.failGeneration }\n        });\n        return __awaiter(this, void 0, void 0, function* () {\n            yield _super.failGeneration.call(this, generationId, error);\n            try {\n                const existing = this.generationQueue.get(generationId);\n                if (existing) {\n                    existing.status = 'failed';\n                    existing.endTime = new Date();\n                    existing.duration = existing.endTime.getTime() - existing.startTime.getTime();\n                    existing.error = error;\n                }\n                else {\n                    // Create failed entry\n                    this.generationQueue.set(generationId, {\n                        generationId,\n                        conversationId: '',\n                        status: 'failed',\n                        nodeId: this.nodeId,\n                        startTime: new Date(),\n                        endTime: new Date(),\n                        duration: 0,\n                        error,\n                    });\n                }\n                // Flush immediately on failure\n                yield this.flushQueues();\n            }\n            catch (error) {\n                console.error('[PersistentLogger] Failed to mark generation as failed in MongoDB:', error);\n            }\n        });\n    }\n    /**\n     * Shutdown the logger and flush all pending writes\n     */\n    shutdown() {\n        return __awaiter(this, void 0, void 0, function* () {\n            console.log('[PersistentLogger] Shutting down...');\n            // Stop the flush interval\n            if (this.flushInterval) {\n                clearInterval(this.flushInterval);\n                this.flushInterval = null;\n            }\n            // Flush any remaining queued data\n            yield this.flushQueues();\n            // Close database connection\n            yield this.db.close();\n            console.log('[PersistentLogger] Shutdown complete');\n        });\n    }\n}\nexports.PersistentLogger = PersistentLogger;\n"],"names":[],"mappings":"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","ignoreList":[0],"debugId":null}},
    {"offset": {"line": 5351, "column": 0}, "map": {"version":3,"sources":["file:///home/alpha/code/%40redbtn/webapp/node_modules/%40redbtn/ai/dist/index.js"],"sourcesContent":["\"use strict\";\n/**\n * @file src/red.ts\n * @description The core library for the Red AI agent.\n */\nvar __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {\n    if (k2 === undefined) k2 = k;\n    var desc = Object.getOwnPropertyDescriptor(m, k);\n    if (!desc || (\"get\" in desc ? !m.__esModule : desc.writable || desc.configurable)) {\n      desc = { enumerable: true, get: function() { return m[k]; } };\n    }\n    Object.defineProperty(o, k2, desc);\n}) : (function(o, m, k, k2) {\n    if (k2 === undefined) k2 = k;\n    o[k2] = m[k];\n}));\nvar __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {\n    Object.defineProperty(o, \"default\", { enumerable: true, value: v });\n}) : function(o, v) {\n    o[\"default\"] = v;\n});\nvar __importStar = (this && this.__importStar) || (function () {\n    var ownKeys = function(o) {\n        ownKeys = Object.getOwnPropertyNames || function (o) {\n            var ar = [];\n            for (var k in o) if (Object.prototype.hasOwnProperty.call(o, k)) ar[ar.length] = k;\n            return ar;\n        };\n        return ownKeys(o);\n    };\n    return function (mod) {\n        if (mod && mod.__esModule) return mod;\n        var result = {};\n        if (mod != null) for (var k = ownKeys(mod), i = 0; i < k.length; i++) if (k[i] !== \"default\") __createBinding(result, mod, k[i]);\n        __setModuleDefault(result, mod);\n        return result;\n    };\n})();\nvar __exportStar = (this && this.__exportStar) || function(m, exports) {\n    for (var p in m) if (p !== \"default\" && !Object.prototype.hasOwnProperty.call(exports, p)) __createBinding(exports, m, p);\n};\nvar __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {\n    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }\n    return new (P || (P = Promise))(function (resolve, reject) {\n        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }\n        function rejected(value) { try { step(generator[\"throw\"](value)); } catch (e) { reject(e); } }\n        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }\n        step((generator = generator.apply(thisArg, _arguments || [])).next());\n    });\n};\nObject.defineProperty(exports, \"__esModule\", { value: true });\nexports.Red = exports.extractAndLogThinking = exports.logThinking = exports.extractThinking = exports.PersistentLogger = exports.MessageQueue = exports.DatabaseManager = exports.resetDatabase = exports.getDatabase = void 0;\n// Load environment variables from .env early for library modules\nrequire(\"dotenv/config\");\nconst memory_1 = require(\"./lib/memory/memory\");\nconst queue_1 = require(\"./lib/memory/queue\");\nconst logger_1 = require(\"./lib/logs/logger\");\nconst models_1 = require(\"./lib/models\");\nconst background = __importStar(require(\"./functions/background\"));\nconst respond_1 = require(\"./functions/respond\");\n// Export database utilities for external use\nvar database_1 = require(\"./lib/memory/database\");\nObject.defineProperty(exports, \"getDatabase\", { enumerable: true, get: function () { return database_1.getDatabase; } });\nObject.defineProperty(exports, \"resetDatabase\", { enumerable: true, get: function () { return database_1.resetDatabase; } });\nObject.defineProperty(exports, \"DatabaseManager\", { enumerable: true, get: function () { return database_1.DatabaseManager; } });\n// Export message queue for background processing\nvar queue_2 = require(\"./lib/memory/queue\");\nObject.defineProperty(exports, \"MessageQueue\", { enumerable: true, get: function () { return queue_2.MessageQueue; } });\n// Export logging system\n__exportStar(require(\"./lib/logs\"), exports);\nvar persistent_logger_1 = require(\"./lib/logs/persistent-logger\");\nObject.defineProperty(exports, \"PersistentLogger\", { enumerable: true, get: function () { return persistent_logger_1.PersistentLogger; } });\n// Export thinking utilities for DeepSeek-R1 and similar models\nvar thinking_1 = require(\"./lib/utils/thinking\");\nObject.defineProperty(exports, \"extractThinking\", { enumerable: true, get: function () { return thinking_1.extractThinking; } });\nObject.defineProperty(exports, \"logThinking\", { enumerable: true, get: function () { return thinking_1.logThinking; } });\nObject.defineProperty(exports, \"extractAndLogThinking\", { enumerable: true, get: function () { return thinking_1.extractAndLogThinking; } });\n// --- The Red Library Class ---\n/**\n * The primary class for the Red AI engine. It encapsulates the agent's\n * core logic, state management, and interaction models.\n */\nclass Red {\n    /**\n     * Constructs a new instance of the Red AI engine.\n     * @param config The configuration object required for initialization.\n     */\n    constructor(config) {\n        this.isLoaded = false;\n        this.isThinking = false;\n        this.baseState = {};\n        this.config = config;\n        // Initialize the model instances\n        this.localModel = (0, models_1.createLocalModel)(config);\n        this.openAIModel = (0, models_1.createOpenAIModel)();\n        this.geminiModel = (0, models_1.createGeminiModel)();\n        // Initialize memory manager\n        this.memory = new memory_1.MemoryManager(config.redisUrl);\n        // Initialize message queue with same Redis connection\n        const redis = new (require('ioredis'))(config.redisUrl);\n        this.redis = redis;\n        this.messageQueue = new queue_1.MessageQueue(redis);\n        // Initialize logger with same Redis connection\n        this.logger = new logger_1.Logger(redis);\n    }\n    // --- Private Internal Methods ---\n    /**\n     * The internal engine that executes a specified graph with the given state and options.\n     * All graph-running logic is centralized here.\n     * @private\n     */\n    _invoke(graphName, localState, options) {\n        return __awaiter(this, void 0, void 0, function* () {\n            if (!this.isLoaded) {\n                throw new Error(\"Red instance is not loaded. Please call load() before invoking a graph.\");\n            }\n            // TODO: Implement the actual LangGraph execution logic.\n            // This function will select a graph from a library based on `graphName`,\n            // merge the `baseState` and `localState`, and execute the graph.\n            const result = {\n                output: `Output from ${graphName}`,\n                timestamp: new Date().toISOString()\n            };\n            return result;\n        });\n    }\n    // --- Public API ---\n    /**\n     * Initializes the Red instance by connecting to data sources and loading the base state.\n     * This method must be called before any other operations.\n     * @param nodeId An optional identifier for this specific instance, used for distributed systems.\n     */\n    load(nodeId) {\n        return __awaiter(this, void 0, void 0, function* () {\n            if (this.isLoaded) {\n                return;\n            }\n            if (nodeId) {\n                this.nodeId = nodeId;\n            }\n            else {\n                // Generate a default nodeId if not provided\n                this.nodeId = `node_${Date.now()}_${Math.random().toString(36).substring(2, 9)}`;\n            }\n            console.log(`Loading base state for node: ${this.nodeId}...`);\n            // TODO: Implement the actual state fetching logic from Redis using `this.config.redisUrl`.\n            // The `nodeId` can be used to fetch a specific state for recovery or distributed operation.\n            this.baseState = { loadedAt: new Date(), nodeId: this.nodeId };\n            this.isLoaded = true;\n            // Start heartbeat to register node as active\n            this.heartbeatInterval = background.startHeartbeat(this.nodeId, this.redis);\n            console.log('Base state loaded successfully.');\n        });\n    }\n    /**\n     * Gets a list of all currently active nodes.\n     * @returns Array of active node IDs\n     */\n    getActiveNodes() {\n        return __awaiter(this, void 0, void 0, function* () {\n            return background.getActiveNodes(this.redis);\n        });\n    }\n    /**\n     * Starts the autonomous, continuous \"thinking\" loop. The loop runs internally\n     * until `stopThinking()` is called.\n     */\n    think() {\n        return __awaiter(this, void 0, void 0, function* () {\n            if (!this.isLoaded) {\n                throw new Error(\"Red instance is not loaded. Please call load() before thinking.\");\n            }\n            if (this.isThinking) {\n                return;\n            }\n            this.isThinking = true;\n            do {\n                yield this._invoke('cognitionGraph', { cycleType: 'autonomous' });\n                // Delay between cycles to prevent runaway processes and manage resource usage.\n                yield new Promise(resolve => setTimeout(resolve, 2000)); // 2-second delay\n            } while (this.isThinking);\n        });\n    }\n    /**\n     * Signals the internal `think()` loop to stop gracefully after completing its current cycle.\n     */\n    stopThinking() {\n        if (!this.isThinking) {\n            return;\n        }\n        this.isThinking = false;\n    }\n    /**\n     * Gracefully shuts down the Red instance, stopping heartbeat and cleaning up resources.\n     */\n    shutdown() {\n        return __awaiter(this, void 0, void 0, function* () {\n            console.log(`[Red] Shutting down node: ${this.nodeId}...`);\n            // Stop thinking if active\n            this.stopThinking();\n            // Stop heartbeat\n            yield background.stopHeartbeat(this.nodeId, this.redis, this.heartbeatInterval);\n            this.heartbeatInterval = undefined;\n            // Close Redis connection\n            if (this.redis) {\n                yield this.redis.quit();\n            }\n            this.isLoaded = false;\n            console.log('[Red] Shutdown complete');\n        });\n    }\n    /**\n     * Handles a direct, on-demand request from a user-facing application.\n     * Automatically manages conversation history, memory, and summarization.\n     * @param query The user's input or request data (must have a 'message' property)\n     * @param options Metadata about the source of the request and conversation settings\n     * @returns For non-streaming: the full AIMessage object with content, tokens, metadata, and conversationId.\n     *          For streaming: an async generator that yields metadata first (with conversationId), then string chunks, then finally the full AIMessage.\n     */\n    respond(query_1) {\n        return __awaiter(this, arguments, void 0, function* (query, options = {}) {\n            return (0, respond_1.respond)(this, query, options);\n        });\n    }\n    /**\n     * Set a custom title for a conversation (set by user)\n     * This prevents automatic title generation from overwriting it\n     * @param conversationId The conversation ID\n     * @param title The custom title to set\n     */\n    setConversationTitle(conversationId, title) {\n        return __awaiter(this, void 0, void 0, function* () {\n            return background.setConversationTitle(conversationId, title, this.memory);\n        });\n    }\n    /**\n     * Get the title for a conversation\n     * @param conversationId The conversation ID\n     * @returns The title or null if not set\n     */\n    getConversationTitle(conversationId) {\n        return __awaiter(this, void 0, void 0, function* () {\n            return background.getConversationTitle(conversationId, this.memory);\n        });\n    }\n}\nexports.Red = Red;\n"],"names":[],"mappings":"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","ignoreList":[0],"debugId":null}}]
}
module.exports=[70406,(e,t,n)=>{t.exports=e.x("next/dist/compiled/@opentelemetry/api",()=>require("next/dist/compiled/@opentelemetry/api"))},93695,(e,t,n)=>{t.exports=e.x("next/dist/shared/lib/no-fallback-error.external.js",()=>require("next/dist/shared/lib/no-fallback-error.external.js"))},18622,(e,t,n)=>{t.exports=e.x("next/dist/compiled/next-server/app-page-turbo.runtime.prod.js",()=>require("next/dist/compiled/next-server/app-page-turbo.runtime.prod.js"))},56704,(e,t,n)=>{t.exports=e.x("next/dist/server/app-render/work-async-storage.external.js",()=>require("next/dist/server/app-render/work-async-storage.external.js"))},32319,(e,t,n)=>{t.exports=e.x("next/dist/server/app-render/work-unit-async-storage.external.js",()=>require("next/dist/server/app-render/work-unit-async-storage.external.js"))},20635,(e,t,n)=>{t.exports=e.x("next/dist/server/app-render/action-async-storage.external.js",()=>require("next/dist/server/app-render/action-async-storage.external.js"))},24725,(e,t,n)=>{t.exports=e.x("next/dist/server/app-render/after-task-async-storage.external.js",()=>require("next/dist/server/app-render/after-task-async-storage.external.js"))},14747,(e,t,n)=>{t.exports=e.x("path",()=>require("path"))},24361,(e,t,n)=>{t.exports=e.x("util",()=>require("util"))},54799,(e,t,n)=>{t.exports=e.x("crypto",()=>require("crypto"))},81769,(e,t,n)=>{t.exports=e.x("mongodb",()=>require("mongodb"))},79334,(e,t,n)=>{"use strict";var i=e.e&&e.e.__awaiter||function(e,t,n,i){return new(n||(n=Promise))(function(s,r){function o(e){try{d(i.next(e))}catch(e){r(e)}}function a(e){try{d(i.throw(e))}catch(e){r(e)}}function d(e){var t;e.done?s(e.value):((t=e.value)instanceof n?t:new n(function(e){e(t)})).then(o,a)}d((i=i.apply(e,t||[])).next())})};Object.defineProperty(n,"__esModule",{value:!0}),n.DatabaseManager=void 0,n.getDatabase=function(e,t){if(!o){let n=process.env.MONGODB_URI||process.env.MONGODB_URL||"mongodb://localhost:27017",i=e||n,s=t;if(!s){let e=i.match(/\/([^/?]+)(\?|$)/);s=e&&e[1]?e[1]:process.env.MONGODB_NAME||"redbtn_ai"}o=new r(i,s)}return o},n.resetDatabase=function(){o=null};let s=e.r(81769);class r{constructor(e="mongodb://localhost:27017",t="redbtn_ai"){this.mongoUrl=e,this.dbName=t,this.client=null,this.db=null,this.collections=new Map,this.connectionPromise=null,this.COLLECTIONS={MESSAGES:"messages",CONVERSATIONS:"conversations",LOGS:"logs",GENERATIONS:"generations",THOUGHTS:"thoughts"}}connect(){return i(this,void 0,void 0,function*(){return this.connectionPromise||(this.connectionPromise=i(this,void 0,void 0,function*(){try{console.log("[Database] Connecting to MongoDB..."),this.mongoUrl.includes("@"),this.client=new s.MongoClient(this.mongoUrl,{serverSelectionTimeoutMS:5e3,connectTimeoutMS:1e4}),yield this.client.connect(),yield this.client.db("admin").admin().ping(),this.db=this.client.db(this.dbName),yield this.initializeCollections(),console.log("[Database] Connected to MongoDB successfully")}catch(e){throw console.error("[Database] Failed to connect to MongoDB:",e),console.error("[Database] Make sure MongoDB is running and authentication is configured correctly"),console.error("[Database] Current connection string:",this.mongoUrl.replace(/\/\/([^:]+):([^@]+)@/,"//$1:****@")),this.connectionPromise=null,e}})),this.connectionPromise})}initializeCollections(){return i(this,void 0,void 0,function*(){if(!this.db)throw Error("Database not connected");let e=this.db.collection(this.COLLECTIONS.MESSAGES);yield e.createIndex({conversationId:1,timestamp:1}),yield e.createIndex({timestamp:-1}),this.collections.set(this.COLLECTIONS.MESSAGES,e);let t=this.db.collection(this.COLLECTIONS.CONVERSATIONS);yield t.createIndex({conversationId:1},{unique:!0}),yield t.createIndex({updatedAt:-1}),yield t.createIndex({userId:1}),this.collections.set(this.COLLECTIONS.CONVERSATIONS,t);let n=this.db.collection(this.COLLECTIONS.LOGS);yield n.createIndex({timestamp:-1}),yield n.createIndex({generationId:1}),yield n.createIndex({conversationId:1}),yield n.createIndex({level:1}),yield n.createIndex({category:1}),yield n.createIndex({logId:1},{unique:!0}),yield n.createIndex({timestamp:1},{expireAfterSeconds:15552e3}),this.collections.set(this.COLLECTIONS.LOGS,n);let i=this.db.collection(this.COLLECTIONS.GENERATIONS);yield i.createIndex({generationId:1},{unique:!0}),yield i.createIndex({conversationId:1}),yield i.createIndex({status:1}),yield i.createIndex({startTime:-1}),yield i.createIndex({nodeId:1}),this.collections.set(this.COLLECTIONS.GENERATIONS,i);let s=this.db.collection(this.COLLECTIONS.THOUGHTS);yield s.createIndex({thoughtId:1},{unique:!0}),yield s.createIndex({conversationId:1}),yield s.createIndex({messageId:1}),yield s.createIndex({generationId:1}),yield s.createIndex({timestamp:-1}),yield s.createIndex({source:1}),this.collections.set(this.COLLECTIONS.THOUGHTS,s)})}ensureConnected(){return i(this,void 0,void 0,function*(){this.db&&0!==this.collections.size||(yield this.connect())})}getCollection(e){let t=this.collections.get(e);if(!t)throw Error(`Collection ${e} not initialized`);return t}collection(e){return i(this,void 0,void 0,function*(){if(yield this.ensureConnected(),!this.collections.has(e)){let t=this.db.collection(e);this.collections.set(e,t)}return this.getCollection(e)})}insertOne(e,t){return i(this,void 0,void 0,function*(){yield this.ensureConnected();let n=yield this.collection(e),i=Object.assign(Object.assign({},t),{createdAt:t.createdAt||new Date,updatedAt:t.updatedAt||new Date});return(yield n.insertOne(i)).insertedId})}insertMany(e,t){return i(this,void 0,void 0,function*(){if(0===t.length)return[];yield this.ensureConnected();let n=yield this.collection(e),i=t.map(e=>Object.assign(Object.assign({},e),{createdAt:e.createdAt||new Date,updatedAt:e.updatedAt||new Date}));return Object.values((yield n.insertMany(i)).insertedIds)})}find(e){return i(this,arguments,void 0,function*(e,t={},n){yield this.ensureConnected();let i=yield this.collection(e);return yield i.find(t,n).toArray()})}findOne(e,t){return i(this,void 0,void 0,function*(){yield this.ensureConnected();let n=yield this.collection(e);return yield n.findOne(t)})}updateMany(e,t,n){return i(this,void 0,void 0,function*(){yield this.ensureConnected();let i=yield this.collection(e),s=Object.assign(Object.assign({},n),{$set:Object.assign(Object.assign({},n.$set||{}),{updatedAt:new Date})});return(yield i.updateMany(t,s)).modifiedCount})}updateOne(e,t,n){return i(this,arguments,void 0,function*(e,t,n,i=!1){yield this.ensureConnected();let s=yield this.collection(e),r=Object.assign(Object.assign({},n),{$set:Object.assign(Object.assign({},n.$set||{}),{updatedAt:new Date}),$setOnInsert:Object.assign(Object.assign({},n.$setOnInsert||{}),{createdAt:new Date})}),o=yield s.updateOne(t,r,{upsert:i});return o.modifiedCount>0||i&&o.upsertedCount>0})}deleteMany(e,t){return i(this,void 0,void 0,function*(){yield this.ensureConnected();let n=yield this.collection(e);return(yield n.deleteMany(t)).deletedCount})}deleteOne(e,t){return i(this,void 0,void 0,function*(){yield this.ensureConnected();let n=yield this.collection(e);return(yield n.deleteOne(t)).deletedCount>0})}count(e){return i(this,arguments,void 0,function*(e,t={}){yield this.ensureConnected();let n=yield this.collection(e);return yield n.countDocuments(t)})}storeMessage(e){return i(this,void 0,void 0,function*(){yield this.ensureConnected();let t=this.getCollection(this.COLLECTIONS.MESSAGES),n=yield t.insertOne(Object.assign(Object.assign({},e),{createdAt:new Date,updatedAt:new Date})),i=this.getCollection(this.COLLECTIONS.CONVERSATIONS);return yield i.updateOne({conversationId:e.conversationId},{$set:{updatedAt:new Date},$inc:{"metadata.messageCount":1}},{upsert:!0}),n.insertedId})}storeMessages(e){return i(this,void 0,void 0,function*(){if(0===e.length)return;yield this.ensureConnected();let t=this.getCollection(this.COLLECTIONS.MESSAGES);yield t.insertMany(e.map(e=>Object.assign(Object.assign({},e),{createdAt:new Date,updatedAt:new Date})));let n=e[0].conversationId,i=this.getCollection(this.COLLECTIONS.CONVERSATIONS);yield i.updateOne({conversationId:n},{$set:{updatedAt:new Date},$inc:{"metadata.messageCount":e.length}},{upsert:!0})})}getMessages(e){return i(this,arguments,void 0,function*(e,t=0,n=0){yield this.ensureConnected();let i=this.getCollection(this.COLLECTIONS.MESSAGES).find({conversationId:e}).sort({timestamp:1}).skip(n);return t>0&&i.limit(t),yield i.toArray()})}getLastMessages(e,t){return i(this,void 0,void 0,function*(){yield this.ensureConnected();let n=this.getCollection(this.COLLECTIONS.MESSAGES);return(yield n.find({conversationId:e}).sort({timestamp:-1}).limit(t).toArray()).reverse()})}getMessageCount(e){return i(this,void 0,void 0,function*(){yield this.ensureConnected();let t=this.getCollection(this.COLLECTIONS.MESSAGES);return yield t.countDocuments({conversationId:e})})}upsertConversation(e){return i(this,void 0,void 0,function*(){yield this.ensureConnected();let t=this.getCollection(this.COLLECTIONS.CONVERSATIONS);yield t.updateOne({conversationId:e.conversationId},{$set:Object.assign(Object.assign({},e),{updatedAt:new Date}),$setOnInsert:{createdAt:new Date}},{upsert:!0})})}updateConversationTitle(e,t){return i(this,void 0,void 0,function*(){yield this.ensureConnected();let n=this.getCollection(this.COLLECTIONS.CONVERSATIONS);yield n.updateOne({conversationId:e},{$set:{title:t,updatedAt:new Date}})})}getConversation(e){return i(this,void 0,void 0,function*(){yield this.ensureConnected();let t=this.getCollection(this.COLLECTIONS.CONVERSATIONS);return yield t.findOne({conversationId:e})})}getConversations(){return i(this,arguments,void 0,function*(e=50,t=0){yield this.ensureConnected();let n=this.getCollection(this.COLLECTIONS.CONVERSATIONS);return yield n.find({}).sort({updatedAt:-1}).skip(t).limit(e).toArray()})}deleteConversation(e){return i(this,void 0,void 0,function*(){yield this.ensureConnected();let t=this.getCollection(this.COLLECTIONS.MESSAGES),n=this.getCollection(this.COLLECTIONS.CONVERSATIONS);yield t.deleteMany({conversationId:e}),yield n.deleteOne({conversationId:e})})}storeLog(e){return i(this,void 0,void 0,function*(){return yield this.insertOne(this.COLLECTIONS.LOGS,e)})}storeLogs(e){return i(this,void 0,void 0,function*(){return yield this.insertMany(this.COLLECTIONS.LOGS,e)})}getLogsByGeneration(e,t){return i(this,void 0,void 0,function*(){yield this.ensureConnected();let n=this.getCollection(this.COLLECTIONS.LOGS).find({generationId:e}).sort({timestamp:1});return t&&n.limit(t),yield n.toArray()})}getLogsByConversation(e,t){return i(this,void 0,void 0,function*(){yield this.ensureConnected();let n=this.getCollection(this.COLLECTIONS.LOGS).find({conversationId:e}).sort({timestamp:-1});return t&&n.limit(t),yield n.toArray()})}getLogsByLevel(e,t){return i(this,void 0,void 0,function*(){yield this.ensureConnected();let n=this.getCollection(this.COLLECTIONS.LOGS).find({level:e}).sort({timestamp:-1});return t&&n.limit(t),yield n.toArray()})}getLogs(){return i(this,arguments,void 0,function*(e={},t=100,n=0){return yield this.find(this.COLLECTIONS.LOGS,e,{sort:{timestamp:-1},limit:t,skip:n})})}deleteOldLogs(e){return i(this,void 0,void 0,function*(){return yield this.deleteMany(this.COLLECTIONS.LOGS,{timestamp:{$lt:e}})})}storeGeneration(e){return i(this,void 0,void 0,function*(){return yield this.insertOne(this.COLLECTIONS.GENERATIONS,e)})}updateGenerationStatus(e,t,n){return i(this,void 0,void 0,function*(){return yield this.updateOne(this.COLLECTIONS.GENERATIONS,{generationId:e},{$set:Object.assign(Object.assign({status:t},"completed"===t||"failed"===t?{endTime:new Date}:{}),n)})})}getGeneration(e){return i(this,void 0,void 0,function*(){return yield this.findOne(this.COLLECTIONS.GENERATIONS,{generationId:e})})}getGenerationsByConversation(e,t){return i(this,void 0,void 0,function*(){return yield this.find(this.COLLECTIONS.GENERATIONS,{conversationId:e},{sort:{startTime:-1},limit:t})})}getActiveGenerations(){return i(this,void 0,void 0,function*(){return yield this.find(this.COLLECTIONS.GENERATIONS,{status:{$in:["pending","streaming"]}},{sort:{startTime:-1}})})}deleteOldGenerations(e){return i(this,void 0,void 0,function*(){return yield this.deleteMany(this.COLLECTIONS.GENERATIONS,{startTime:{$lt:e},status:{$in:["completed","failed"]}})})}storeThought(e){return i(this,void 0,void 0,function*(){return yield this.insertOne(this.COLLECTIONS.THOUGHTS,e)})}storeThoughts(e){return i(this,void 0,void 0,function*(){0!==e.length&&(yield this.insertMany(this.COLLECTIONS.THOUGHTS,e))})}getThought(e){return i(this,void 0,void 0,function*(){return yield this.findOne(this.COLLECTIONS.THOUGHTS,{thoughtId:e})})}getThoughtsByMessage(e){return i(this,void 0,void 0,function*(){return yield this.find(this.COLLECTIONS.THOUGHTS,{messageId:e},{sort:{timestamp:1}})})}getThoughtsByConversation(e,t){return i(this,void 0,void 0,function*(){return yield this.find(this.COLLECTIONS.THOUGHTS,{conversationId:e},{sort:{timestamp:-1},limit:t})})}getThoughtsByGeneration(e){return i(this,void 0,void 0,function*(){return yield this.find(this.COLLECTIONS.THOUGHTS,{generationId:e},{sort:{timestamp:1}})})}getThoughtsBySource(e,t,n){return i(this,void 0,void 0,function*(){let i={source:e};return t&&(i.conversationId=t),yield this.find(this.COLLECTIONS.THOUGHTS,i,{sort:{timestamp:-1},limit:n})})}deleteOldThoughts(e){return i(this,void 0,void 0,function*(){return yield this.deleteMany(this.COLLECTIONS.THOUGHTS,{timestamp:{$lt:e}})})}close(){return i(this,void 0,void 0,function*(){this.client&&(yield this.client.close(),this.client=null,this.db=null,this.collections.clear(),this.connectionPromise=null,console.log("[Database] Closed MongoDB connection"))})}}n.DatabaseManager=r;let o=null},14517,(e,t,n)=>{},70431,e=>{"use strict";e.s(["handler",()=>L,"patchFetch",()=>N,"routeModule",()=>f,"serverHooks",()=>T,"workAsyncStorage",()=>E,"workUnitAsyncStorage",()=>I],70431);var t=e.i(47909),n=e.i(74017),i=e.i(96250),s=e.i(59756),r=e.i(61916),o=e.i(69741),a=e.i(16795),d=e.i(87718),l=e.i(95169),c=e.i(47587),u=e.i(66012),h=e.i(70101),O=e.i(26937),p=e.i(10372),C=e.i(93695);e.i(52474);var g=e.i(220);e.s(["GET",()=>S],81511);var v=e.i(89171),y=e.i(95669);async function S(e,{params:t}){try{let{id:e}=await t;if(!e)return v.NextResponse.json({error:"Conversation ID is required"},{status:400});try{let t=(0,y.getDatabase)(),n=(await t.getMessages(e)).map(e=>({role:e.role,content:e.content,timestamp:e.timestamp.getTime(),metadata:e.metadata}));return v.NextResponse.json({conversationId:e,messages:n,total:n.length})}catch(t){return console.warn("[API] MongoDB not available for message fetch:",t instanceof Error?t.message:String(t)),v.NextResponse.json({conversationId:e,messages:[],total:0,note:"MongoDB not available, messages only in Redis cache"})}}catch(e){return console.error("[API] Error fetching messages:",e),v.NextResponse.json({error:"Failed to fetch messages",details:e instanceof Error?e.message:String(e)},{status:500})}}var m=e.i(81511);let f=new t.AppRouteRouteModule({definition:{kind:n.RouteKind.APP_ROUTE,page:"/api/v1/conversations/[id]/messages/route",pathname:"/api/v1/conversations/[id]/messages",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/src/app/api/v1/conversations/[id]/messages/route.ts",nextConfigOutput:"",userland:m}),{workAsyncStorage:E,workUnitAsyncStorage:I,serverHooks:T}=f;function N(){return(0,i.patchFetch)({workAsyncStorage:E,workUnitAsyncStorage:I})}async function L(e,t,i){var v;let y="/api/v1/conversations/[id]/messages/route";y=y.replace(/\/index$/,"")||"/";let S=await f.prepare(e,t,{srcPage:y,multiZoneDraftMode:!1});if(!S)return t.statusCode=400,t.end("Bad Request"),null==i.waitUntil||i.waitUntil.call(i,Promise.resolve()),null;let{buildId:m,params:E,nextConfig:I,isDraftMode:T,prerenderManifest:N,routerServerContext:L,isOnDemandRevalidate:x,revalidateOnlyGenerated:A,resolvedPathname:b}=S,R=(0,o.normalizeAppPath)(y),w=!!(N.dynamicRoutes[R]||N.routes[b]);if(w&&!T){let e=!!N.routes[b],t=N.dynamicRoutes[R];if(t&&!1===t.fallback&&!e)throw new C.NoFallbackError}let M=null;!w||f.isDev||T||(M="/index"===(M=b)?"/":M);let D=!0===f.isDev||!w,G=w&&!D,j=e.method||"GET",H=(0,r.getTracer)(),U=H.getActiveScopeSpan(),P={params:E,prerenderManifest:N,renderOpts:{experimental:{cacheComponents:!!I.experimental.cacheComponents,authInterrupts:!!I.experimental.authInterrupts},supportsDynamicResponse:D,incrementalCache:(0,s.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:null==(v=I.experimental)?void 0:v.cacheLife,isRevalidate:G,waitUntil:i.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,n,i)=>f.onRequestError(e,t,i,L)},sharedContext:{buildId:m}},$=new a.NodeNextRequest(e),q=new a.NodeNextResponse(t),_=d.NextRequestAdapter.fromNodeNextRequest($,(0,d.signalFromNodeResponse)(t));try{let o=async n=>f.handle(_,P).finally(()=>{if(!n)return;n.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let i=H.getRootSpanAttributes();if(!i)return;if(i.get("next.span_type")!==l.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${i.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let s=i.get("next.route");if(s){let e=`${j} ${s}`;n.setAttributes({"next.route":s,"http.route":s,"next.span_name":e}),n.updateName(e)}else n.updateName(`${j} ${e.url}`)}),a=async r=>{var a,d;let l=async({previousCacheEntry:n})=>{try{if(!(0,s.getRequestMeta)(e,"minimalMode")&&x&&A&&!n)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let a=await o(r);e.fetchMetrics=P.renderOpts.fetchMetrics;let d=P.renderOpts.pendingWaitUntil;d&&i.waitUntil&&(i.waitUntil(d),d=void 0);let l=P.renderOpts.collectedTags;if(!w)return await (0,u.sendResponse)($,q,a,P.renderOpts.pendingWaitUntil),null;{let e=await a.blob(),t=(0,h.toNodeOutgoingHttpHeaders)(a.headers);l&&(t[p.NEXT_CACHE_TAGS_HEADER]=l),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let n=void 0!==P.renderOpts.collectedRevalidate&&!(P.renderOpts.collectedRevalidate>=p.INFINITE_CACHE)&&P.renderOpts.collectedRevalidate,i=void 0===P.renderOpts.collectedExpire||P.renderOpts.collectedExpire>=p.INFINITE_CACHE?void 0:P.renderOpts.collectedExpire;return{value:{kind:g.CachedRouteKind.APP_ROUTE,status:a.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:n,expire:i}}}}catch(t){throw(null==n?void 0:n.isStale)&&await f.onRequestError(e,t,{routerKind:"App Router",routePath:y,routeType:"route",revalidateReason:(0,c.getRevalidateReason)({isRevalidate:G,isOnDemandRevalidate:x})},L),t}},C=await f.handleResponse({req:e,nextConfig:I,cacheKey:M,routeKind:n.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:N,isRoutePPREnabled:!1,isOnDemandRevalidate:x,revalidateOnlyGenerated:A,responseGenerator:l,waitUntil:i.waitUntil});if(!w)return null;if((null==C||null==(a=C.value)?void 0:a.kind)!==g.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==C||null==(d=C.value)?void 0:d.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});(0,s.getRequestMeta)(e,"minimalMode")||t.setHeader("x-nextjs-cache",x?"REVALIDATED":C.isMiss?"MISS":C.isStale?"STALE":"HIT"),T&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let v=(0,h.fromNodeOutgoingHttpHeaders)(C.value.headers);return(0,s.getRequestMeta)(e,"minimalMode")&&w||v.delete(p.NEXT_CACHE_TAGS_HEADER),!C.cacheControl||t.getHeader("Cache-Control")||v.get("Cache-Control")||v.set("Cache-Control",(0,O.getCacheControlHeader)(C.cacheControl)),await (0,u.sendResponse)($,q,new Response(C.value.body,{headers:v,status:C.value.status||200})),null};U?await a(U):await H.withPropagatedContext(e.headers,()=>H.trace(l.BaseServerSpan.handleRequest,{spanName:`${j} ${e.url}`,kind:r.SpanKind.SERVER,attributes:{"http.method":j,"http.target":e.url}},a))}catch(t){if(t instanceof C.NoFallbackError||await f.onRequestError(e,t,{routerKind:"App Router",routePath:R,routeType:"route",revalidateReason:(0,c.getRevalidateReason)({isRevalidate:G,isOnDemandRevalidate:x})}),w)throw t;return await (0,u.sendResponse)($,q,new Response(null,{status:500})),null}}}];

//# sourceMappingURL=%5Broot-of-the-server%5D__8a30a822._.js.map
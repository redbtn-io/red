module.exports=[70406,(e,t,n)=>{t.exports=e.x("next/dist/compiled/@opentelemetry/api",()=>require("next/dist/compiled/@opentelemetry/api"))},93695,(e,t,n)=>{t.exports=e.x("next/dist/shared/lib/no-fallback-error.external.js",()=>require("next/dist/shared/lib/no-fallback-error.external.js"))},18622,(e,t,n)=>{t.exports=e.x("next/dist/compiled/next-server/app-page-turbo.runtime.prod.js",()=>require("next/dist/compiled/next-server/app-page-turbo.runtime.prod.js"))},56704,(e,t,n)=>{t.exports=e.x("next/dist/server/app-render/work-async-storage.external.js",()=>require("next/dist/server/app-render/work-async-storage.external.js"))},32319,(e,t,n)=>{t.exports=e.x("next/dist/server/app-render/work-unit-async-storage.external.js",()=>require("next/dist/server/app-render/work-unit-async-storage.external.js"))},20635,(e,t,n)=>{t.exports=e.x("next/dist/server/app-render/action-async-storage.external.js",()=>require("next/dist/server/app-render/action-async-storage.external.js"))},24725,(e,t,n)=>{t.exports=e.x("next/dist/server/app-render/after-task-async-storage.external.js",()=>require("next/dist/server/app-render/after-task-async-storage.external.js"))},14747,(e,t,n)=>{t.exports=e.x("path",()=>require("path"))},24361,(e,t,n)=>{t.exports=e.x("util",()=>require("util"))},54799,(e,t,n)=>{t.exports=e.x("crypto",()=>require("crypto"))},81769,(e,t,n)=>{t.exports=e.x("mongodb",()=>require("mongodb"))},79334,(e,t,n)=>{"use strict";var i=e.e&&e.e.__awaiter||function(e,t,n,i){return new(n||(n=Promise))(function(o,s){function r(e){try{d(i.next(e))}catch(e){s(e)}}function a(e){try{d(i.throw(e))}catch(e){s(e)}}function d(e){var t;e.done?o(e.value):((t=e.value)instanceof n?t:new n(function(e){e(t)})).then(r,a)}d((i=i.apply(e,t||[])).next())})};Object.defineProperty(n,"__esModule",{value:!0}),n.DatabaseManager=void 0,n.getDatabase=function(e,t){if(!r){let n=process.env.MONGODB_URI||process.env.MONGODB_URL||"mongodb://localhost:27017",i=e||n,o=t;if(!o){let e=i.match(/\/([^/?]+)(\?|$)/);o=e&&e[1]?e[1]:process.env.MONGODB_NAME||"redbtn_ai"}r=new s(i,o)}return r},n.resetDatabase=function(){r=null};let o=e.r(81769);class s{constructor(e="mongodb://localhost:27017",t="redbtn_ai"){this.mongoUrl=e,this.dbName=t,this.client=null,this.db=null,this.collections=new Map,this.connectionPromise=null,this.COLLECTIONS={MESSAGES:"messages",CONVERSATIONS:"conversations",LOGS:"logs",GENERATIONS:"generations",THOUGHTS:"thoughts"}}connect(){return i(this,void 0,void 0,function*(){return this.connectionPromise||(this.connectionPromise=i(this,void 0,void 0,function*(){try{console.log("[Database] Connecting to MongoDB..."),this.mongoUrl.includes("@"),this.client=new o.MongoClient(this.mongoUrl,{serverSelectionTimeoutMS:5e3,connectTimeoutMS:1e4}),yield this.client.connect(),yield this.client.db("admin").admin().ping(),this.db=this.client.db(this.dbName),yield this.initializeCollections(),console.log("[Database] Connected to MongoDB successfully")}catch(e){throw console.error("[Database] Failed to connect to MongoDB:",e),console.error("[Database] Make sure MongoDB is running and authentication is configured correctly"),console.error("[Database] Current connection string:",this.mongoUrl.replace(/\/\/([^:]+):([^@]+)@/,"//$1:****@")),this.connectionPromise=null,e}})),this.connectionPromise})}initializeCollections(){return i(this,void 0,void 0,function*(){if(!this.db)throw Error("Database not connected");let e=this.db.collection(this.COLLECTIONS.MESSAGES);yield e.createIndex({conversationId:1,timestamp:1}),yield e.createIndex({timestamp:-1}),this.collections.set(this.COLLECTIONS.MESSAGES,e);let t=this.db.collection(this.COLLECTIONS.CONVERSATIONS);yield t.createIndex({conversationId:1},{unique:!0}),yield t.createIndex({updatedAt:-1}),yield t.createIndex({userId:1}),this.collections.set(this.COLLECTIONS.CONVERSATIONS,t);let n=this.db.collection(this.COLLECTIONS.LOGS);yield n.createIndex({timestamp:-1}),yield n.createIndex({generationId:1}),yield n.createIndex({conversationId:1}),yield n.createIndex({level:1}),yield n.createIndex({category:1}),yield n.createIndex({logId:1},{unique:!0}),yield n.createIndex({timestamp:1},{expireAfterSeconds:15552e3}),this.collections.set(this.COLLECTIONS.LOGS,n);let i=this.db.collection(this.COLLECTIONS.GENERATIONS);yield i.createIndex({generationId:1},{unique:!0}),yield i.createIndex({conversationId:1}),yield i.createIndex({status:1}),yield i.createIndex({startTime:-1}),yield i.createIndex({nodeId:1}),this.collections.set(this.COLLECTIONS.GENERATIONS,i);let o=this.db.collection(this.COLLECTIONS.THOUGHTS);yield o.createIndex({thoughtId:1},{unique:!0}),yield o.createIndex({conversationId:1}),yield o.createIndex({messageId:1}),yield o.createIndex({generationId:1}),yield o.createIndex({timestamp:-1}),yield o.createIndex({source:1}),this.collections.set(this.COLLECTIONS.THOUGHTS,o)})}ensureConnected(){return i(this,void 0,void 0,function*(){this.db&&0!==this.collections.size||(yield this.connect())})}getCollection(e){let t=this.collections.get(e);if(!t)throw Error(`Collection ${e} not initialized`);return t}collection(e){return i(this,void 0,void 0,function*(){if(yield this.ensureConnected(),!this.collections.has(e)){let t=this.db.collection(e);this.collections.set(e,t)}return this.getCollection(e)})}insertOne(e,t){return i(this,void 0,void 0,function*(){yield this.ensureConnected();let n=yield this.collection(e),i=Object.assign(Object.assign({},t),{createdAt:t.createdAt||new Date,updatedAt:t.updatedAt||new Date});return(yield n.insertOne(i)).insertedId})}insertMany(e,t){return i(this,void 0,void 0,function*(){if(0===t.length)return[];yield this.ensureConnected();let n=yield this.collection(e),i=t.map(e=>Object.assign(Object.assign({},e),{createdAt:e.createdAt||new Date,updatedAt:e.updatedAt||new Date}));return Object.values((yield n.insertMany(i)).insertedIds)})}find(e){return i(this,arguments,void 0,function*(e,t={},n){yield this.ensureConnected();let i=yield this.collection(e);return yield i.find(t,n).toArray()})}findOne(e,t){return i(this,void 0,void 0,function*(){yield this.ensureConnected();let n=yield this.collection(e);return yield n.findOne(t)})}updateMany(e,t,n){return i(this,void 0,void 0,function*(){yield this.ensureConnected();let i=yield this.collection(e),o=Object.assign(Object.assign({},n),{$set:Object.assign(Object.assign({},n.$set||{}),{updatedAt:new Date})});return(yield i.updateMany(t,o)).modifiedCount})}updateOne(e,t,n){return i(this,arguments,void 0,function*(e,t,n,i=!1){yield this.ensureConnected();let o=yield this.collection(e),s=Object.assign(Object.assign({},n),{$set:Object.assign(Object.assign({},n.$set||{}),{updatedAt:new Date}),$setOnInsert:Object.assign(Object.assign({},n.$setOnInsert||{}),{createdAt:new Date})}),r=yield o.updateOne(t,s,{upsert:i});return r.modifiedCount>0||i&&r.upsertedCount>0})}deleteMany(e,t){return i(this,void 0,void 0,function*(){yield this.ensureConnected();let n=yield this.collection(e);return(yield n.deleteMany(t)).deletedCount})}deleteOne(e,t){return i(this,void 0,void 0,function*(){yield this.ensureConnected();let n=yield this.collection(e);return(yield n.deleteOne(t)).deletedCount>0})}count(e){return i(this,arguments,void 0,function*(e,t={}){yield this.ensureConnected();let n=yield this.collection(e);return yield n.countDocuments(t)})}storeMessage(e){return i(this,void 0,void 0,function*(){yield this.ensureConnected();let t=this.getCollection(this.COLLECTIONS.MESSAGES),n=yield t.insertOne(Object.assign(Object.assign({},e),{createdAt:new Date,updatedAt:new Date})),i=this.getCollection(this.COLLECTIONS.CONVERSATIONS);return yield i.updateOne({conversationId:e.conversationId},{$set:{updatedAt:new Date},$inc:{"metadata.messageCount":1}},{upsert:!0}),n.insertedId})}storeMessages(e){return i(this,void 0,void 0,function*(){if(0===e.length)return;yield this.ensureConnected();let t=this.getCollection(this.COLLECTIONS.MESSAGES);yield t.insertMany(e.map(e=>Object.assign(Object.assign({},e),{createdAt:new Date,updatedAt:new Date})));let n=e[0].conversationId,i=this.getCollection(this.COLLECTIONS.CONVERSATIONS);yield i.updateOne({conversationId:n},{$set:{updatedAt:new Date},$inc:{"metadata.messageCount":e.length}},{upsert:!0})})}getMessages(e){return i(this,arguments,void 0,function*(e,t=0,n=0){yield this.ensureConnected();let i=this.getCollection(this.COLLECTIONS.MESSAGES).find({conversationId:e}).sort({timestamp:1}).skip(n);return t>0&&i.limit(t),yield i.toArray()})}getLastMessages(e,t){return i(this,void 0,void 0,function*(){yield this.ensureConnected();let n=this.getCollection(this.COLLECTIONS.MESSAGES);return(yield n.find({conversationId:e}).sort({timestamp:-1}).limit(t).toArray()).reverse()})}getMessageCount(e){return i(this,void 0,void 0,function*(){yield this.ensureConnected();let t=this.getCollection(this.COLLECTIONS.MESSAGES);return yield t.countDocuments({conversationId:e})})}upsertConversation(e){return i(this,void 0,void 0,function*(){yield this.ensureConnected();let t=this.getCollection(this.COLLECTIONS.CONVERSATIONS);yield t.updateOne({conversationId:e.conversationId},{$set:Object.assign(Object.assign({},e),{updatedAt:new Date}),$setOnInsert:{createdAt:new Date}},{upsert:!0})})}updateConversationTitle(e,t){return i(this,void 0,void 0,function*(){yield this.ensureConnected();let n=this.getCollection(this.COLLECTIONS.CONVERSATIONS);yield n.updateOne({conversationId:e},{$set:{title:t,updatedAt:new Date}})})}getConversation(e){return i(this,void 0,void 0,function*(){yield this.ensureConnected();let t=this.getCollection(this.COLLECTIONS.CONVERSATIONS);return yield t.findOne({conversationId:e})})}getConversations(){return i(this,arguments,void 0,function*(e=50,t=0){yield this.ensureConnected();let n=this.getCollection(this.COLLECTIONS.CONVERSATIONS);return yield n.find({}).sort({updatedAt:-1}).skip(t).limit(e).toArray()})}deleteConversation(e){return i(this,void 0,void 0,function*(){yield this.ensureConnected();let t=this.getCollection(this.COLLECTIONS.MESSAGES),n=this.getCollection(this.COLLECTIONS.CONVERSATIONS);yield t.deleteMany({conversationId:e}),yield n.deleteOne({conversationId:e})})}storeLog(e){return i(this,void 0,void 0,function*(){return yield this.insertOne(this.COLLECTIONS.LOGS,e)})}storeLogs(e){return i(this,void 0,void 0,function*(){return yield this.insertMany(this.COLLECTIONS.LOGS,e)})}getLogsByGeneration(e,t){return i(this,void 0,void 0,function*(){yield this.ensureConnected();let n=this.getCollection(this.COLLECTIONS.LOGS).find({generationId:e}).sort({timestamp:1});return t&&n.limit(t),yield n.toArray()})}getLogsByConversation(e,t){return i(this,void 0,void 0,function*(){yield this.ensureConnected();let n=this.getCollection(this.COLLECTIONS.LOGS).find({conversationId:e}).sort({timestamp:-1});return t&&n.limit(t),yield n.toArray()})}getLogsByLevel(e,t){return i(this,void 0,void 0,function*(){yield this.ensureConnected();let n=this.getCollection(this.COLLECTIONS.LOGS).find({level:e}).sort({timestamp:-1});return t&&n.limit(t),yield n.toArray()})}getLogs(){return i(this,arguments,void 0,function*(e={},t=100,n=0){return yield this.find(this.COLLECTIONS.LOGS,e,{sort:{timestamp:-1},limit:t,skip:n})})}deleteOldLogs(e){return i(this,void 0,void 0,function*(){return yield this.deleteMany(this.COLLECTIONS.LOGS,{timestamp:{$lt:e}})})}storeGeneration(e){return i(this,void 0,void 0,function*(){return yield this.insertOne(this.COLLECTIONS.GENERATIONS,e)})}updateGenerationStatus(e,t,n){return i(this,void 0,void 0,function*(){return yield this.updateOne(this.COLLECTIONS.GENERATIONS,{generationId:e},{$set:Object.assign(Object.assign({status:t},"completed"===t||"failed"===t?{endTime:new Date}:{}),n)})})}getGeneration(e){return i(this,void 0,void 0,function*(){return yield this.findOne(this.COLLECTIONS.GENERATIONS,{generationId:e})})}getGenerationsByConversation(e,t){return i(this,void 0,void 0,function*(){return yield this.find(this.COLLECTIONS.GENERATIONS,{conversationId:e},{sort:{startTime:-1},limit:t})})}getActiveGenerations(){return i(this,void 0,void 0,function*(){return yield this.find(this.COLLECTIONS.GENERATIONS,{status:{$in:["pending","streaming"]}},{sort:{startTime:-1}})})}deleteOldGenerations(e){return i(this,void 0,void 0,function*(){return yield this.deleteMany(this.COLLECTIONS.GENERATIONS,{startTime:{$lt:e},status:{$in:["completed","failed"]}})})}storeThought(e){return i(this,void 0,void 0,function*(){return yield this.insertOne(this.COLLECTIONS.THOUGHTS,e)})}storeThoughts(e){return i(this,void 0,void 0,function*(){0!==e.length&&(yield this.insertMany(this.COLLECTIONS.THOUGHTS,e))})}getThought(e){return i(this,void 0,void 0,function*(){return yield this.findOne(this.COLLECTIONS.THOUGHTS,{thoughtId:e})})}getThoughtsByMessage(e){return i(this,void 0,void 0,function*(){return yield this.find(this.COLLECTIONS.THOUGHTS,{messageId:e},{sort:{timestamp:1}})})}getThoughtsByConversation(e,t){return i(this,void 0,void 0,function*(){return yield this.find(this.COLLECTIONS.THOUGHTS,{conversationId:e},{sort:{timestamp:-1},limit:t})})}getThoughtsByGeneration(e){return i(this,void 0,void 0,function*(){return yield this.find(this.COLLECTIONS.THOUGHTS,{generationId:e},{sort:{timestamp:1}})})}getThoughtsBySource(e,t,n){return i(this,void 0,void 0,function*(){let i={source:e};return t&&(i.conversationId=t),yield this.find(this.COLLECTIONS.THOUGHTS,i,{sort:{timestamp:-1},limit:n})})}deleteOldThoughts(e){return i(this,void 0,void 0,function*(){return yield this.deleteMany(this.COLLECTIONS.THOUGHTS,{timestamp:{$lt:e}})})}close(){return i(this,void 0,void 0,function*(){this.client&&(yield this.client.close(),this.client=null,this.db=null,this.collections.clear(),this.connectionPromise=null,console.log("[Database] Closed MongoDB connection"))})}}n.DatabaseManager=s;let r=null},38674,e=>e.a(async(t,n)=>{try{e.s(["getRed",()=>o,"red",()=>a]);var i=e.i(95669);let t={redisUrl:process.env.REDIS_URL||"redis://localhost:6379",vectorDbUrl:process.env.VECTOR_DB_URL||"http://localhost:8200",databaseUrl:process.env.DATABASE_URL||"http://localhost:5432",defaultLlmUrl:process.env.LLM_URL||"http://localhost:11434"},s=null;async function o(){return s||(s=new i.Red(t),await s.load("webapp-api"),console.log("âœ… Red AI initialized successfully")),s}let r=null;r=o();let a=await r;process.env.BEARER_TOKEN||Date.now(),n()}catch(e){n(e)}},!0),98846,e=>{"use strict";e.s(["extractUserMessage",()=>i,"generateCompletionId",()=>n,"generateStableConversationId",()=>s,"getConversationIdFromBody",()=>o,"getModelDetails",()=>a,"getModelsList",()=>r]);var t=e.i(54799);function n(){return`chatcmpl-${Date.now()}-${Math.random().toString(36).substring(7)}`}function i(e){let t=[...e].reverse().find(e=>"user"===e.role);return t?.content||""}function o(e){for(let t of["chat_id","chatId","conversation_id","conversationId","session_id","sessionId","thread_id","threadId"])if(e[t])return e[t]}function s(e){let n=e.find(e=>"user"===e.role);if(!n)return`conv_${t.default.randomBytes(8).toString("hex")}`;let i=t.default.createHash("sha256").update(n.content).digest("hex").substring(0,16);return`conv_${i}`}function r(){return{object:"list",data:[{id:"Red",object:"model",created:Math.floor(Date.now()/1e3),owned_by:"redbtn",permission:[],root:"Red",parent:null}]}}function a(e){return"Red"===e||"red"===e?{id:"Red",object:"model",created:Math.floor(Date.now()/1e3),owned_by:"redbtn",permission:[],root:"Red",parent:null}:null}},29659,(e,t,n)=>{},12,e=>e.a(async(t,n)=>{try{e.s(["POST",()=>a]);var i=e.i(89171),o=e.i(38674),s=e.i(98846),r=t([o]);async function a(e){try{let t=await e.json();if(!t.messages||0===t.messages.length)return i.NextResponse.json({error:{message:"messages is required and must not be empty",type:"invalid_request_error",code:"invalid_messages"}},{status:400});let n=(0,s.generateCompletionId)(),r=Math.floor(Date.now()/1e3),a=t.model||"Red",d=(0,s.extractUserMessage)(t.messages),l=(0,s.getConversationIdFromBody)(t)||e.headers.get("x-conversation-id")||(0,s.generateStableConversationId)(t.messages);console.log(`ðŸ”— Using conversation ID: ${l}`);let c=await (0,o.getRed)(),u=`msg_${Date.now()}_${Math.random().toString(36).substr(2,9)}`;if(t.stream)return await c.messageQueue.startGeneration(l,u),(async()=>{try{for await(let e of(console.log(`[Generation] Starting background generation for ${u}`),await c.respond({message:d},{source:{application:"redChat"},stream:!0,conversationId:l,messageId:u})))if("object"!=typeof e||!e._metadata){if("object"==typeof e&&e._toolStatus){await c.messageQueue.publishToolStatus(u,{status:e.status,action:e.action});continue}if("string"==typeof e)await c.messageQueue.appendContent(u,e);else{let t={model:e.response_metadata?.model,tokens:e.usage_metadata?{input:e.usage_metadata.input_tokens,output:e.usage_metadata.output_tokens,total:e.usage_metadata.total_tokens}:void 0};await c.messageQueue.completeGeneration(u,t),console.log(`[Generation] Completed ${u}`)}}}catch(e){console.error(`[Generation] Failed ${u}:`,e),await c.messageQueue.failGeneration(u,e instanceof Error?e.message:String(e))}})(),i.NextResponse.json({id:u,object:"chat.completion",created:Math.floor(Date.now()/1e3),model:a,conversationId:l,stream_url:`/api/v1/messages/${u}/stream`});let h=await c.respond({message:d},{source:{application:"redChat"},conversationId:l}),p={id:n,object:"chat.completion",created:r,model:a,conversationId:h.conversationId||l,choices:[{index:0,message:{role:"assistant",content:"string"==typeof h.content?h.content:JSON.stringify(h.content)},finish_reason:"stop"}],usage:{prompt_tokens:h.usage_metadata?.input_tokens||0,completion_tokens:h.usage_metadata?.output_tokens||0,total_tokens:h.usage_metadata?.total_tokens||0}};return i.NextResponse.json(p)}catch(e){return console.error("Error in chat completion:",e),i.NextResponse.json({error:{message:e instanceof Error?e.message:"Internal server error",type:"internal_error",code:"internal_error"}},{status:500})}}[o]=r.then?(await r)():r,n()}catch(e){n(e)}},!1),4857,e=>e.a(async(t,n)=>{try{e.s(["handler",()=>E,"patchFetch",()=>S,"routeModule",()=>I,"serverHooks",()=>N,"workAsyncStorage",()=>T,"workUnitAsyncStorage",()=>L]);var i=e.i(47909),o=e.i(74017),s=e.i(96250),r=e.i(59756),a=e.i(61916),d=e.i(69741),l=e.i(16795),c=e.i(87718),u=e.i(95169),h=e.i(47587),p=e.i(66012),g=e.i(70101),O=e.i(26937),C=e.i(10372),v=e.i(93695);e.i(52474);var y=e.i(220),m=e.i(12),f=t([m]);[m]=f.then?(await f)():f;let I=new i.AppRouteRouteModule({definition:{kind:o.RouteKind.APP_ROUTE,page:"/api/v1/chat/completions/route",pathname:"/api/v1/chat/completions",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/src/app/api/v1/chat/completions/route.ts",nextConfigOutput:"",userland:m}),{workAsyncStorage:T,workUnitAsyncStorage:L,serverHooks:N}=I;function S(){return(0,s.patchFetch)({workAsyncStorage:T,workUnitAsyncStorage:L})}async function E(e,t,n){var i;let s="/api/v1/chat/completions/route";s=s.replace(/\/index$/,"")||"/";let m=await I.prepare(e,t,{srcPage:s,multiZoneDraftMode:!1});if(!m)return t.statusCode=400,t.end("Bad Request"),null==n.waitUntil||n.waitUntil.call(n,Promise.resolve()),null;let{buildId:f,params:S,nextConfig:E,isDraftMode:T,prerenderManifest:L,routerServerContext:N,isOnDemandRevalidate:x,revalidateOnlyGenerated:b,resolvedPathname:R}=m,A=(0,d.normalizeAppPath)(s),w=!!(L.dynamicRoutes[A]||L.routes[R]);if(w&&!T){let e=!!L.routes[R],t=L.dynamicRoutes[A];if(t&&!1===t.fallback&&!e)throw new v.NoFallbackError}let _=null;!w||I.isDev||T||(_=R,_="/index"===_?"/":_);let M=!0===I.isDev||!w,D=w&&!M,G=e.method||"GET",j=(0,a.getTracer)(),U=j.getActiveScopeSpan(),$={params:S,prerenderManifest:L,renderOpts:{experimental:{cacheComponents:!!E.experimental.cacheComponents,authInterrupts:!!E.experimental.authInterrupts},supportsDynamicResponse:M,incrementalCache:(0,r.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:null==(i=E.experimental)?void 0:i.cacheLife,isRevalidate:D,waitUntil:n.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,n,i)=>I.onRequestError(e,t,i,N)},sharedContext:{buildId:f}},H=new l.NodeNextRequest(e),k=new l.NodeNextResponse(t),q=c.NextRequestAdapter.fromNodeNextRequest(H,(0,c.signalFromNodeResponse)(t));try{let i=async n=>I.handle(q,$).finally(()=>{if(!n)return;n.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let i=j.getRootSpanAttributes();if(!i)return;if(i.get("next.span_type")!==u.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${i.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let o=i.get("next.route");if(o){let e=`${G} ${o}`;n.setAttributes({"next.route":o,"http.route":o,"next.span_name":e}),n.updateName(e)}else n.updateName(`${G} ${e.url}`)}),d=async a=>{var d,l;let c=async({previousCacheEntry:o})=>{try{if(!(0,r.getRequestMeta)(e,"minimalMode")&&x&&b&&!o)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let s=await i(a);e.fetchMetrics=$.renderOpts.fetchMetrics;let d=$.renderOpts.pendingWaitUntil;d&&n.waitUntil&&(n.waitUntil(d),d=void 0);let l=$.renderOpts.collectedTags;if(!w)return await (0,p.sendResponse)(H,k,s,$.renderOpts.pendingWaitUntil),null;{let e=await s.blob(),t=(0,g.toNodeOutgoingHttpHeaders)(s.headers);l&&(t[C.NEXT_CACHE_TAGS_HEADER]=l),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let n=void 0!==$.renderOpts.collectedRevalidate&&!($.renderOpts.collectedRevalidate>=C.INFINITE_CACHE)&&$.renderOpts.collectedRevalidate,i=void 0===$.renderOpts.collectedExpire||$.renderOpts.collectedExpire>=C.INFINITE_CACHE?void 0:$.renderOpts.collectedExpire;return{value:{kind:y.CachedRouteKind.APP_ROUTE,status:s.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:n,expire:i}}}}catch(t){throw(null==o?void 0:o.isStale)&&await I.onRequestError(e,t,{routerKind:"App Router",routePath:s,routeType:"route",revalidateReason:(0,h.getRevalidateReason)({isRevalidate:D,isOnDemandRevalidate:x})},N),t}},u=await I.handleResponse({req:e,nextConfig:E,cacheKey:_,routeKind:o.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:L,isRoutePPREnabled:!1,isOnDemandRevalidate:x,revalidateOnlyGenerated:b,responseGenerator:c,waitUntil:n.waitUntil});if(!w)return null;if((null==u||null==(d=u.value)?void 0:d.kind)!==y.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==u||null==(l=u.value)?void 0:l.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});(0,r.getRequestMeta)(e,"minimalMode")||t.setHeader("x-nextjs-cache",x?"REVALIDATED":u.isMiss?"MISS":u.isStale?"STALE":"HIT"),T&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let v=(0,g.fromNodeOutgoingHttpHeaders)(u.value.headers);return(0,r.getRequestMeta)(e,"minimalMode")&&w||v.delete(C.NEXT_CACHE_TAGS_HEADER),!u.cacheControl||t.getHeader("Cache-Control")||v.get("Cache-Control")||v.set("Cache-Control",(0,O.getCacheControlHeader)(u.cacheControl)),await (0,p.sendResponse)(H,k,new Response(u.value.body,{headers:v,status:u.value.status||200})),null};U?await d(U):await j.withPropagatedContext(e.headers,()=>j.trace(u.BaseServerSpan.handleRequest,{spanName:`${G} ${e.url}`,kind:a.SpanKind.SERVER,attributes:{"http.method":G,"http.target":e.url}},d))}catch(t){if(t instanceof v.NoFallbackError||await I.onRequestError(e,t,{routerKind:"App Router",routePath:A,routeType:"route",revalidateReason:(0,h.getRevalidateReason)({isRevalidate:D,isOnDemandRevalidate:x})}),w)throw t;return await (0,p.sendResponse)(H,k,new Response(null,{status:500})),null}}n()}catch(e){n(e)}},!1)];

//# sourceMappingURL=%5Broot-of-the-server%5D__05e63738._.js.map
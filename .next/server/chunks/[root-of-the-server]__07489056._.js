module.exports=[81769,(e,t,i)=>{t.exports=e.x("mongodb",()=>require("mongodb"))},79334,(e,t,i)=>{"use strict";var n=e.e&&e.e.__awaiter||function(e,t,i,n){return new(i||(i=Promise))(function(s,o){function d(e){try{l(n.next(e))}catch(e){o(e)}}function r(e){try{l(n.throw(e))}catch(e){o(e)}}function l(e){var t;e.done?s(e.value):((t=e.value)instanceof i?t:new i(function(e){e(t)})).then(d,r)}l((n=n.apply(e,t||[])).next())})};Object.defineProperty(i,"__esModule",{value:!0}),i.DatabaseManager=void 0,i.getDatabase=function(e,t){if(!d){let i=process.env.MONGODB_URI||process.env.MONGODB_URL||"mongodb://localhost:27017",n=e||i,s=t;if(!s){let e=n.match(/\/([^/?]+)(\?|$)/);s=e&&e[1]?e[1]:process.env.MONGODB_NAME||"redbtn_ai"}d=new o(n,s)}return d},i.resetDatabase=function(){d=null};let s=e.r(81769);class o{constructor(e="mongodb://localhost:27017",t="redbtn_ai"){this.mongoUrl=e,this.dbName=t,this.client=null,this.db=null,this.collections=new Map,this.connectionPromise=null,this.COLLECTIONS={MESSAGES:"messages",CONVERSATIONS:"conversations",LOGS:"logs",GENERATIONS:"generations",THOUGHTS:"thoughts"}}connect(){return n(this,void 0,void 0,function*(){return this.connectionPromise||(this.connectionPromise=n(this,void 0,void 0,function*(){try{console.log("[Database] Connecting to MongoDB..."),this.mongoUrl.includes("@"),this.client=new s.MongoClient(this.mongoUrl,{serverSelectionTimeoutMS:5e3,connectTimeoutMS:1e4}),yield this.client.connect(),yield this.client.db("admin").admin().ping(),this.db=this.client.db(this.dbName),yield this.initializeCollections(),console.log("[Database] Connected to MongoDB successfully")}catch(e){throw console.error("[Database] Failed to connect to MongoDB:",e),console.error("[Database] Make sure MongoDB is running and authentication is configured correctly"),console.error("[Database] Current connection string:",this.mongoUrl.replace(/\/\/([^:]+):([^@]+)@/,"//$1:****@")),this.connectionPromise=null,e}})),this.connectionPromise})}initializeCollections(){return n(this,void 0,void 0,function*(){if(!this.db)throw Error("Database not connected");let e=this.db.collection(this.COLLECTIONS.MESSAGES);yield e.createIndex({conversationId:1,timestamp:1}),yield e.createIndex({timestamp:-1}),this.collections.set(this.COLLECTIONS.MESSAGES,e);let t=this.db.collection(this.COLLECTIONS.CONVERSATIONS);yield t.createIndex({conversationId:1},{unique:!0}),yield t.createIndex({updatedAt:-1}),yield t.createIndex({userId:1}),this.collections.set(this.COLLECTIONS.CONVERSATIONS,t);let i=this.db.collection(this.COLLECTIONS.LOGS);yield i.createIndex({timestamp:-1}),yield i.createIndex({generationId:1}),yield i.createIndex({conversationId:1}),yield i.createIndex({level:1}),yield i.createIndex({category:1}),yield i.createIndex({logId:1},{unique:!0}),yield i.createIndex({timestamp:1},{expireAfterSeconds:15552e3}),this.collections.set(this.COLLECTIONS.LOGS,i);let n=this.db.collection(this.COLLECTIONS.GENERATIONS);yield n.createIndex({generationId:1},{unique:!0}),yield n.createIndex({conversationId:1}),yield n.createIndex({status:1}),yield n.createIndex({startTime:-1}),yield n.createIndex({nodeId:1}),this.collections.set(this.COLLECTIONS.GENERATIONS,n);let s=this.db.collection(this.COLLECTIONS.THOUGHTS);yield s.createIndex({thoughtId:1},{unique:!0}),yield s.createIndex({conversationId:1}),yield s.createIndex({messageId:1}),yield s.createIndex({generationId:1}),yield s.createIndex({timestamp:-1}),yield s.createIndex({source:1}),this.collections.set(this.COLLECTIONS.THOUGHTS,s)})}ensureConnected(){return n(this,void 0,void 0,function*(){this.db&&0!==this.collections.size||(yield this.connect())})}getCollection(e){let t=this.collections.get(e);if(!t)throw Error(`Collection ${e} not initialized`);return t}collection(e){return n(this,void 0,void 0,function*(){if(yield this.ensureConnected(),!this.collections.has(e)){let t=this.db.collection(e);this.collections.set(e,t)}return this.getCollection(e)})}insertOne(e,t){return n(this,void 0,void 0,function*(){yield this.ensureConnected();let i=yield this.collection(e),n=Object.assign(Object.assign({},t),{createdAt:t.createdAt||new Date,updatedAt:t.updatedAt||new Date});return(yield i.insertOne(n)).insertedId})}insertMany(e,t){return n(this,void 0,void 0,function*(){if(0===t.length)return[];yield this.ensureConnected();let i=yield this.collection(e),n=t.map(e=>Object.assign(Object.assign({},e),{createdAt:e.createdAt||new Date,updatedAt:e.updatedAt||new Date}));return Object.values((yield i.insertMany(n)).insertedIds)})}find(e){return n(this,arguments,void 0,function*(e,t={},i){yield this.ensureConnected();let n=yield this.collection(e);return yield n.find(t,i).toArray()})}findOne(e,t){return n(this,void 0,void 0,function*(){yield this.ensureConnected();let i=yield this.collection(e);return yield i.findOne(t)})}updateMany(e,t,i){return n(this,void 0,void 0,function*(){yield this.ensureConnected();let n=yield this.collection(e),s=Object.assign(Object.assign({},i),{$set:Object.assign(Object.assign({},i.$set||{}),{updatedAt:new Date})});return(yield n.updateMany(t,s)).modifiedCount})}updateOne(e,t,i){return n(this,arguments,void 0,function*(e,t,i,n=!1){yield this.ensureConnected();let s=yield this.collection(e),o=Object.assign(Object.assign({},i),{$set:Object.assign(Object.assign({},i.$set||{}),{updatedAt:new Date}),$setOnInsert:Object.assign(Object.assign({},i.$setOnInsert||{}),{createdAt:new Date})}),d=yield s.updateOne(t,o,{upsert:n});return d.modifiedCount>0||n&&d.upsertedCount>0})}deleteMany(e,t){return n(this,void 0,void 0,function*(){yield this.ensureConnected();let i=yield this.collection(e);return(yield i.deleteMany(t)).deletedCount})}deleteOne(e,t){return n(this,void 0,void 0,function*(){yield this.ensureConnected();let i=yield this.collection(e);return(yield i.deleteOne(t)).deletedCount>0})}count(e){return n(this,arguments,void 0,function*(e,t={}){yield this.ensureConnected();let i=yield this.collection(e);return yield i.countDocuments(t)})}storeMessage(e){return n(this,void 0,void 0,function*(){yield this.ensureConnected();let t=this.getCollection(this.COLLECTIONS.MESSAGES),i=yield t.insertOne(Object.assign(Object.assign({},e),{createdAt:new Date,updatedAt:new Date})),n=this.getCollection(this.COLLECTIONS.CONVERSATIONS);return yield n.updateOne({conversationId:e.conversationId},{$set:{updatedAt:new Date},$inc:{"metadata.messageCount":1}},{upsert:!0}),i.insertedId})}storeMessages(e){return n(this,void 0,void 0,function*(){if(0===e.length)return;yield this.ensureConnected();let t=this.getCollection(this.COLLECTIONS.MESSAGES);yield t.insertMany(e.map(e=>Object.assign(Object.assign({},e),{createdAt:new Date,updatedAt:new Date})));let i=e[0].conversationId,n=this.getCollection(this.COLLECTIONS.CONVERSATIONS);yield n.updateOne({conversationId:i},{$set:{updatedAt:new Date},$inc:{"metadata.messageCount":e.length}},{upsert:!0})})}getMessages(e){return n(this,arguments,void 0,function*(e,t=0,i=0){yield this.ensureConnected();let n=this.getCollection(this.COLLECTIONS.MESSAGES).find({conversationId:e}).sort({timestamp:1}).skip(i);return t>0&&n.limit(t),yield n.toArray()})}getLastMessages(e,t){return n(this,void 0,void 0,function*(){yield this.ensureConnected();let i=this.getCollection(this.COLLECTIONS.MESSAGES);return(yield i.find({conversationId:e}).sort({timestamp:-1}).limit(t).toArray()).reverse()})}getMessageCount(e){return n(this,void 0,void 0,function*(){yield this.ensureConnected();let t=this.getCollection(this.COLLECTIONS.MESSAGES);return yield t.countDocuments({conversationId:e})})}upsertConversation(e){return n(this,void 0,void 0,function*(){yield this.ensureConnected();let t=this.getCollection(this.COLLECTIONS.CONVERSATIONS);yield t.updateOne({conversationId:e.conversationId},{$set:Object.assign(Object.assign({},e),{updatedAt:new Date}),$setOnInsert:{createdAt:new Date}},{upsert:!0})})}updateConversationTitle(e,t){return n(this,void 0,void 0,function*(){yield this.ensureConnected();let i=this.getCollection(this.COLLECTIONS.CONVERSATIONS);yield i.updateOne({conversationId:e},{$set:{title:t,updatedAt:new Date}})})}getConversation(e){return n(this,void 0,void 0,function*(){yield this.ensureConnected();let t=this.getCollection(this.COLLECTIONS.CONVERSATIONS);return yield t.findOne({conversationId:e})})}getConversations(){return n(this,arguments,void 0,function*(e=50,t=0){yield this.ensureConnected();let i=this.getCollection(this.COLLECTIONS.CONVERSATIONS);return yield i.find({}).sort({updatedAt:-1}).skip(t).limit(e).toArray()})}deleteConversation(e){return n(this,void 0,void 0,function*(){yield this.ensureConnected();let t=this.getCollection(this.COLLECTIONS.MESSAGES),i=this.getCollection(this.COLLECTIONS.CONVERSATIONS);yield t.deleteMany({conversationId:e}),yield i.deleteOne({conversationId:e})})}storeLog(e){return n(this,void 0,void 0,function*(){return yield this.insertOne(this.COLLECTIONS.LOGS,e)})}storeLogs(e){return n(this,void 0,void 0,function*(){return yield this.insertMany(this.COLLECTIONS.LOGS,e)})}getLogsByGeneration(e,t){return n(this,void 0,void 0,function*(){yield this.ensureConnected();let i=this.getCollection(this.COLLECTIONS.LOGS).find({generationId:e}).sort({timestamp:1});return t&&i.limit(t),yield i.toArray()})}getLogsByConversation(e,t){return n(this,void 0,void 0,function*(){yield this.ensureConnected();let i=this.getCollection(this.COLLECTIONS.LOGS).find({conversationId:e}).sort({timestamp:-1});return t&&i.limit(t),yield i.toArray()})}getLogsByLevel(e,t){return n(this,void 0,void 0,function*(){yield this.ensureConnected();let i=this.getCollection(this.COLLECTIONS.LOGS).find({level:e}).sort({timestamp:-1});return t&&i.limit(t),yield i.toArray()})}getLogs(){return n(this,arguments,void 0,function*(e={},t=100,i=0){return yield this.find(this.COLLECTIONS.LOGS,e,{sort:{timestamp:-1},limit:t,skip:i})})}deleteOldLogs(e){return n(this,void 0,void 0,function*(){return yield this.deleteMany(this.COLLECTIONS.LOGS,{timestamp:{$lt:e}})})}storeGeneration(e){return n(this,void 0,void 0,function*(){return yield this.insertOne(this.COLLECTIONS.GENERATIONS,e)})}updateGenerationStatus(e,t,i){return n(this,void 0,void 0,function*(){return yield this.updateOne(this.COLLECTIONS.GENERATIONS,{generationId:e},{$set:Object.assign(Object.assign({status:t},"completed"===t||"failed"===t?{endTime:new Date}:{}),i)})})}getGeneration(e){return n(this,void 0,void 0,function*(){return yield this.findOne(this.COLLECTIONS.GENERATIONS,{generationId:e})})}getGenerationsByConversation(e,t){return n(this,void 0,void 0,function*(){return yield this.find(this.COLLECTIONS.GENERATIONS,{conversationId:e},{sort:{startTime:-1},limit:t})})}getActiveGenerations(){return n(this,void 0,void 0,function*(){return yield this.find(this.COLLECTIONS.GENERATIONS,{status:{$in:["pending","streaming"]}},{sort:{startTime:-1}})})}deleteOldGenerations(e){return n(this,void 0,void 0,function*(){return yield this.deleteMany(this.COLLECTIONS.GENERATIONS,{startTime:{$lt:e},status:{$in:["completed","failed"]}})})}storeThought(e){return n(this,void 0,void 0,function*(){return yield this.insertOne(this.COLLECTIONS.THOUGHTS,e)})}storeThoughts(e){return n(this,void 0,void 0,function*(){0!==e.length&&(yield this.insertMany(this.COLLECTIONS.THOUGHTS,e))})}getThought(e){return n(this,void 0,void 0,function*(){return yield this.findOne(this.COLLECTIONS.THOUGHTS,{thoughtId:e})})}getThoughtsByMessage(e){return n(this,void 0,void 0,function*(){return yield this.find(this.COLLECTIONS.THOUGHTS,{messageId:e},{sort:{timestamp:1}})})}getThoughtsByConversation(e,t){return n(this,void 0,void 0,function*(){return yield this.find(this.COLLECTIONS.THOUGHTS,{conversationId:e},{sort:{timestamp:-1},limit:t})})}getThoughtsByGeneration(e){return n(this,void 0,void 0,function*(){return yield this.find(this.COLLECTIONS.THOUGHTS,{generationId:e},{sort:{timestamp:1}})})}getThoughtsBySource(e,t,i){return n(this,void 0,void 0,function*(){let n={source:e};return t&&(n.conversationId=t),yield this.find(this.COLLECTIONS.THOUGHTS,n,{sort:{timestamp:-1},limit:i})})}deleteOldThoughts(e){return n(this,void 0,void 0,function*(){return yield this.deleteMany(this.COLLECTIONS.THOUGHTS,{timestamp:{$lt:e}})})}close(){return n(this,void 0,void 0,function*(){this.client&&(yield this.client.close(),this.client=null,this.db=null,this.collections.clear(),this.connectionPromise=null,console.log("[Database] Closed MongoDB connection"))})}}i.DatabaseManager=o;let d=null}];

//# sourceMappingURL=%5Broot-of-the-server%5D__07489056._.js.map
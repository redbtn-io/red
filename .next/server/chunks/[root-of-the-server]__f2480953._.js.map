{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 3, "column": 0}, "map": {"version":3,"sources":[],"names":[],"mappings":"","debugId":null}},
    {"offset": {"line": 159, "column": 0}, "map": {"version":3,"sources":["file:///home/alpha/code/%40redbtn/webapp/src/lib/red.ts"],"sourcesContent":["/**\n * Red AI instance initialization for Next.js API routes\n */\nimport { Red, RedConfig } from '@redbtn/ai';\n\nconst config: RedConfig = {\n  redisUrl: process.env.REDIS_URL || \"redis://localhost:6379\",\n  vectorDbUrl: process.env.VECTOR_DB_URL || \"http://localhost:8200\",\n  databaseUrl: process.env.DATABASE_URL || \"http://localhost:5432\",\n  defaultLlmUrl: process.env.LLM_URL || \"http://localhost:11434\",\n};\n\nlet redInstance: Red | null = null;\n\n/**\n * Get or initialize the Red AI instance\n * Singleton pattern to avoid multiple initializations\n */\nexport async function getRed(): Promise<Red> {\n  if (!redInstance) {\n    redInstance = new Red(config);\n    await redInstance.load('webapp-api');\n    console.log('âœ… Red AI initialized successfully');\n  }\n  return redInstance;\n}\n\n/**\n * Synchronous access to Red instance (must be initialized first)\n * Use getRed() for guaranteed initialization\n */\nexport function getRedSync(): Red {\n  if (!redInstance) {\n    throw new Error('Red instance not initialized. Call getRed() first.');\n  }\n  return redInstance;\n}\n\n// Initialize immediately for synchronous access in API routes\n// This allows `import { red }` to work\nlet initPromise: Promise<Red> | null = null;\n\nif (!initPromise) {\n  initPromise = getRed();\n}\n\n// Export as named export for convenience\nexport const red = await initPromise;\n\n/**\n * Bearer token for API authentication\n */\nexport const BEARER_TOKEN = process.env.BEARER_TOKEN || `red_ai_sk_${Date.now()}`;\n"],"names":[],"mappings":"AAAA;;CAEC;;;;;;;;;;AACD;;AAEA,MAAM,SAAoB;IACxB,UAAU,QAAQ,GAAG,CAAC,SAAS,IAAI;IACnC,aAAa,QAAQ,GAAG,CAAC,aAAa,IAAI;IAC1C,aAAa,QAAQ,GAAG,CAAC,YAAY,IAAI;IACzC,eAAe,QAAQ,GAAG,CAAC,OAAO,IAAI;AACxC;AAEA,IAAI,cAA0B;AAMvB,eAAe;IACpB,IAAI,CAAC,aAAa;QAChB,cAAc,IAAI,wJAAG,CAAC;QACtB,MAAM,YAAY,IAAI,CAAC;QACvB,QAAQ,GAAG,CAAC;IACd;IACA,OAAO;AACT;AAMO,SAAS;IACd,IAAI,CAAC,aAAa;QAChB,MAAM,IAAI,MAAM;IAClB;IACA,OAAO;AACT;AAEA,8DAA8D;AAC9D,uCAAuC;AACvC,IAAI,cAAmC;AAEvC,IAAI,CAAC,aAAa;IAChB,cAAc;AAChB;AAGO,MAAM,MAAM,MAAM;AAKlB,MAAM,eAAe,QAAQ,GAAG,CAAC,YAAY,IAAI,CAAC,UAAU,EAAE,KAAK,GAAG,IAAI","debugId":null}},
    {"offset": {"line": 209, "column": 0}, "map": {"version":3,"sources":["file:///home/alpha/code/%40redbtn/webapp/src/app/api/v1/messages/%5BmessageId%5D/reconnect/route.ts"],"sourcesContent":["import { NextRequest } from 'next/server';\nimport { getRed } from '@/lib/red';\n\nexport async function GET(\n  request: NextRequest,\n  { params }: { params: Promise<{ messageId: string }> }\n) {\n  // Await params in Next.js 15\n  const { messageId } = await params;\n  \n  console.log('[Reconnect] Reconnecting to stream for messageId:', messageId);\n  \n  try {\n    const red = await getRed();\n    const encoder = new TextEncoder();\n    \n    // Check if message exists in Redis\n    const existingState = await red.messageQueue.getMessageState(messageId);\n    \n    if (!existingState) {\n      console.log('[Reconnect] No state found for messageId:', messageId);\n      return new Response(\n        JSON.stringify({ error: 'Message not found' }),\n        { \n          status: 404,\n          headers: { 'Content-Type': 'application/json' }\n        }\n      );\n    }\n    \n    console.log('[Reconnect] Found existing state:', existingState.status, existingState.content?.length || 0, 'chars');\n    \n    // Create SSE stream\n    const stream = new ReadableStream({\n      async start(controller) {\n        let streamClosed = false;\n        \n        // Helper to safely enqueue\n        const safeEnqueue = (data: Uint8Array) => {\n          if (streamClosed) return false;\n          try {\n            controller.enqueue(data);\n            return true;\n          } catch (error) {\n            if (error instanceof Error && error.message.includes('Controller is already closed')) {\n              console.log('[Reconnect] Stream closed by client');\n              streamClosed = true;\n              return false;\n            }\n            throw error;\n          }\n        };\n        \n        try {\n          // Send init event with existing content\n          console.log('[Reconnect] Sending init with existing content');\n          if (!safeEnqueue(encoder.encode(`data: ${JSON.stringify({\n            type: 'init',\n            messageId,\n            conversationId: existingState.conversationId,\n            existingContent: existingState.content || ''\n          })}\\n\\n`))) {\n            return;\n          }\n          \n          // If already completed, send complete event and close\n          if (existingState.status === 'completed') {\n            console.log('[Reconnect] Generation already completed');\n            safeEnqueue(encoder.encode(`data: ${JSON.stringify({\n              type: 'complete',\n              metadata: existingState.metadata\n            })}\\n\\n`));\n            safeEnqueue(encoder.encode('data: [DONE]\\n\\n'));\n            if (!streamClosed) controller.close();\n            return;\n          }\n          \n          // If failed, send error and close\n          if (existingState.status === 'error') {\n            console.log('[Reconnect] Generation failed:', existingState.error);\n            safeEnqueue(encoder.encode(`data: ${JSON.stringify({\n              type: 'error',\n              error: existingState.error || 'Generation failed'\n            })}\\n\\n`));\n            safeEnqueue(encoder.encode('data: [DONE]\\n\\n'));\n            if (!streamClosed) controller.close();\n            return;\n          }\n          \n          // Still generating - subscribe to pub/sub for remaining events\n          console.log('[Reconnect] Subscribing to pub/sub for remaining events');\n          const messageStream = red.messageQueue.subscribeToMessage(messageId);\n          \n          for await (const event of messageStream) {\n            if (streamClosed) {\n              console.log('[Reconnect] Stream closed, stopping subscription');\n              break;\n            }\n            \n            console.log('[Reconnect] Received event:', event.type);\n            \n            if (event.type === 'chunk') {\n              if (!safeEnqueue(encoder.encode(`data: ${JSON.stringify({\n                type: 'content',\n                content: event.content\n              })}\\n\\n`))) break;\n            } else if (event.type === 'status') {\n              if (!safeEnqueue(encoder.encode(`data: ${JSON.stringify({\n                type: 'status',\n                action: event.action,\n                description: event.description\n              })}\\n\\n`))) break;\n            } else if (event.type === 'thinking_chunk') {\n              if (!safeEnqueue(encoder.encode(`data: ${JSON.stringify({\n                type: 'thinking_chunk',\n                content: event.content\n              })}\\n\\n`))) break;\n            } else if (event.type === 'thinking') {\n              if (!safeEnqueue(encoder.encode(`data: ${JSON.stringify({\n                type: 'thinking',\n                content: event.content\n              })}\\n\\n`))) break;\n            } else if (event.type === 'tool_status') {\n              if (!safeEnqueue(encoder.encode(`data: ${JSON.stringify({\n                type: 'tool_status',\n                status: event.status,\n                action: event.action\n              })}\\n\\n`))) break;\n            } else if (event.type === 'complete') {\n              safeEnqueue(encoder.encode(`data: ${JSON.stringify({\n                type: 'complete',\n                metadata: event.metadata\n              })}\\n\\n`));\n              break;\n            } else if (event.type === 'error') {\n              safeEnqueue(encoder.encode(`data: ${JSON.stringify({\n                type: 'error',\n                error: event.error\n              })}\\n\\n`));\n              break;\n            }\n          }\n          \n          safeEnqueue(encoder.encode('data: [DONE]\\n\\n'));\n          if (!streamClosed) controller.close();\n        } catch (error) {\n          console.error('[Reconnect] Stream error:', error);\n          if (!streamClosed) {\n            safeEnqueue(encoder.encode(`data: ${JSON.stringify({\n              type: 'error',\n              error: error instanceof Error ? error.message : String(error)\n            })}\\n\\n`));\n            controller.close();\n          }\n        }\n      }\n    });\n    \n    return new Response(stream, {\n      headers: {\n        'Content-Type': 'text/event-stream',\n        'Cache-Control': 'no-cache, no-transform',\n        'Connection': 'keep-alive',\n        'X-Accel-Buffering': 'no'\n      }\n    });\n  } catch (error) {\n    console.error('[Reconnect] Error:', error);\n    return new Response(\n      JSON.stringify({ \n        error: error instanceof Error ? error.message : String(error) \n      }),\n      { \n        status: 500,\n        headers: { 'Content-Type': 'application/json' }\n      }\n    );\n  }\n}\n"],"names":[],"mappings":"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","debugId":null}}]
}
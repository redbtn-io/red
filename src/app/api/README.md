# Red AI API Documentation

**Version:** 1.0  
**Base URL:** `/api`

Complete documentation for the Red AI REST API. This API provides AI chat completions, conversation management, authentication, and logging capabilities.

---

## üìã Table of Contents

1. [Authentication](#authentication)
2. [Chat & Completions](#chat--completions)
3. [Conversations](#conversations)
4. [Messages](#messages)
5. [Logging & Monitoring](#logging--monitoring)
6. [Rate Limiting](#rate-limiting)
7. [Error Handling](#error-handling)
8. [Streaming Protocol](#streaming-protocol)

---

## üîê Authentication

All API endpoints (except auth endpoints) require authentication via JWT token stored in an httpOnly cookie named `auth_token`.

### Request Sign In Link

**`POST /api/auth/request-code`**

Request a sign-in link to be sent via email. Uses session-based authentication with polling.

**Rate Limit:** 10 requests per 300 seconds (AUTH tier)

**Request Body:**
```json
{
  "email": "user@example.com",
  "sessionId": "session_1234567890_abc123"
}
```

**Success Response (200):**
```json
{
  "success": true,
  "message": "Sign in link sent to your email",
  "sessionId": "session_1234567890_abc123"
}
```

**Error Responses:**
- `400` - Missing or invalid email/sessionId
- `429` - Rate limit exceeded
- `500` - Failed to send sign in link

**Notes:**
- `sessionId` should be a unique identifier generated by the client (format: `session_{timestamp}_{random}`)
- Sign-in link expires in 10 minutes
- Old codes for the same email are automatically invalidated

---

### Check Session Status

**`POST /api/auth/check-session`**

Poll this endpoint to check if the user has clicked the sign-in link. Frontend should poll every 2 seconds.

**Request Body:**
```json
{
  "sessionId": "session_1234567890_abc123"
}
```

**Success Response (200) - Authenticated:**
```json
{
  "authenticated": true,
  "isNewUser": false,
  "profileComplete": true,
  "user": {
    "id": "507f1f77bcf86cd799439011",
    "email": "user@example.com",
    "name": "John Doe",
    "profileComplete": true,
    "accountLevel": "USER"
  }
}
```

**Response (200) - Not Yet Authenticated:**
```json
{
  "authenticated": false,
  "message": "Waiting for magic link verification"
}
```

**Response (200) - Expired:**
```json
{
  "authenticated": false,
  "expired": true,
  "message": "Session expired"
}
```

**Notes:**
- Sets `auth_token` httpOnly cookie on successful authentication
- Session is deleted after successful authentication
- Cookie expires in 7 days

---

### Get Current User

**`GET /api/auth/me`**

Get the currently authenticated user's information.

**Authentication:** Required

**Success Response (200):**
```json
{
  "user": {
    "id": "507f1f77bcf86cd799439011",
    "email": "user@example.com",
    "name": "John Doe",
    "dateOfBirth": "1990-01-01",
    "profileComplete": true,
    "accountLevel": "USER",
    "createdAt": "2025-10-01T12:00:00.000Z"
  }
}
```

**Error Responses:**
- `401` - Unauthorized (no valid token)
- `404` - User not found
- `500` - Server error

---

### Complete User Profile

**`POST /api/auth/complete-profile`**

Complete user profile after initial sign-in (required for new users).

**Authentication:** Required

**Request Body:**
```json
{
  "name": "John Doe",
  "dateOfBirth": "1990-01-01"
}
```

**Success Response (200):**
```json
{
  "success": true,
  "user": {
    "id": "507f1f77bcf86cd799439011",
    "email": "user@example.com",
    "name": "John Doe",
    "dateOfBirth": "1990-01-01",
    "profileComplete": true,
    "accountLevel": "USER"
  }
}
```

**Error Responses:**
- `400` - Missing required fields
- `401` - Unauthorized
- `500` - Server error

---

### Logout

**`POST /api/auth/logout`**

Logout the current user by clearing the auth token cookie.

**Authentication:** Required

**Success Response (200):**
```json
{
  "success": true,
  "message": "Logged out successfully"
}
```

---

## üí¨ Chat & Completions

### Create Chat Completion

**`POST /api/v1/chat/completions`**

Create a chat completion with optional streaming. This is the main endpoint for AI interactions.

**Rate Limit:** 30 requests per 60 seconds (CHAT tier)

**Request Body:**
```json
{
  "model": "Red",
  "messages": [
    {
      "role": "user",
      "content": "Hello, how are you?"
    }
  ],
  "stream": true,
  "conversationId": "conv_1234567890_abc123",
  "messageId": "msg_1234567890_xyz789"
}
```

**Fields:**
- `model` (string, optional): Model name, defaults to "Red"
- `messages` (array, required): Array of message objects with `role` and `content`
- `stream` (boolean, optional): Enable streaming mode, defaults to false
- `conversationId` (string, optional): Conversation ID for context, auto-generated if omitted
- `messageId` (string, optional): Message ID for tracking, auto-generated if omitted

---

#### Non-Streaming Response (stream: false)

**Success Response (200):**
```json
{
  "id": "chatcmpl_1234567890",
  "object": "chat.completion",
  "created": 1698765432,
  "model": "Red",
  "conversationId": "conv_1234567890_abc123",
  "choices": [
    {
      "index": 0,
      "message": {
        "role": "assistant",
        "content": "Hello! I'm doing well, thank you for asking. How can I help you today?"
      },
      "finish_reason": "stop"
    }
  ],
  "usage": {
    "prompt_tokens": 15,
    "completion_tokens": 20,
    "total_tokens": 35
  }
}
```

---

#### Streaming Response (stream: true)

**Response Headers:**
```
Content-Type: text/event-stream
Cache-Control: no-cache, no-transform
Connection: keep-alive
X-Accel-Buffering: no
```

**Stream Events:**

Each event is formatted as Server-Sent Events (SSE):
```
data: {JSON}\n\n
```

**1. Init Event** (first event):
```json
{
  "type": "init",
  "messageId": "msg_1234567890_xyz789",
  "conversationId": "conv_1234567890_abc123"
}
```

**2. Thinking Event** (optional, for AI reasoning):
```json
{
  "type": "thinking",
  "content": "Let me analyze this request..."
}
```

**3. Chunk Events** (text content):
```json
{
  "type": "chunk",
  "content": "Hello",
  "thinking": false
}
```

**4. Status Events** (AI is performing actions):
```json
{
  "type": "status",
  "action": "searching",
  "description": "Searching the web..."
}
```

**5. Tool Event** (tool execution details):
```json
{
  "type": "tool_event",
  "event": {
    "type": "tool_start",
    "toolId": "search_123",
    "toolType": "search",
    "toolName": "Web Search",
    "timestamp": 1698765432000,
    "metadata": {
      "query": "latest AI news"
    }
  }
}
```

Tool event types:
- `tool_start` - Tool execution begins
- `tool_progress` - Progress update during tool execution
- `tool_complete` - Tool execution completed
- `tool_error` - Tool execution failed

**6. Complete Event** (final event):
```json
{
  "type": "complete",
  "metadata": {
    "model": "Red",
    "tokens": {
      "input": 15,
      "output": 42,
      "total": 57
    }
  }
}
```

**7. Error Event:**
```json
{
  "type": "error",
  "error": "Generation failed: timeout"
}
```

**8. Done Event** (stream termination):
```
data: [DONE]\n\n
```

**Error Responses:**
- `400` - Invalid request (missing messages)
- `429` - Rate limit exceeded
- `500` - Internal server error

---

## üìù Conversations

### List Conversations

**`GET /api/v1/conversations`**

Get all conversations for the authenticated user.

**Authentication:** Required  
**Rate Limit:** 60 requests per 60 seconds (STANDARD tier)

**Query Parameters:**
- `limit` (number, optional): Number of conversations to return, default 50
- `offset` (number, optional): Pagination offset, default 0

**Success Response (200):**
```json
{
  "conversations": [
    {
      "id": "conv_1234567890_abc123",
      "title": "AI Research Discussion",
      "lastMessageAt": "2025-10-21T15:30:00.000Z",
      "messageCount": 15,
      "isArchived": false,
      "createdAt": "2025-10-21T10:00:00.000Z",
      "updatedAt": "2025-10-21T15:30:00.000Z"
    }
  ],
  "total": 1,
  "limit": 50,
  "offset": 0
}
```

**Error Responses:**
- `401` - Unauthorized
- `500` - Failed to fetch conversations

---

### Create Conversation

**`POST /api/v1/conversations`**

Create a new conversation. Returns a conversation ID that can be used for future messages.

**Authentication:** Required  
**Rate Limit:** 60 requests per 60 seconds (STANDARD tier)

**Request Body:**
```json
{
  "title": "New Chat Session"
}
```

**Success Response (200):**
```json
{
  "conversation": {
    "id": "conv_1698765432_xyz789",
    "title": "New Chat Session",
    "messages": [],
    "lastMessageAt": "2025-10-21T15:45:00.000Z",
    "messageCount": 0,
    "isArchived": false,
    "createdAt": "2025-10-21T15:45:00.000Z",
    "updatedAt": "2025-10-21T15:45:00.000Z"
  }
}
```

**Note:** The actual conversation is created in the database when the first message is sent.

---

### Get Conversation

**`GET /api/v1/conversations/[id]`**

Get a specific conversation with all messages and thoughts.

**Authentication:** Required  
**Rate Limit:** 60 requests per 60 seconds (STANDARD tier)

**Success Response (200):**
```json
{
  "conversation": {
    "id": "conv_1234567890_abc123",
    "title": "AI Research Discussion",
    "messages": [
      {
        "id": "msg_1234567890_aaa111",
        "role": "user",
        "content": "Tell me about AI",
        "timestamp": "2025-10-21T15:00:00.000Z",
        "metadata": {},
        "toolExecutions": []
      },
      {
        "id": "msg_1234567890_bbb222",
        "role": "assistant",
        "content": "AI, or Artificial Intelligence, is...",
        "timestamp": "2025-10-21T15:00:05.000Z",
        "metadata": {},
        "toolExecutions": [
          {
            "toolId": "search_123",
            "toolType": "search",
            "toolName": "Web Search",
            "status": "completed",
            "startTime": 1698765432000,
            "endTime": 1698765434000,
            "steps": [
              {
                "step": "Searching web...",
                "timestamp": 1698765432500
              }
            ],
            "result": "Found 5 relevant articles",
            "metadata": {
              "query": "artificial intelligence overview"
            }
          }
        ]
      }
    ],
    "thoughts": {
      "msg_1234567890_bbb222": "The user is asking for a broad overview. I should provide a comprehensive yet accessible explanation."
    },
    "lastMessageAt": "2025-10-21T15:00:05.000Z",
    "messageCount": 2,
    "isArchived": false,
    "createdAt": "2025-10-21T15:00:00.000Z",
    "updatedAt": "2025-10-21T15:00:05.000Z"
  }
}
```

**Response Fields:**
- `messages` - Array of all messages (thinking tags removed from content)
- `thoughts` - Map of `messageId` ‚Üí thinking content (from `<think>` tags)
- `toolExecutions` - Array of tools used in each message

**Error Responses:**
- `401` - Unauthorized
- `404` - Conversation not found
- `500` - Failed to fetch conversation

---

### Update Conversation

**`PATCH /api/v1/conversations/[id]`**

Update conversation properties (currently only title is supported).

**Authentication:** Required  
**Rate Limit:** 60 requests per 60 seconds (STANDARD tier)

**Request Body:**
```json
{
  "title": "Updated Title"
}
```

**Success Response (200):**
```json
{
  "conversation": {
    "id": "conv_1234567890_abc123",
    "title": "Updated Title",
    "messages": [...],
    "lastMessageAt": "2025-10-21T15:00:05.000Z",
    "messageCount": 2,
    "isArchived": false,
    "createdAt": "2025-10-21T15:00:00.000Z",
    "updatedAt": "2025-10-21T15:45:30.000Z"
  }
}
```

**Error Responses:**
- `401` - Unauthorized
- `404` - Conversation not found
- `500` - Failed to update conversation

---

### Delete Conversation

**`DELETE /api/v1/conversations/[id]`**

Permanently delete a conversation and all its messages.

**Authentication:** Required  
**Rate Limit:** 60 requests per 60 seconds (STANDARD tier)

**Success Response (200):**
```json
{
  "success": true,
  "message": "Conversation deleted"
}
```

**Error Responses:**
- `401` - Unauthorized
- `500` - Failed to delete conversation

---

## üì® Messages

### Reconnect to Message Stream

**`GET /api/v1/messages/[messageId]/reconnect`**

Reconnect to an ongoing message generation stream. Returns current accumulated content and continues streaming.

**Authentication:** Optional (uses same auth as original request)

**Success Response (200):**

Returns SSE stream with same format as `/api/v1/chat/completions` streaming response.

**First Event - Init with Existing Content:**
```json
{
  "type": "init",
  "messageId": "msg_1234567890_xyz789",
  "conversationId": "conv_1234567890_abc123",
  "existingContent": "Hello! I'm doing",
  "existingThinking": "The user greeted me..."
}
```

Then continues with new chunks as they're generated.

**Error Responses:**
- `400` - Missing messageId
- `404` - Message not found or generation not active
- `500` - Failed to reconnect

**Use Case:** Mobile apps can disconnect/reconnect during generation without losing content.

---

### Get Message Stream

**`GET /api/v1/messages/[messageId]/stream`**

Subscribe to a message stream (similar to reconnect but without requiring prior connection).

**Response:** Same SSE format as reconnect endpoint.

---

## üîç Logging & Monitoring

### Get Conversations with Logs

**`GET /api/v1/logs/conversations`**

Get list of conversations that have associated logs (for virtual terminal/debugging).

**Success Response (200):**
```json
{
  "success": true,
  "conversations": [
    {
      "conversationId": "conv_1234567890_abc123",
      "title": "AI Research",
      "logCount": 142,
      "lastLogAt": "2025-10-21T15:30:00.000Z",
      "generationCount": 5
    }
  ],
  "total": 1
}
```

---

### Get Logging Stats

**`GET /api/v1/logs/stats`**

Get logging system statistics.

**Query Parameters:**
- `conversationId` (string, optional): Get stats for specific conversation

**Success Response (200) - Without conversationId:**
```json
{
  "status": "operational",
  "message": "Logging system is running. Provide conversationId for detailed stats."
}
```

**Success Response (200) - With conversationId:**
```json
{
  "conversationId": "conv_1234567890_abc123",
  "totalLogs": 142,
  "generationCount": 5,
  "isGenerating": false,
  "byLevel": {
    "info": 100,
    "debug": 30,
    "warn": 10,
    "error": 2
  },
  "byCategory": {
    "llm": 45,
    "memory": 30,
    "router": 20,
    "tool": 25,
    "system": 22
  }
}
```

---

### Get Conversation Logs

**`GET /api/v1/conversations/[id]/logs`**

Get all logs for a specific conversation (for debugging/monitoring).

**Query Parameters:**
- `limit` (number, optional): Max logs to return, default 100
- `generationId` (string, optional): Filter by specific generation

**Success Response (200):**
```json
{
  "conversationId": "conv_1234567890_abc123",
  "logs": [
    {
      "timestamp": "2025-10-21T15:00:00.123Z",
      "level": "info",
      "category": "llm",
      "message": "Starting generation",
      "metadata": {
        "messageId": "msg_1234567890_xyz789",
        "model": "deepseek-chat"
      }
    },
    {
      "timestamp": "2025-10-21T15:00:01.456Z",
      "level": "debug",
      "category": "router",
      "message": "Route determined: CHAT",
      "metadata": {
        "intent": "chat",
        "confidence": 0.95
      }
    }
  ],
  "total": 2,
  "limit": 100
}
```

**Log Levels:**
- `debug` - Detailed debugging information
- `info` - General informational messages
- `warn` - Warning messages
- `error` - Error messages

**Log Categories:**
- `system` - System-level logs
- `llm` - Language model operations
- `memory` - Memory/database operations
- `router` - Routing decisions
- `tool` - Tool executions
- `stream` - Streaming operations

---

### Get Generation Info

**`GET /api/v1/generations/[generationId]`**

Get metadata about a specific generation.

**Success Response (200):**
```json
{
  "generationId": "gen_1234567890_abc123",
  "conversationId": "conv_1234567890_abc123",
  "messageId": "msg_1234567890_xyz789",
  "startTime": "2025-10-21T15:00:00.000Z",
  "endTime": "2025-10-21T15:00:05.000Z",
  "status": "completed",
  "tokenCount": 57,
  "model": "Red"
}
```

**Error Responses:**
- `400` - Missing generationId
- `404` - Generation not found
- `500` - Server error

---

### Get Generation Logs

**`GET /api/v1/generations/[generationId]/logs`**

Get all logs for a specific generation.

**Success Response (200):**
```json
{
  "generationId": "gen_1234567890_abc123",
  "logs": [
    {
      "timestamp": "2025-10-21T15:00:00.123Z",
      "level": "info",
      "category": "llm",
      "message": "Generation started"
    }
  ],
  "total": 1
}
```

---

## ‚ö° Rate Limiting

The API uses a token bucket algorithm for rate limiting with different tiers:

| Tier | Limit | Window | Applies To |
|------|-------|--------|------------|
| **AUTH** | 10 requests | 300s (5 min) | Authentication endpoints |
| **CHAT** | 30 requests | 60s (1 min) | Chat completions |
| **STANDARD** | 60 requests | 60s (1 min) | All other API endpoints |

**Rate Limit Headers:**

All responses include rate limit information:
```
X-RateLimit-Limit: 30
X-RateLimit-Remaining: 25
X-RateLimit-Reset: 1698765492
```

**Rate Limit Exceeded Response (429):**
```json
{
  "error": "Rate limit exceeded",
  "retryAfter": 15,
  "limit": 30,
  "window": 60
}
```

**Headers:**
```
Retry-After: 15
X-RateLimit-Limit: 30
X-RateLimit-Remaining: 0
X-RateLimit-Reset: 1698765492
```

---

## ‚ùå Error Handling

All error responses follow a consistent format:

**Error Response Structure:**
```json
{
  "error": "Error message",
  "message": "Detailed error description",
  "code": "ERROR_CODE"
}
```

**HTTP Status Codes:**

| Code | Meaning | Description |
|------|---------|-------------|
| `200` | OK | Request succeeded |
| `400` | Bad Request | Invalid request parameters |
| `401` | Unauthorized | Missing or invalid authentication |
| `404` | Not Found | Resource not found |
| `429` | Too Many Requests | Rate limit exceeded |
| `500` | Internal Server Error | Server-side error |

**Common Error Codes:**

- `invalid_request_error` - Malformed request
- `authentication_error` - Auth token invalid or missing
- `rate_limit_exceeded` - Too many requests
- `not_found` - Resource doesn't exist
- `internal_error` - Server-side failure

---

## üåä Streaming Protocol

The API uses Server-Sent Events (SSE) for streaming responses. This allows real-time updates and reconnection support.

### SSE Format

Each event is formatted as:
```
data: {JSON}\n\n
```

Multiple events are separated by blank lines.

### Event Types

**1. Metadata Events:**
- `init` - Stream initialization
- `complete` - Stream completion
- `error` - Error occurred

**2. Content Events:**
- `chunk` - Text content chunk
- `thinking` - AI reasoning/thinking content

**3. Status Events:**
- `status` - General status update
- `tool_status` - Tool execution status
- `tool_event` - Detailed tool events

### Stream Lifecycle

```
1. Client initiates request
   ‚Üì
2. Server sends "init" event
   ‚Üì
3. Server sends multiple "chunk" events
   ‚Üì
4. Server may send "thinking", "status", or "tool_event" events
   ‚Üì
5. Server sends "complete" event
   ‚Üì
6. Server sends "[DONE]" and closes stream
```

### Reconnection Flow

```
1. Client detects disconnect
   ‚Üì
2. Client calls /api/v1/messages/[messageId]/reconnect
   ‚Üì
3. Server sends "init" with existingContent
   ‚Üì
4. Server continues streaming new chunks
   ‚Üì
5. Stream completes normally
```

### Client Implementation Example

```typescript
const response = await fetch('/api/v1/chat/completions', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    model: 'Red',
    messages: [{ role: 'user', content: 'Hello!' }],
    stream: true
  })
});

const reader = response.body?.getReader();
const decoder = new TextDecoder();

while (true) {
  const { done, value } = await reader.read();
  if (done) break;
  
  const chunk = decoder.decode(value);
  const lines = chunk.split('\n');
  
  for (const line of lines) {
    if (line.startsWith('data: ')) {
      const data = line.slice(6);
      if (data === '[DONE]') break;
      
      const event = JSON.parse(data);
      
      if (event.type === 'chunk') {
        process.stdout.write(event.content);
      } else if (event.type === 'complete') {
        console.log('\nTokens used:', event.metadata.tokens.total);
      }
    }
  }
}
```

---

## üìö Additional Resources

### Related Documentation

- **AI Package README**: `/ai/README.md` - Core AI library documentation
- **Deployment Guide**: `/ai/DEPLOYMENT.md` - Deployment strategies
- **API Server Guide**: `/ai/examples/SERVER.md` - Standalone server documentation
- **Rate Limiting Guide**: `/webapp/explanations/RATE-LIMITING.md` - Rate limiting details
- **Database Schema**: `/ai/DATABASE-MODULE.md` - Database structure

### Support

For questions, issues, or feature requests:
- Open an issue on GitHub
- Contact: support@redbtn.io

---

## üîÑ Changelog

### Version 1.0 (Current)
- Initial API release
- Chat completions with streaming
- Conversation management
- Authentication system
- Logging and monitoring
- Rate limiting
- Stream reconnection

---

**Built with ‚ù§Ô∏è by the Red Button team**

Last Updated: October 21, 2025
